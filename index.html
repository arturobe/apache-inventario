<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventario - Pallets Apache</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
        .status-syncing { color: #ffc107; }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #1e7e34);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .warehouse-container {
            background: #f8f9fa;
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            position: relative;
            height: 600px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .warehouse-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .pallet {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 12px;
            cursor: move;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            user-select: none;
        }

        .pallet:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .pallet.active {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            z-index: 10;
        }

        .pallet.empty {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            border: 3px solid #a93226;
        }

        .pallet.partial {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            border: 3px solid #d68910;
        }

        .pallet.full {
            background: linear-gradient(45deg, #27ae60, #229954);
            border: 3px solid #1e8449;
        }

        .pallet-number {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .pallet-quantity {
            font-size: 12px;
            opacity: 0.9;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .inventory-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .inventory-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-item:last-child {
            margin-bottom: 0;
        }

        .item-info {
            flex-grow: 1;
        }

        .item-name {
            font-weight: 600;
            color: #333;
        }

        .item-details {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 6px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #007bff;
        }

        .summary-card h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }

        .movements-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .movements-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .movements-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f1f1;
        }

        .movements-table tr:hover {
            background: #f8f9fa;
        }

        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .tag.entrada { background: #d4edda; color: #155724; }
        .tag.salida { background: #f8d7da; color: #721c24; }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .warehouse-container {
                height: 400px;
            }
            
            .pallet {
                width: 60px;
                height: 60px;
                font-size: 12px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Control de Inventario Apache</h1>
            <p>Sistema de control de materiales de aislaci√≥n - Multi-usuario</p>
        </div>

        <!-- Barra de estado -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-indicator" id="connection-status">üî¥</span>
                <span id="connection-text">Conectando...</span>
            </div>
            <div class="status-item">
                üì¶ <span id="total-pallets">0</span> Pallets activos
            </div>
            <div class="status-item">
                üìã <span id="total-materials">0</span> Materiales en inventario
            </div>
            <div class="status-item">
                üïí √öltima sync: <span id="last-sync">--:--</span>
            </div>
        </div>

        <!-- Controles principales -->
        <div class="controls">
            <button class="btn btn-primary" onclick="inventorySystem.crearNuevoPallet()">
                ‚ûï Crear Nuevo Pallet
            </button>
            <button class="btn btn-success" onclick="inventorySystem.abrirModalRecepcion()">
                üì• Recibir Material
            </button>
            <button class="btn btn-primary" onclick="inventorySystem.generarReporte()">
                üìä Generar Reporte
            </button>
            <button class="btn btn-primary" onclick="inventorySystem.sincronizarManual()">
                üîÑ Sincronizar Ahora
            </button>
        </div>

        <!-- Almac√©n visual -->
        <div class="warehouse-container" id="warehouse">
            <div class="warehouse-grid"></div>
            <!-- Los pallets se generan din√°micamente aqu√≠ -->
        </div>

        <!-- Resumen estad√≠stico -->
        <div class="summary-cards">
            <div class="summary-card">
                <h4>Total Pallets</h4>
                <div class="value" id="summary-pallets">0</div>
            </div>
            <div class="summary-card">
                <h4>Materiales √önicos</h4>
                <div class="value" id="summary-materials">0</div>
            </div>
            <div class="summary-card">
                <h4>Pallets Vac√≠os</h4>
                <div class="value" id="summary-empty">0</div>
            </div>
            <div class="summary-card">
                <h4>Utilizaci√≥n</h4>
                <div class="value" id="summary-usage">0%</div>
            </div>
        </div>
    </div>

    <!-- Modal para recepci√≥n de material -->
    <div id="modal-recepcion" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì• Recepci√≥n de Material</h3>
                <button class="close-btn" onclick="inventorySystem.cerrarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-recepcion">
                    <div class="form-group">
                        <label for="pallet-select">Pallet de Destino:</label>
                        <select id="pallet-select" class="form-control" required>
                            <option value="">Seleccionar pallet...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="material-tipo">Tipo de Material:</label>
                        <select id="material-tipo" class="form-control" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="Lamina">L√°mina</option>
                            <option value="Strap">Strap</option>
                            <option value="Codo 90">Codo 90¬∞</option>
                            <option value="Codo 45">Codo 45¬∞</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="material-circunferencia">Circunferencia (pulgadas):</label>
                        <input type="text" id="material-circunferencia" class="form-control" 
                               placeholder="Ej: 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30" required>
                    </div>

                    <div class="form-group">
                        <label for="material-espesor">Espesor (pulgadas):</label>
                        <input type="text" id="material-espesor" class="form-control" 
                               placeholder="Ej: 1, 1.5, 2, 2.5, 3" required>
                    </div>

                    <div class="form-group">
                        <label for="material-cantidad">Cantidad:</label>
                        <input type="number" id="material-cantidad" class="form-control" min="1" required>
                    </div>

                    <div class="form-group">
                        <label for="material-unidad">Unidad:</label>
                        <select id="material-unidad" class="form-control" required>
                            <option value="">Seleccionar unidad...</option>
                            <option value="Pies lineales">Pies lineales</option>
                            <option value="Piezas">Piezas</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="material-proveedor">Proveedor:</label>
                        <input type="text" id="material-proveedor" class="form-control" 
                               placeholder="Nombre del proveedor" required>
                    </div>

                    <div class="form-group">
                        <label for="material-observaciones">Observaciones:</label>
                        <textarea id="material-observaciones" class="form-control" rows="3" 
                                placeholder="Informaci√≥n adicional (opcional)"></textarea>
                    </div>

                    <div style="text-align: center; margin-top: 25px;">
                        <button type="submit" class="btn btn-success">
                            ‚úÖ Confirmar Recepci√≥n
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para ver/gestionar pallet -->
    <div id="modal-pallet" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-pallet-title">üì¶ Gesti√≥n de Pallet</h3>
                <button class="close-btn" onclick="inventorySystem.cerrarModalPallet()">&times;</button>
            </div>
            <div id="modal-body" style="padding: 20px;"></div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // CONFIGURACI√ìN ENTERPRISE CON VALIDACI√ìN
        const CONFIG = {
            SUPABASE_URL: 'https://iuewoscogzfikwtzjjud.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1ZXdvc2NvZ3pmaWt3dHpqanVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNDQ4NTUsImV4cCI6MjA3MTkyMDg1NX0.WwNqp_zYz2EUqOcvpbsoT42bihKSMM6pmxWe3nJiy1Y',
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000,
            POLLING_INTERVAL: 10000, // 10 segundos
            MAX_PALLETS: 100,
            PALLET_SIZE: 20,
            GRID_SPACING: 5
        };

        // SISTEMA DE ESTADO ENTERPRISE CON SUPABASE Y POLLING
        class InventorySystem {
            constructor() {
                this.inventario = {};
                this.palletActual = null;
                this.usuarioActual = 'Usuario1';
                this.isOnline = false;
                this.lastSync = null;
                this.ultimaVerificacion = new Date().toISOString();
                this.supabase = null;
                this.pollingInterval = null;
            }

            // INICIALIZACI√ìN PRINCIPAL
            async init() {
                this.logInfo('Sistema inicializando...');
                this.setupEventListeners();
                await this.conectarSupabase();
                await this.cargarInventarioDesdeDB();
                this.renderPallets();
                this.actualizarEstadisticas();
                this.iniciarPolling();
                this.actualizarStatusBar();
                this.logInfo('Sistema inicializado completamente');
            }

            // CONEXI√ìN A SUPABASE
            async conectarSupabase() {
                try {
                    this.logInfo('Intentando conectar a Supabase...');
                    this.supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                    
                    // Verificar conectividad con simple query
                    const { data, error } = await this.supabase
                        .from('pallets')
                        .select('count(*)', { count: 'exact', head: true });
                    
                    if (error) {
                        throw error;
                    }
                    
                    this.isOnline = true;
                    this.lastSync = new Date();
                    this.logInfo(`Conectado a Supabase - ${data?.[0]?.count || 0} pallets en DB`);
                    
                } catch (error) {
                    this.logError('Error conectando a Supabase', error);
                    this.isOnline = false;
                }
            }

            // POLLING AUTOM√ÅTICO PARA SINCRONIZACI√ìN
            iniciarPolling() {
                // Limpiar polling previo si existe
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                }
                
                this.logInfo('Iniciando polling autom√°tico cada 10 segundos...');
                
                this.pollingInterval = setInterval(async () => {
                    try {
                        if (!this.supabase || !this.isOnline) return;
                        
                        const timestampActual = new Date().toISOString();
                        
                        // Verificar cambios en materiales desde √∫ltima verificaci√≥n
                        const { data: materialesRecientes, error } = await this.supabase
                            .from('materiales')
                            .select('*')
                            .gte('fecha_recepcion', this.ultimaVerificacion)
                            .eq('activo', true);
                        
                        if (!error && materialesRecientes && materialesRecientes.length > 0) {
                            this.logInfo(`Polling detect√≥ ${materialesRecientes.length} cambios`);
                            await this.cargarInventarioDesdeDB();
                            this.renderPallets();
                            this.actualizarEstadisticas();
                        }
                        
                        this.ultimaVerificacion = timestampActual;
                        this.lastSync = new Date();
                        this.actualizarStatusBar();
                        
                    } catch (error) {
                        this.logError('Error en polling autom√°tico', error);
                        this.isOnline = false;
                        this.actualizarStatusBar();
                    }
                }, CONFIG.POLLING_INTERVAL);
            }

            // SINCRONIZACI√ìN MANUAL
            async sincronizarManual() {
                this.logInfo('Sincronizaci√≥n manual iniciada...');
                this.actualizarStatusBar('syncing');
                
                try {
                    await this.cargarInventarioDesdeDB();
                    this.renderPallets();
                    this.actualizarEstadisticas();
                    this.lastSync = new Date();
                    this.logInfo('Sincronizaci√≥n manual completada');
                } catch (error) {
                    this.logError('Error en sincronizaci√≥n manual', error);
                }
                
                this.actualizarStatusBar();
            }

            // CARGAR INVENTARIO DESDE BASE DE DATOS
            async cargarInventarioDesdeDB() {
                if (!this.isOnline || !this.supabase) return;
                
                try {
                    // Cargar pallets
                    const { data: pallets, error: palletsError } = await this.supabase
                        .from('pallets')
                        .select('*')
                        .eq('activo', true)
                        .order('numero');
                    
                    if (palletsError) throw palletsError;
                    
                    // Cargar materiales activos
                    const { data: materiales, error: materialesError } = await this.supabase
                        .from('materiales')
                        .select('*')
                        .eq('activo', true)
                        .order('fecha_recepcion', { ascending: false });
                    
                    if (materialesError) throw materialesError;
                    
                    // Reconstruir inventario
                    this.inventario = {};
                    
                    // Inicializar pallets
                    pallets?.forEach(pallet => {
                        this.inventario[pallet.numero] = {
                            materiales: [],
                            posicion: { x: pallet.posicion_x, y: pallet.posicion_y }
                        };
                    });
                    
                    // Agregar materiales a pallets
                    materiales?.forEach(material => {
                        if (this.inventario[material.pallet_id]) {
                            this.inventario[material.pallet_id].materiales.push({
                                id: material.id,
                                tipo: material.tipo,
                                circunferencia: material.circunferencia,
                                espesor: material.espesor,
                                cantidad: material.cantidad,
                                unidad: material.unidad,
                                proveedor: material.proveedor,
                                descripcion: material.descripcion_completa,
                                fecha: material.fecha_recepcion
                            });
                        }
                    });
                    
                    this.logInfo(`Inventario cargado: ${pallets?.length || 0} pallets, ${materiales?.length || 0} materiales`);
                    
                } catch (error) {
                    this.logError('Error cargando inventario desde DB', error);
                }
            }

            // CREAR NUEVO PALLET
            async crearNuevoPallet() {
                if (!this.isOnline) {
                    alert('Error: No hay conexi√≥n con la base de datos. Verifica tu conexi√≥n.');
                    return;
                }
                
                try {
                    // Encontrar pr√≥ximo n√∫mero disponible
                    const numerosExistentes = Object.keys(this.inventario).map(Number);
                    const proximoNumero = Math.max(0, ...numerosExistentes) + 1;
                    
                    // Posici√≥n predeterminada
                    const nuevaPosicion = this.calcularNuevaPosicion();
                    
                    // Crear en Supabase
                    const { data, error } = await this.supabase
                        .from('pallets')
                        .insert({
                            numero: proximoNumero,
                            posicion_x: nuevaPosicion.x,
                            posicion_y: nuevaPosicion.y,
                            activo: true
                        })
                        .select();
                    
                    if (error) throw error;
                    
                    // Agregar al inventario local
                    this.inventario[proximoNumero] = {
                        materiales: [],
                        posicion: nuevaPosicion
                    };
                    
                    this.renderPallets();
                    this.actualizarEstadisticas();
                    this.logInfo(`Pallet ${proximoNumero} creado exitosamente`);
                    
                } catch (error) {
                    this.logError('Error creando pallet en DB', error);
                    alert('Error creando pallet. Revisa la consola para m√°s detalles.');
                }
            }

            // CALCULAR POSICI√ìN PARA NUEVO PALLET
            calcularNuevaPosicion() {
                const pallets = Object.keys(this.inventario);
                const row = Math.floor(pallets.length / 5);
                const col = pallets.length % 5;
                return {
                    x: 50 + col * 120,
                    y: 100 + row * 120
                };
            }

            // ABRIR MODAL DE RECEPCI√ìN
            async abrirModalRecepcion() {
                await this.cargarPalletsEnSelect();
                document.getElementById('modal-recepcion').classList.add('show');
            }

            // CARGAR PALLETS EN SELECT
            async cargarPalletsEnSelect() {
                const select = document.getElementById('pallet-select');
                select.innerHTML = '<option value="">Seleccionar pallet...</option>';
                
                Object.keys(this.inventario)
                    .sort((a, b) => Number(a) - Number(b))
                    .forEach(num => {
                        const cantidadMateriales = this.inventario[num].materiales.length;
                        const option = document.createElement('option');
                        option.value = num;
                        option.textContent = `Pallet ${num} (${cantidadMateriales} materiales)`;
                        select.appendChild(option);
                    });
            }

            // PROCESAR RECEPCI√ìN DE MATERIAL
            async recibirMaterialFormulario(event) {
                event.preventDefault();
                
                try {
                    // Recopilar datos del formulario
                    const formData = this.recopilarDatosFormulario();
                    if (!formData) return;
                    
                    // Crear descripci√≥n completa
                    const descripcionCompleta = this.generarDescripcionMaterial(formData);
                    
                    // Guardar en Supabase
                    const materialData = {
                        pallet_id: parseInt(formData.palletId),
                        tipo: formData.tipo,
                        circunferencia: formData.circunferencia,
                        espesor: formData.espesor,
                        cantidad: parseInt(formData.cantidad),
                        unidad: formData.unidad,
                        proveedor: formData.proveedor,
                        descripcion_completa: descripcionCompleta,
                        usuario_registro: this.usuarioActual,
                        activo: true
                    };
                    
                    const { data, error } = await this.supabase
                        .from('materiales')
                        .insert(materialData)
                        .select();
                    
                    if (error) throw error;
                    
                    // Agregar al inventario local
                    if (!this.inventario[formData.palletId]) {
                        this.inventario[formData.palletId] = { materiales: [], posicion: { x: 0, y: 0 } };
                    }
                    
                    this.inventario[formData.palletId].materiales.push({
                        id: data[0].id,
                        tipo: formData.tipo,
                        circunferencia: formData.circunferencia,
                        espesor: formData.espesor,
                        cantidad: parseInt(formData.cantidad),
                        unidad: formData.unidad,
                        proveedor: formData.proveedor,
                        descripcion: descripcionCompleta,
                        fecha: new Date().toISOString()
                    });
                    
                    // Registrar movimiento
                    await this.registrarMovimiento('entrada', data[0].id, parseInt(formData.cantidad), formData.proveedor);
                    
                    // Actualizar UI
                    this.renderPallets();
                    this.actualizarEstadisticas();
                    this.cerrarModal();
                    this.limpiarFormularioRecepcion();
                    
                    this.logInfo(`Material guardado en DB: P${formData.palletId} - ${formData.cantidad} ${formData.unidad} de ${descripcionCompleta}`);
                    alert(`‚úÖ Material recibido exitosamente en Pallet ${formData.palletId}`);
                    
                } catch (error) {
                    this.logError('Error procesando recepci√≥n de material', error);
                    alert('‚ùå Error al procesar la recepci√≥n. Revisa la consola para m√°s detalles.');
                }
            }

            // RECOPILAR DATOS DEL FORMULARIO
            recopilarDatosFormulario() {
                const palletId = document.getElementById('pallet-select').value;
                const tipo = document.getElementById('material-tipo').value;
                const circunferencia = document.getElementById('material-circunferencia').value;
                const espesor = document.getElementById('material-espesor').value;
                const cantidad = document.getElementById('material-cantidad').value;
                const unidad = document.getElementById('material-unidad').value;
                const proveedor = document.getElementById('material-proveedor').value;
                
                // Validaci√≥n
                if (!palletId || !tipo || !circunferencia || !espesor || !cantidad || !unidad || !proveedor) {
                    alert('‚ö†Ô∏è Por favor, completa todos los campos obligatorios');
                    return null;
                }
                
                return { palletId, tipo, circunferencia, espesor, cantidad, unidad, proveedor };
            }

            // GENERAR DESCRIPCI√ìN DE MATERIAL
            generarDescripcionMaterial(formData) {
                const { tipo, circunferencia, espesor, cantidad, unidad } = formData;
                
                let descripcion = `${cantidad} ${unidad} de ${tipo}`;
                
                if (tipo === 'Lamina') {
                    descripcion += ` - ${circunferencia}" x ${espesor}"`;
                } else if (tipo === 'Strap') {
                    descripcion += ` - ${circunferencia}" x ${espesor}"`;
                } else if (tipo.includes('Codo')) {
                    descripcion += ` - ${circunferencia}" x ${espesor}"`;
                }
                
                return descripcion;
            }

            // REGISTRAR MOVIMIENTO EN HISTORIAL
            async registrarMovimiento(tipo, materialId, cantidad, destino = '') {
                if (!this.isOnline) return;
                
                try {
                    const { error } = await this.supabase
                        .from('movimientos')
                        .insert({
                            material_id: materialId,
                            tipo_movimiento: tipo,
                            cantidad: cantidad,
                            destino: destino,
                            usuario: this.usuarioActual
                        });
                    
                    if (error) throw error;
                    
                } catch (error) {
                    this.logError('Error registrando movimiento', error);
                }
            }

            // LIMPIAR FORMULARIO
            limpiarFormularioRecepcion() {
                document.getElementById('form-recepcion').reset();
            }

            // CERRAR MODALES
            cerrarModal() {
                document.getElementById('modal-recepcion').classList.remove('show');
            }

            cerrarModalPallet() {
                document.getElementById('modal-pallet').classList.remove('show');
            }

            // RENDERIZAR PALLETS EN EL ALMAC√âN
            renderPallets() {
                const warehouse = document.getElementById('warehouse');
                // Eliminar pallets existentes
                warehouse.querySelectorAll('.pallet').forEach(p => p.remove());
                
                Object.entries(this.inventario).forEach(([numero, data]) => {
                    const pallet = this.crearElementoPallet(numero, data);
                    warehouse.appendChild(pallet);
                });
            }

            // CREAR ELEMENTO PALLET
            crearElementoPallet(numero, data) {
                const div = document.createElement('div');
                div.className = 'pallet';
                div.id = `pallet-${numero}`;
                div.draggable = true;
                
                const cantidadMateriales = data.materiales.length;
                const totalCantidad = data.materiales.reduce((sum, m) => sum + (m.cantidad || 0), 0);
                
                // Determinar clase seg√∫n contenido
                let statusClass = 'empty';
                if (cantidadMateriales > 0) {
                    statusClass = totalCantidad >= 50 ? 'full' : 'partial';
                }
                div.classList.add(statusClass);
                
                // Posicionar
                div.style.left = data.posicion.x + 'px';
                div.style.top = data.posicion.y + 'px';
                
                // Contenido
                div.innerHTML = `
                    <div class="pallet-number">P${numero}</div>
                    <div class="pallet-quantity">${cantidadMateriales} items</div>
                `;
                
                // Event listeners
                div.addEventListener('click', () => this.abrirModalPallet(numero));
                div.addEventListener('dragstart', (e) => this.iniciarArrastre(e, numero));
                div.addEventListener('dragend', (e) => this.finalizarArrastre(e, numero));
                
                return div;
            }

            // ABRIR MODAL DE PALLET
            async abrirModalPallet(numero) {
                this.palletActual = numero;
                const data = this.inventario[numero];
                
                document.getElementById('modal-pallet-title').textContent = `üì¶ Pallet ${numero} - ${data.materiales.length} materiales`;
                
                const modalBody = document.getElementById('modal-body');
                modalBody.innerHTML = this.generarContenidoModalPallet(numero, data);
                
                document.getElementById('modal-pallet').classList.add('show');
            }

            // GENERAR CONTENIDO DEL MODAL PALLET
            generarContenidoModalPallet(numero, data) {
                const materiales = data.materiales || [];
                
                let html = `
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="inventorySystem.abrirModalRecepcionPallet(${numero})">
                            ‚ûï Agregar Material
                        </button>
                    </div>
                `;
                
                if (materiales.length === 0) {
                    html += '<p style="text-align: center; color: #666; margin: 40px 0;">Este pallet est√° vac√≠o</p>';
                } else {
                    html += '<div class="inventory-list">';
                    materiales.forEach((material, index) => {
                        html += `
                            <div class="inventory-item">
                                <div class="item-info">
                                    <div class="item-name">${material.descripcion}</div>
                                    <div class="item-details">
                                        Proveedor: ${material.proveedor} | 
                                        Cantidad: ${material.cantidad} ${material.unidad} |
                                        Fecha: ${new Date(material.fecha).toLocaleDateString()}
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn btn-danger btn-small" 
                                            onclick="inventorySystem.despacharMaterial(${material.id}, ${numero})">
                                        üì§ Despachar
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                return html;
            }

            // ABRIR MODAL DE RECEPCI√ìN ESPEC√çFICO PARA UN PALLET
            async abrirModalRecepcionPallet(numero) {
                this.cerrarModalPallet();
                await this.abrirModalRecepcion();
                document.getElementById('pallet-select').value = numero;
            }

            // DESPACHAR MATERIAL
            async despacharMaterial(materialId, palletNumero) {
                const destino = prompt('¬øCu√°l es el destino del material?');
                if (!destino) return;
                
                try {
                    // Marcar como inactivo en Supabase
                    const { error } = await this.supabase
                        .from('materiales')
                        .update({ activo: false })
                        .eq('id', materialId);
                    
                    if (error) throw error;
                    
                    // Registrar movimiento
                    await this.registrarMovimiento('salida', materialId, 0, destino);
                    
                    // Actualizar inventario local
                    this.inventario[palletNumero].materiales = this.inventario[palletNumero].materiales
                        .filter(m => m.id !== materialId);
                    
                    // Actualizar UI
                    this.renderPallets();
                    this.actualizarEstadisticas();
                    this.abrirModalPallet(palletNumero); // Refrescar modal
                    
                    this.logInfo(`Material ${materialId} despachado a ${destino}`);
                    
                } catch (error) {
                    this.logError('Error despachando material', error);
                    alert('Error al despachar material');
                }
            }

            // FUNCIONES DE ARRASTRE
            iniciarArrastre(e, numero) {
                this.draggedPallet = numero;
                const rect = e.target.getBoundingClientRect();
                const containerRect = e.target.parentElement.getBoundingClientRect();
                this.dragOffset = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }

            async finalizarArrastre(e, numero) {
                if (!this.draggedPallet || !this.isOnline) return;
                
                const container = document.getElementById('warehouse');
                const containerRect = container.getBoundingClientRect();
                
                const newX = e.clientX - containerRect.left - this.dragOffset.x;
                const newY = e.clientY - containerRect.top - this.dragOffset.y;
                
                // Actualizar posici√≥n en Supabase
                try {
                    const { error } = await this.supabase
                        .from('pallets')
                        .update({
                            posicion_x: newX,
                            posicion_y: newY
                        })
                        .eq('numero', parseInt(numero));
                    
                    if (error) throw error;
                    
                    // Actualizar inventario local
                    this.inventario[numero].posicion = { x: newX, y: newY };
                    this.logInfo(`Pallet ${numero} movido a nueva posici√≥n`);
                    
                } catch (error) {
                    this.logError('Error actualizando posici√≥n', error);
                }
                
                this.draggedPallet = null;
            }

            // CONFIGURAR EVENT LISTENERS
            setupEventListeners() {
                // Formulario de recepci√≥n
                document.getElementById('form-recepcion').addEventListener('submit', (e) => {
                    this.recibirMaterialFormulario(e);
                });
                
                // Cerrar modales al hacer click fuera
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        this.cerrarModal();
                        this.cerrarModalPallet();
                    }
                });
                
                // Drag & Drop para pallets
                document.getElementById('warehouse').addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                document.getElementById('warehouse').addEventListener('drop', (e) => {
                    e.preventDefault();
                });
            }

            // ACTUALIZAR ESTAD√çSTICAS
            actualizarEstadisticas() {
                const totalPallets = Object.keys(this.inventario).length;
                const totalMateriales = Object.values(this.inventario)
                    .reduce((sum, pallet) => sum + pallet.materiales.length, 0);
                const palletsVacios = Object.values(this.inventario)
                    .filter(pallet => pallet.materiales.length === 0).length;
                const utilizacion = totalPallets > 0 ? Math.round(((totalPallets - palletsVacios) / totalPallets) * 100) : 0;
                
                document.getElementById('total-pallets').textContent = totalPallets;
                document.getElementById('total-materials').textContent = totalMateriales;
                document.getElementById('summary-pallets').textContent = totalPallets;
                document.getElementById('summary-materials').textContent = totalMateriales;
                document.getElementById('summary-empty').textContent = palletsVacios;
                document.getElementById('summary-usage').textContent = utilizacion + '%';
            }

            // ACTUALIZAR BARRA DE ESTADO
            actualizarStatusBar(estado = null) {
                const statusIndicator = document.getElementById('connection-status');
                const statusText = document.getElementById('connection-text');
                const lastSyncElement = document.getElementById('last-sync');
                
                let status = estado || (this.isOnline ? 'online' : 'offline');
                
                switch (status) {
                    case 'online':
                        statusIndicator.textContent = 'üü¢';
                        statusText.textContent = 'Conectado';
                        break;
                    case 'offline':
                        statusIndicator.textContent = 'üî¥';
                        statusText.textContent = 'Sin conexi√≥n';
                        break;
                    case 'syncing':
                        statusIndicator.textContent = 'üü°';
                        statusText.textContent = 'Sincronizando...';
                        break;
                }
                
                if (this.lastSync) {
                    lastSyncElement.textContent = this.lastSync.toLocaleTimeString();
                }
            }

            // GENERAR REPORTE
            async generarReporte() {
                try {
                    // Obtener movimientos recientes
                    const { data: movimientos, error } = await this.supabase
                        .from('movimientos')
                        .select(`
                            *,
                            materiales (
                                descripcion_completa,
                                tipo,
                                proveedor
                            )
                        `)
                        .order('fecha', { ascending: false })
                        .limit(50);
                    
                    if (error) throw error;
                    
                    this.mostrarReporte(movimientos);
                    
                } catch (error) {
                    this.logError('Error generando reporte', error);
                    alert('Error generando reporte');
                }
            }

            // MOSTRAR REPORTE
            mostrarReporte(movimientos) {
                const modalBody = document.getElementById('modal-body');
                
                let html = `
                    <h4>üìä Reporte de Movimientos Recientes</h4>
                    <div style="margin: 20px 0;">
                        <strong>Total inventario actual:</strong> ${Object.values(this.inventario).reduce((sum, p) => sum + p.materiales.length, 0)} materiales
                    </div>
                `;
                
                if (movimientos && movimientos.length > 0) {
                    html += `
                        <table class="movements-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Material</th>
                                    <th>Cantidad</th>
                                    <th>Usuario</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    movimientos.forEach(mov => {
                        const fecha = new Date(mov.fecha).toLocaleDateString();
                        const material = mov.materiales?.descripcion_completa || 'Material eliminado';
                        html += `
                            <tr>
                                <td>${fecha}</td>
                                <td><span class="tag ${mov.tipo_movimiento}">${mov.tipo_movimiento}</span></td>
                                <td>${material}</td>
                                <td>${mov.cantidad}</td>
                                <td>${mov.usuario}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; color: #666;">No hay movimientos registrados</p>';
                }
                
                modalBody.innerHTML = html;
                document.getElementById('modal-pallet-title').textContent = 'üìä Reporte del Sistema';
                document.getElementById('modal-pallet').classList.add('show');
            }

            // SISTEMA DE LOGGING
            logInfo(mensaje) {
                console.log(`[${new Date().toISOString()}] INFO: ${mensaje}`);
            }

            logError(mensaje, error) {
                console.error(`[${new Date().toISOString()}] ERROR: ${mensaje}`, error);
            }
        }

        // INICIALIZACI√ìN GLOBAL
        let inventorySystem;

        document.addEventListener('DOMContentLoaded', async () => {
            inventorySystem = new InventorySystem();
            await inventorySystem.init();
        });

        // Prevenir cierre accidental
        window.addEventListener('beforeunload', (e) => {
            if (Object.values(inventorySystem?.inventario || {}).some(p => p.materiales.length > 0)) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
