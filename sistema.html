<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apache Inventory Pro - Control de Almacén</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        :root {
            --primary: #3b82f6;        /* Azul claro profesional */
            --primary-light: #60a5fa;
            --primary-dark: #2563eb;
            --secondary: #6b7280;      /* Gris medio */
            --tertiary: #e5e7eb;      /* Gris muy claro */
            --accent: #10b981;         /* Verde suave */
            --neutral: #f9fafb;        /* Blanco hueso */
            --dark: #374151;           /* Gris oscuro */
            --dark-light: #4b5563;
            --gray: #9ca3af;
            --gray-light: #f3f4f6;
            --gray-medium: #d1d5db;
            --white: #ffffff;
            --border-light: #e5e7eb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        body { 
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: var(--neutral);
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: var(--white);
            border-bottom: 1px solid var(--border-light);
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .header h1 { 
            font-size: 22px; 
            font-weight: 700;
            color: var(--dark);
            letter-spacing: -0.5px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .user-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: var(--dark);
        }

        .user-selector select {
            padding: 10px 16px;
            border-radius: 8px;
            background: var(--white);
            color: var(--dark);
            border: 2px solid var(--border-light);
            font-size: 14px;
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        .connection-status {
            padding: 8px 20px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: var(--shadow);
        }

        .connected { 
            background: var(--accent); 
            color: var(--white); 
        }
        .connecting { 
            background: var(--primary); 
            color: var(--white); 
        }
        .disconnected { 
            background: var(--gray-light); 
            color: var(--dark); 
            border: 2px solid var(--gray-medium); 
        }

        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: calc(100vh - 70px);
            gap: 0;
        }

        .sidebar {
            background: var(--white);
            border-right: 1px solid var(--border-light);
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
            box-shadow: var(--shadow);
        }

        .section-card {
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-lg);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gray-light);
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-field label {
            color: var(--white);
            font-size: 12px;
            font-weight: 500;
        }

        .form-field input, 
        .form-field select {
            padding: 10px 12px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: var(--white);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-field input:focus, 
        .form-field select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255,255,255,0.15);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary { 
            background: var(--primary); 
            color: var(--white);
        }
        .btn-primary:hover { 
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary { 
            background: var(--secondary); 
            color: var(--white);
        }
        .btn-secondary:hover { 
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-danger { 
            background: var(--danger); 
            color: var(--white);
        }
        .btn-danger:hover { 
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .create-pallet-btn {
            background: var(--primary);
            color: var(--white);
            padding: 18px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .create-pallet-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: var(--gray-light);
            border: 1px solid var(--border-light);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-number {
            font-size: 26px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray);
            margin-top: 6px;
            font-weight: 500;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--neutral);
        }

        .search-results {
            background: var(--white);
            border: 2px solid var(--gray-medium);
            margin: 16px;
            padding: 16px;
            border-radius: 12px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .warehouse {
            flex: 1;
            background: var(--white);
            border: 3px solid var(--primary);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            margin: 16px;
            cursor: crosshair;
            box-shadow: var(--shadow-lg);
        }

        .pallet {
            width: 50px;
            height: 50px;
            position: absolute;
            cursor: grab;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 10px;
            color: var(--white);
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
            border: 3px solid rgba(255,255,255,0.2);
            user-select: none;
            text-align: center;
            line-height: 1.1;
        }

        .pallet-number {
            font-size: 8px;
            opacity: 0.8;
            margin-top: 1px;
        }

        .pallet-name {
            font-size: 9px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 45px;
        }

        .pallet:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
            z-index: 10;
        }

        .pallet.occupied { 
            background: var(--secondary);
            border-color: var(--primary);
            color: var(--white);
        }

        .pallet.temporal {
            background: var(--tertiary);
            border-color: var(--primary);
            color: var(--dark);
            animation: pulse 2s infinite;
            cursor: pointer;
        }

        .pallet.dragging {
            cursor: grabbing;
            transform: scale(1.15) rotate(5deg);
            box-shadow: var(--shadow-xl);
            z-index: 100;
            border-color: var(--secondary);
            background: var(--gray-medium);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active { 
            display: flex; 
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--white);
            color: var(--dark);
            border-radius: 20px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--white);
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: var(--danger);
            border: none;
            color: var(--white);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 28px;
            background: var(--gray-light);
            border-radius: 12px 12px 0 0;
            padding: 4px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: var(--gray);
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            flex: 1;
            text-align: center;
        }

        .tab.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: var(--shadow);
        }

        .tab:hover:not(.active) {
            color: var(--dark);
            background: rgba(255, 255, 255, 0.6);
        }

        .form-section {
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .form-section h4 {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gray-light);
        }

        .form-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-grid.two-col { grid-template-columns: 1fr 1fr; }
        .form-grid.three-col { grid-template-columns: 1fr 1fr 1fr; }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: var(--dark);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select {
            padding: 12px 16px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 14px;
            color: var(--dark);
            background: var(--white);
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .material-card {
            background: var(--gray-light);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--secondary);
            transition: all 0.2s ease;
        }

        .material-card:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow);
        }

        .material-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .material-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 15px;
        }

        .material-badge {
            background: var(--primary);
            color: var(--white);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .material-details {
            color: var(--gray);
            font-size: 13px;
            line-height: 1.4;
        }

        .despacho-controls {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .despacho-input {
            width: 100px;
            padding: 8px 12px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 140px;
            padding: 14px 20px;
            font-size: 15px;
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 280px 1fr;
            }
            
            .form-grid.three-col {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 250px 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 3px solid var(--primary);
                max-height: 250px;
            }
            
            .form-grid.two-col,
            .form-grid.three-col {
                grid-template-columns: 1fr;
            }
            
            .pallet {
                width: 45px;
                height: 45px;
                font-size: 12px;
            }
            
            .modal-content {
                max-width: 95vw;
                margin: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                min-width: auto;
            }
        }

        .activity-item {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            font-size: 12px;
            color: var(--white);
        }

        .search-result-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-info {
            color: var(--white);
            font-size: 13px;
        }

        .result-btn {
            padding: 6px 12px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
        }

        .scrollable-content {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: var(--gray-light);
            border-radius: 4px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        .despacho-input {
            width: 100px;
            padding: 10px 12px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .despacho-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .despacho-controls {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Apache Inventory Pro</h1>
        
        <div class="header-controls">
            <div class="user-selector">
                <label>Usuario:</label>
                <select id="usuario-selector" onchange="cambiarUsuario()">
                    <option value="Usuario1">Usuario 1</option>
                    <option value="Usuario2">Usuario 2</option>
                    <option value="Usuario3">Usuario 3</option>
                </select>
            </div>
            
            <div id="connection-status" class="connection-status connected">
                Conectado
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="section-card">
                <div class="section-title">Búsqueda de Material</div>
                
                <div class="search-grid">
                    <div class="form-field">
                        <label>Tipo de Material</label>
                        <select id="search-tipo">
                            <option value="">Todos los tipos</option>
                            <option value="Lamina">Lámina de Acero</option>
                            <option value="Strap">Strap/Fleje</option>
                            <option value="Codo 90">Codo 90°</option>
                            <option value="Codo 45">Codo 45°</option>
                            <option value="Tuberia">Tubería</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <label>Circunferencia (")</label>
                        <input type="text" id="search-circunf" placeholder="ej: 12.0">
                    </div>
                    
                    <div class="form-field">
                        <label>Espesor (")</label>
                        <input type="text" id="search-espesor" placeholder="ej: 1.5">
                    </div>
                    
                    <div class="form-field">
                        <label>Proveedor</label>
                        <input type="text" id="search-proveedor" placeholder="Nombre empresa">
                    </div>
                </div>
                
                <div class="btn-action-grid">
                    <button class="btn btn-primary" onclick="buscarMateriales()">Buscar</button>
                    <button class="btn btn-secondary" onclick="limpiarBusqueda()">Limpiar</button>
                </div>
            </div>

            <div class="section-card">
                <div class="section-title">Gestión de Pallets</div>
                
                <button class="btn create-pallet-btn" id="btn-crear-pallet">
                    Crear Nuevo Pallet
                </button>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="contador-pallets">0</div>
                        <div class="stat-label">Total Pallets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="contador-ocupados">0</div>
                        <div class="stat-label">Con Material</div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-title">Actividad Reciente</div>
                <div class="scrollable-content" style="max-height: 150px;" id="actividad-reciente">
                    <div class="activity-item">Sistema inicializado correctamente</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="resultados-busqueda" class="search-results">
                <h3 style="color: black; margin-bottom: 12px;">Resultados de Búsqueda</h3>
                <div id="contenido-resultados"></div>
            </div>

            <div class="warehouse" id="warehouse">
                <!-- Los pallets se generan dinámicamente aquí -->
            </div>
        </div>
    </div>

    <!-- Modal Profesional -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Gestión de Pallet</h3>
                <button class="modal-close" onclick="cerrarModal()">× Cerrar</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        console.log('=== APACHE INVENTORY PRO INICIANDO ===');
        
        const CONFIG = {
            SUPABASE_URL: 'https://iuewoscogzfikwtzjjud.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1ZXdvc2NvZ3pmaWt3dHpqanVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNDQ4NTUsImV4cCI6MjA3MTkyMDg1NX0.WwNqp_zYz2EUqOcvpbsoT42bihKSMM6pmxWe3nJiy1Y',
            POLLING_INTERVAL: 8000,
            PALLET_SIZE: 50
        };

        class InventorySystemPro {
            constructor() {
                this.inventario = {};
                this.palletActual = null;
                this.usuarioActual = 'Usuario1';
                this.isOnline = false;
                this.pollingInterval = null;
                this.ultimaVerificacion = new Date().toISOString();
                this.ultimoPalletId = 0;
                this.supabase = null;
                this.nombresPersonalizados = {}; // Para almacenar nombres custom
                
                // Sistema de arrastre simplificado
                this.drag = {
                    active: false,
                    palletId: null,
                    startX: 0,
                    startY: 0,
                    offsetX: 0,
                    offsetY: 0
                };
                
                this.logInfo('Apache Inventory Pro iniciado');
            }

            logInfo(mensaje) {
                console.log(`[INFO] ${mensaje}`);
                this.agregarActividad(`INFO: ${mensaje}`);
            }

            logError(mensaje, error) {
                console.error(`[ERROR] ${mensaje}`, error);
                this.agregarActividad(`ERROR: ${mensaje}`);
            }

            agregarActividad(mensaje) {
                const container = document.getElementById('actividad-reciente');
                if (container) {
                    const item = document.createElement('div');
                    item.className = 'activity-item';
                    item.innerHTML = `<small>${new Date().toLocaleTimeString()}</small><br>${mensaje}`;
                    container.insertBefore(item, container.firstChild);
                    
                    // Limitar a 10 items
                    while (container.children.length > 10) {
                        container.removeChild(container.lastChild);
                    }
                }
            }

            async init() {
                try {
                    this.logInfo('Inicializando sistema...');
                    await this.conectarSupabase();
                    await this.cargarInventario();
                    this.setupEventListeners();
                    this.setupDragSystem();
                    this.iniciarSincronizacion();
                    this.actualizarContadores();
                    this.logInfo('Sistema completamente operativo');
                } catch (error) {
                    this.logError('Error en inicialización', error);
                }
            }

            async conectarSupabase() {
                try {
                    this.supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                    
                    const { data, error } = await this.supabase
                        .from('pallets')
                        .select('numero')
                        .limit(1);

                    if (error) throw error;
                    
                    this.isOnline = true;
                    this.actualizarEstadoConexion('connected');
                    this.logInfo('Conexión a Supabase establecida');
                } catch (error) {
                    this.logError('Error conectando a Supabase', error);
                    this.isOnline = false;
                    this.actualizarEstadoConexion('disconnected');
                }
            }

            setupEventListeners() {
                const btnCrear = document.getElementById('btn-crear-pallet');
                if (btnCrear) {
                    btnCrear.addEventListener('click', () => this.crearNuevoPallet());
                }
            }

            setupDragSystem() {
                // Mouse events
                document.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                document.addEventListener('mouseup', () => this.handleMouseUp());
                
                // Touch events
                document.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false });
                document.addEventListener('touchend', () => this.handleTouchEnd());
                
                this.logInfo('Sistema de arrastre configurado');
            }

            startDrag(palletId, clientX, clientY) {
                const pallet = document.querySelector(`[data-pallet="${palletId}"]`);
                if (!pallet) return;
                
                const warehouse = document.getElementById('warehouse');
                const warehouseRect = warehouse.getBoundingClientRect();
                const palletRect = pallet.getBoundingClientRect();
                
                this.drag = {
                    active: true,
                    palletId: palletId,
                    startX: clientX,
                    startY: clientY,
                    offsetX: palletRect.left - warehouseRect.left,
                    offsetY: palletRect.top - warehouseRect.top
                };
                
                pallet.classList.add('dragging');
                document.body.style.cursor = 'grabbing';
                
                this.logInfo(`Iniciando arrastre P${palletId}`);
            }

            updateDrag(clientX, clientY) {
                if (!this.drag.active) return;
                
                const pallet = document.querySelector(`[data-pallet="${this.drag.palletId}"]`);
                const warehouse = document.getElementById('warehouse');
                
                if (!pallet || !warehouse) return;
                
                const warehouseRect = warehouse.getBoundingClientRect();
                const deltaX = clientX - this.drag.startX;
                const deltaY = clientY - this.drag.startY;
                
                const newX = Math.max(0, Math.min(this.drag.offsetX + deltaX, warehouseRect.width - CONFIG.PALLET_SIZE));
                const newY = Math.max(0, Math.min(this.drag.offsetY + deltaY, warehouseRect.height - CONFIG.PALLET_SIZE));
                
                pallet.style.left = newX + 'px';
                pallet.style.top = newY + 'px';
            }

            async endDrag() {
                if (!this.drag.active) return;
                
                const pallet = document.querySelector(`[data-pallet="${this.drag.palletId}"]`);
                if (pallet) {
                    pallet.classList.remove('dragging');
                    
                    const newX = parseInt(pallet.style.left);
                    const newY = parseInt(pallet.style.top);
                    
                    // Actualizar posición en base de datos
                    await this.actualizarPosicionPallet(this.drag.palletId, newX, newY);
                    
                    // Actualizar inventario local
                    if (this.inventario[this.drag.palletId]) {
                        this.inventario[this.drag.palletId].posicion = { x: newX, y: newY };
                    }
                    
                    this.logInfo(`P${this.drag.palletId} reubicado a (${newX}, ${newY})`);
                }
                
                document.body.style.cursor = '';
                this.drag.active = false;
            }

            handleMouseMove(e) {
                this.updateDrag(e.clientX, e.clientY);
            }

            handleMouseUp() {
                this.endDrag();
            }

            handleTouchMove(e) {
                if (this.drag.active) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    this.updateDrag(touch.clientX, touch.clientY);
                }
            }

            handleTouchEnd() {
                this.endDrag();
            }

            async cargarInventario() {
                if (!this.isOnline) return;
                
                try {
                    const { data: materiales, error } = await this.supabase
                        .from('materiales')
                        .select(`
                            *,
                            pallets!inner (numero, posicion_x, posicion_y, nombre_personalizado)
                        `)
                        .eq('activo', true);

                    if (error) throw error;

                    this.inventario = {};
                    this.nombresPersonalizados = {};
                    
                    if (materiales) {
                        const palletsMap = new Map();
                        
                        materiales.forEach(material => {
                            const palletNum = material.pallets.numero;
                            const nombrePersonalizado = material.pallets.nombre_personalizado;
                            
                            if (!palletsMap.has(palletNum)) {
                                palletsMap.set(palletNum, {
                                    materiales: [],
                                    total: 0,
                                    posicion: {
                                        x: material.pallets.posicion_x || 50,
                                        y: material.pallets.posicion_y || 50
                                    }
                                });
                                
                                // Guardar nombre personalizado
                                if (nombrePersonalizado) {
                                    this.nombresPersonalizados[palletNum] = nombrePersonalizado;
                                }
                            }

                            palletsMap.get(palletNum).materiales.push({
                                id: material.id,
                                tipo: material.tipo,
                                circunferencia: material.circunferencia,
                                espesor: material.espesor,
                                descripcion: material.descripcion_completa,
                                cantidad: material.cantidad,
                                unidad: material.unidad,
                                proveedor: material.proveedor,
                                fecha: material.fecha_recepcion
                            });
                            
                            this.ultimoPalletId = Math.max(this.ultimoPalletId, palletNum);
                        });

                        palletsMap.forEach((data, palletNum) => {
                            data.total = data.materiales.reduce((sum, m) => sum + m.cantidad, 0);
                            this.inventario[palletNum] = data;
                        });
                    }

                    this.renderizarPallets();
                    this.logInfo(`Inventario cargado: ${Object.keys(this.inventario).length} pallets`);

                } catch (error) {
                    this.logError('Error cargando inventario', error);
                }
            }

            renderizarPallets() {
                const warehouse = document.getElementById('warehouse');
                warehouse.innerHTML = '';

                Object.keys(this.inventario).forEach(palletId => {
                    const datos = this.inventario[palletId];
                    if (datos.total > 0) {
                        this.crearPalletVisual(palletId, datos.posicion.x, datos.posicion.y, 'occupied');
                    }
                });
            }

            crearPalletVisual(palletId, x, y, tipo) {
                const warehouse = document.getElementById('warehouse');
                const pallet = document.createElement('div');
                
                pallet.className = `pallet ${tipo}`;
                pallet.dataset.pallet = palletId;
                pallet.style.left = x + 'px';
                pallet.style.top = y + 'px';
                
                if (tipo === 'temporal') {
                    pallet.innerHTML = '<div class="pallet-name">?</div>';
                    pallet.title = 'Nuevo pallet - Click para configurar';
                    pallet.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.abrirModalPalletTemporal(x, y);
                    });
                } else {
                    const nombrePersonalizado = this.nombresPersonalizados[palletId] || `Pallet ${palletId}`;
                    const total = this.inventario[palletId]?.total || 0;
                    
                    pallet.innerHTML = `
                        <div class="pallet-name">${nombrePersonalizado}</div>
                        <div class="pallet-number">P${palletId}</div>
                    `;
                    
                    pallet.title = `${nombrePersonalizado} (P${palletId}) - ${total} unidades - Arrastra para mover`;
                    
                    pallet.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.abrirModal(palletId);
                    });
                    
                    pallet.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        this.startDrag(palletId, e.clientX, e.clientY);
                    });
                    
                    pallet.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        this.startDrag(palletId, touch.clientX, touch.clientY);
                    });
                }
                
                warehouse.appendChild(pallet);
                return pallet;
            }

            async crearNuevoPallet() {
                try {
                    const warehouse = document.getElementById('warehouse');
                    const rect = warehouse.getBoundingClientRect();
                    
                    // Posición centrada para nuevo pallet
                    const centerX = (rect.width / 2) - (CONFIG.PALLET_SIZE / 2);
                    const centerY = (rect.height / 2) - (CONFIG.PALLET_SIZE / 2);
                    
                    this.crearPalletVisual('temporal', centerX, centerY, 'temporal');
                    this.logInfo('Pallet temporal creado - Click para configurar');
                    
                    // Auto-abrir modal después de un momento
                    setTimeout(() => {
                        this.abrirModalPalletTemporal(centerX, centerY);
                    }, 500);
                    
                } catch (error) {
                    this.logError('Error creando pallet temporal', error);
                }
            }

            abrirModalPalletTemporal(posX, posY) {
                const modal = document.getElementById('modal');
                const modalTitle = document.getElementById('modal-title');
                const modalBody = document.getElementById('modal-body');
                
                modalTitle.textContent = 'Crear Nuevo Pallet';
                
                modalBody.innerHTML = `
                    <div class="form-section">
                        <h4>Información del Material</h4>
                        <div class="form-grid two-col">
                            <div class="form-group">
                                <label>Tipo de Material</label>
                                <select id="tipo-material-temp" required>
                                    <option value="">Seleccionar tipo...</option>
                                    <option value="Lamina">Lámina de Acero</option>
                                    <option value="Strap">Strap/Fleje</option>
                                    <option value="Codo 90">Codo 90°</option>
                                    <option value="Codo 45">Codo 45°</option>
                                    <option value="Tuberia">Tubería</option>
                                    <option value="Accesorio">Accesorio</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Proveedor</label>
                                <input type="text" id="proveedor-temp" placeholder="Nombre del proveedor" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Especificaciones Técnicas</h4>
                        <div class="form-grid three-col">
                            <div class="form-group">
                                <label>Circunferencia (pulgadas)</label>
                                <input type="number" step="0.1" id="circunferencia-temp" placeholder="12.0" required>
                            </div>
                            <div class="form-group">
                                <label>Espesor (pulgadas)</label>
                                <input type="number" step="0.1" id="espesor-temp" placeholder="1.5" required>
                            </div>
                            <div class="form-group">
                                <label>Longitud (opcional)</label>
                                <input type="text" id="longitud-temp" placeholder="20 pies">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Cantidad y Unidades</h4>
                        <div class="form-grid two-col">
                            <div class="form-group">
                                <label>Cantidad Recibida</label>
                                <input type="number" id="cantidad-temp" placeholder="100" required min="1">
                            </div>
                            <div class="form-group">
                                <label>Unidad de Medida</label>
                                <select id="unidad-temp" required>
                                    <option value="pies lineales">Pies Lineales</option>
                                    <option value="piezas">Piezas</option>
                                    <option value="metros">Metros</option>
                                    <option value="kilogramos">Kilogramos</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="inventorySystem.procesarPalletTemporal(${posX}, ${posY})">
                            Confirmar y Crear Pallet
                        </button>
                        <button class="btn btn-secondary" onclick="inventorySystem.cancelarPalletTemporal()">
                            Cancelar
                        </button>
                    </div>
                `;
                
                modal.classList.add('active');
            }

            cancelarPalletTemporal() {
                const temporal = document.querySelector('[data-pallet="temporal"]');
                if (temporal) temporal.remove();
                this.cerrarModal();
                this.logInfo('Creación de pallet cancelada');
            }

            async procesarPalletTemporal(posX, posY) {
                try {
                    const tipo = document.getElementById('tipo-material-temp').value;
                    const proveedor = document.getElementById('proveedor-temp').value;
                    const circunf = document.getElementById('circunferencia-temp').value;
                    const espesor = document.getElementById('espesor-temp').value;
                    const longitud = document.getElementById('longitud-temp').value;
                    const cantidad = parseInt(document.getElementById('cantidad-temp').value);
                    const unidad = document.getElementById('unidad-temp').value;
                    
                    if (!tipo || !proveedor || !circunf || !espesor || !cantidad || !unidad) {
                        alert('Por favor completa todos los campos obligatorios');
                        return;
                    }

                    const numeroAsignado = await this.obtenerProximoNumero();
                    
                    let descripcion = tipo;
                    if (circunf && espesor) {
                        descripcion += ` - ${circunf}" ⌀ × ${espesor}"`;
                        if (longitud) descripcion += ` × ${longitud}`;
                    }

                    // Crear en Supabase
                    const { data: palletData, error: palletError } = await this.supabase
                        .from('pallets')
                        .insert({
                            numero: numeroAsignado,
                            posicion_x: posX,
                            posicion_y: posY
                        })
                        .select()
                        .single();

                    if (palletError) throw palletError;

                    const { data: materialData, error: materialError } = await this.supabase
                        .from('materiales')
                        .insert({
                            pallet_id: palletData.id,
                            tipo: tipo,
                            circunferencia: circunf,
                            espesor: espesor,
                            cantidad: cantidad,
                            unidad: unidad,
                            proveedor: proveedor,
                            descripcion_completa: descripcion,
                            usuario_registro: this.usuarioActual
                        })
                        .select()
                        .single();

                    if (materialError) throw materialError;

                    // Actualizar inventario local
                    this.inventario[numeroAsignado] = {
                        materiales: [{
                            id: materialData.id,
                            tipo: tipo,
                            circunferencia: circunf,
                            espesor: espesor,
                            cantidad: cantidad,
                            unidad: unidad,
                            proveedor: proveedor,
                            descripcion: descripcion,
                            fecha: materialData.fecha_recepcion
                        }],
                        total: cantidad,
                        posicion: { x: posX, y: posY }
                    };

                    // Reemplazar pallet temporal con definitivo
                    const temporal = document.querySelector('[data-pallet="temporal"]');
                    if (temporal) temporal.remove();
                    
                    this.crearPalletVisual(numeroAsignado, posX, posY, 'occupied');
                    
                    this.cerrarModal();
                    this.actualizarContadores();
                    this.logInfo(`P${numeroAsignado} creado exitosamente: ${descripcion}`);
                    
                } catch (error) {
                    this.logError('Error procesando pallet temporal', error);
                    alert('Error al crear el pallet: ' + error.message);
                }
            }

            async actualizarNombrePallet(palletId) {
                try {
                    const inputNombre = document.getElementById('nombre-personalizado');
                    if (!inputNombre) return;
                    
                    const nuevoNombre = inputNombre.value.trim();
                    if (!nuevoNombre) {
                        alert('Por favor ingresa un nombre válido');
                        return;
                    }
                    
                    if (nuevoNombre.length > 20) {
                        alert('El nombre no puede exceder 20 caracteres');
                        return;
                    }
                    
                    // Actualizar en Supabase
                    const { error } = await this.supabase
                        .from('pallets')
                        .update({ nombre_personalizado: nuevoNombre })
                        .eq('numero', parseInt(palletId));
                    
                    if (error) throw error;
                    
                    // Actualizar localmente
                    this.nombresPersonalizados[palletId] = nuevoNombre;
                    
                    // Actualizar visual del pallet
                    const pallet = document.querySelector(`[data-pallet="${palletId}"]`);
                    if (pallet) {
                        const total = this.inventario[palletId]?.total || 0;
                        pallet.innerHTML = `
                            <div class="pallet-name">${nuevoNombre}</div>
                            <div class="pallet-number">P${palletId}</div>
                        `;
                        pallet.title = `${nuevoNombre} (P${palletId}) - ${total} unidades - Arrastra para mover`;
                    }
                    
                    // Actualizar título del modal
                    const modalTitle = document.getElementById('modal-title');
                    if (modalTitle) {
                        modalTitle.textContent = `${nuevoNombre} (P${palletId})`;
                    }
                    
                    this.logInfo(`Pallet P${palletId} renombrado a: "${nuevoNombre}"`);
                    alert(`Pallet renombrado exitosamente a: "${nuevoNombre}"`);
                    
                } catch (error) {
                    this.logError('Error actualizando nombre de pallet', error);
                    alert('Error al actualizar el nombre: ' + error.message);
                }
            }

            async eliminarPalletCompleto(palletId) {
                try {
                    const nombrePallet = this.nombresPersonalizados[palletId] || `Pallet ${palletId}`;
                    
                    if (!confirm(`¿Estás seguro de eliminar completamente "${nombrePallet}" (P${palletId})?\n\nEsta acción NO se puede deshacer y eliminará todos los materiales del pallet.`)) {
                        return;
                    }
                    
                    const datos = this.inventario[palletId];
                    if (!datos) return;

                    // Eliminar todos los materiales
                    for (const material of datos.materiales) {
                        await this.supabase
                            .from('materiales')
                            .update({ activo: false })
                            .eq('id', material.id);
                        
                        // Registrar movimiento de eliminación
                        await this.supabase
                            .from('movimientos')
                            .insert({
                                material_id: material.id,
                                tipo_movimiento: 'eliminacion',
                                cantidad: material.cantidad,
                                usuario: this.usuarioActual,
                                observaciones: `Eliminación completa de ${nombrePallet} (P${palletId})`
                            });
                    }
                    
                    // Eliminar pallet visual
                    const pallet = document.querySelector(`[data-pallet="${palletId}"]`);
                    if (pallet) pallet.remove();
                    
                    // Limpiar datos locales
                    delete this.inventario[palletId];
                    delete this.nombresPersonalizados[palletId];
                    
                    this.cerrarModal();
                    this.actualizarContadores();
                    
                    this.logInfo(`${nombrePallet} (P${palletId}) eliminado completamente`);
                    alert(`"${nombrePallet}" ha sido eliminado completamente del sistema`);
                    
                } catch (error) {
                    this.logError('Error eliminando pallet completo', error);
                    alert('Error al eliminar el pallet: ' + error.message);
                }
            }

            abrirModal(palletId) {
                try {
                    this.palletActual = palletId;
                    const datos = this.inventario[palletId];
                    
                    if (!datos) {
                        this.logError(`Datos no encontrados para P${palletId}`);
                        return;
                    }
                    
                    const modal = document.getElementById('modal');
                    const modalTitle = document.getElementById('modal-title');
                    const modalBody = document.getElementById('modal-body');
                    
                    const nombrePersonalizado = this.nombresPersonalizados[palletId] || `Pallet ${palletId}`;
                    modalTitle.textContent = `📦 ${nombrePersonalizado} (P${palletId})`;
                    
                    modalBody.innerHTML = `
                        <div class="tab-container">
                            <button class="tab active" onclick="inventorySystem.mostrarTab('inventario', ${palletId})">
                                Inventario (${datos.total})
                            </button>
                            <button class="tab" onclick="inventorySystem.mostrarTab('agregar', ${palletId})">
                                Agregar Material
                            </button>
                            <button class="tab" onclick="inventorySystem.mostrarTab('despachar', ${palletId})">
                                Despachar Material
                            </button>
                            <button class="tab" onclick="inventorySystem.mostrarTab('configurar', ${palletId})">
                                Configuración
                            </button>
                        </div>
                        <div id="tab-content">
                            ${this.generarTabInventario(datos)}
                        </div>
                    `;
                    
                    modal.classList.add('active');
                    this.logInfo(`Modal ${nombrePersonalizado} (P${palletId}) abierto`);
                    
                } catch (error) {
                    this.logError('Error abriendo modal', error);
                }
            }

            mostrarTab(tab, palletId) {
                // Actualizar tabs activos
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
                
                const content = document.getElementById('tab-content');
                const datos = this.inventario[palletId];
                
                if (tab === 'inventario') {
                    content.innerHTML = this.generarTabInventario(datos);
                } else if (tab === 'agregar') {
                    content.innerHTML = this.generarTabAgregar(palletId);
                } else if (tab === 'despachar') {
                    content.innerHTML = this.generarTabDespachar(datos, palletId);
                } else if (tab === 'configurar') {
                    content.innerHTML = this.generarTabConfiguracion(palletId);
                }
            }

            generarTabInventario(datos) {
                const materialesHTML = datos.materiales.map(item => `
                    <div class="material-card">
                        <div class="material-header">
                            <div>
                                <div class="material-title">${item.descripcion || item.tipo}</div>
                                <div class="material-details">
                                    Dimensiones: ${item.circunferencia || 'N/A'}" ⌀ × ${item.espesor || 'N/A'}" espesor<br>
                                    Proveedor: ${item.proveedor || 'Sin especificar'}<br>
                                    Fecha recepción: ${new Date(item.fecha).toLocaleString()}
                                </div>
                            </div>
                            <div class="material-badge">${item.cantidad} ${item.unidad}</div>
                        </div>
                    </div>
                `).join('');
                
                return `
                    <div class="form-section">
                        <h4>Inventario Actual (${datos.total} unidades totales)</h4>
                        <div class="scrollable-content">
                            ${materialesHTML}
                        </div>
                    </div>
                `;
            }

            generarTabAgregar(palletId) {
                return `
                    <div class="form-section">
                        <h4>Agregar Material al Pallet P${palletId}</h4>
                        
                        <div class="form-grid two-col">
                            <div class="form-group">
                                <label>Tipo de Material</label>
                                <select id="tipo-agregar" required>
                                    <option value="">Seleccionar tipo...</option>
                                    <option value="Lamina">Lámina de Acero</option>
                                    <option value="Strap">Strap/Fleje</option>
                                    <option value="Codo 90">Codo 90°</option>
                                    <option value="Codo 45">Codo 45°</option>
                                    <option value="Tuberia">Tubería</option>
                                    <option value="Accesorio">Accesorio</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Proveedor</label>
                                <input type="text" id="proveedor-agregar" placeholder="Nombre del proveedor" required>
                            </div>
                        </div>

                        <div class="form-grid three-col">
                            <div class="form-group">
                                <label>Circunferencia (pulgadas)</label>
                                <input type="number" step="0.1" id="circunferencia-agregar" placeholder="12.0" required>
                            </div>
                            <div class="form-group">
                                <label>Espesor (pulgadas)</label>
                                <input type="number" step="0.1" id="espesor-agregar" placeholder="1.5" required>
                            </div>
                            <div class="form-group">
                                <label>Longitud (opcional)</label>
                                <input type="text" id="longitud-agregar" placeholder="20 pies">
                            </div>
                        </div>

                        <div class="form-grid two-col">
                            <div class="form-group">
                                <label>Cantidad</label>
                                <input type="number" id="cantidad-agregar" placeholder="100" required min="1">
                            </div>
                            <div class="form-group">
                                <label>Unidad de Medida</label>
                                <select id="unidad-agregar" required>
                                    <option value="pies lineales">Pies Lineales</option>
                                    <option value="piezas">Piezas</option>
                                    <option value="metros">Metros</option>
                                    <option value="kilogramos">Kilogramos</option>
                                </select>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="inventorySystem.procesarAgregarMaterial(${palletId})">
                                Agregar Material
                            </button>
                        </div>
                    </div>
                `;
            }

            generarTabDespachar(datos, palletId) {
                const materialesHTML = datos.materiales.map(item => `
                    <div class="material-card">
                        <div class="material-header">
                            <div>
                                <div class="material-title">${item.descripcion || item.tipo}</div>
                                <div class="material-details">
                                    Stock disponible: <strong>${item.cantidad} ${item.unidad}</strong><br>
                                    Proveedor: ${item.proveedor || 'N/A'}<br>
                                    Fecha recepción: ${new Date(item.fecha).toLocaleDateString()}
                                </div>
                            </div>
                            <div class="material-badge">Stock: ${item.cantidad}</div>
                        </div>
                        <div class="despacho-controls">
                            <label style="font-weight: 600; color: var(--dark);">Cantidad a despachar:</label>
                            <input type="number" id="despachar-${item.id}" class="despacho-input" 
                                   min="0" max="${item.cantidad}" placeholder="0">
                            <span style="color: var(--gray);">de ${item.cantidad}</span>
                        </div>
                    </div>
                `).join('');
                
                return `
                    <div class="form-section">
                        <h4>Despachar Material del Pallet P${palletId}</h4>
                        <div class="scrollable-content">
                            ${materialesHTML}
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="inventorySystem.procesarDespacho(${palletId})">
                                Despacho Parcial
                            </button>
                            <button class="btn btn-danger" onclick="inventorySystem.despacharTodo(${palletId})">
                                Despachar Todo
                            </button>
                        </div>
                    </div>
                `;
            }

            generarTabConfiguracion(palletId) {
                const nombreActual = this.nombresPersonalizados[palletId] || `Pallet ${palletId}`;
                const datos = this.inventario[palletId];
                
                return `
                    <div class="form-section">
                        <h4>Configuración del Pallet P${palletId}</h4>
                        
                        <div class="form-group">
                            <label>Nombre Personalizado</label>
                            <input type="text" id="nombre-personalizado" 
                                   value="${nombreActual}" 
                                   placeholder="Ej: Acero Estructural, Tubería Principal, etc."
                                   maxlength="20">
                            <small style="color: var(--gray); font-size: 12px; margin-top: 4px;">
                                El sistema seguirá usando P${palletId} internamente. Este nombre es solo para identificación visual.
                            </small>
                        </div>

                        <div class="form-section" style="background: var(--gray-light); padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <h4 style="margin-bottom: 16px;">Información del Pallet</h4>
                            <div class="form-grid two-col">
                                <div>
                                    <label>Número Interno:</label>
                                    <div style="font-weight: 600; color: var(--primary);">P${palletId}</div>
                                </div>
                                <div>
                                    <label>Total Material:</label>
                                    <div style="font-weight: 600; color: var(--accent);">${datos.total} unidades</div>
                                </div>
                                <div>
                                    <label>Posición:</label>
                                    <div style="font-weight: 600; color: var(--gray);">
                                        X: ${Math.round(datos.posicion.x)}, Y: ${Math.round(datos.posicion.y)}
                                    </div>
                                </div>
                                <div>
                                    <label>Tipos de Material:</label>
                                    <div style="font-weight: 600; color: var(--dark);">
                                        ${[...new Set(datos.materiales.map(m => m.tipo))].length} diferentes
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="inventorySystem.actualizarNombrePallet(${palletId})">
                                Guardar Nombre
                            </button>
                            <button class="btn btn-danger" onclick="inventorySystem.eliminarPalletCompleto(${palletId})">
                                Eliminar Pallet
                            </button>
                        </div>
                    </div>
                `;
            }

            generarTabConfiguracion(palletId) {
                const nombreActual = this.nombresPersonalizados[palletId] || `Pallet ${palletId}`;
                const datos = this.inventario[palletId];
                
                return `
                    <div class="form-section">
                        <h4>Configuración del Pallet P${palletId}</h4>
                        
                        <div class="form-group">
                            <label>Nombre Personalizado</label>
                            <input type="text" id="nombre-personalizado" 
                                   value="${nombreActual}" 
                                   placeholder="Ej: Acero Estructural, Tubería Principal, etc."
                                   maxlength="20">
                            <small style="color: var(--gray); font-size: 12px; margin-top: 4px;">
                                El sistema seguirá usando P${palletId} internamente. Este nombre es solo para identificación visual.
                            </small>
                        </div>

                        <div class="form-section" style="background: var(--gray-light); padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <h4 style="margin-bottom: 12px;">Información del Pallet</h4>
                            <div class="form-grid two-col">
                                <div>
                                    <label>Número Interno:</label>
                                    <div style="font-weight: 600; color: var(--dark);">P${palletId}</div>
                                </div>
                                <div>
                                    <label>Total Material:</label>
                                    <div style="font-weight: 600; color: var(--dark);">${datos.total} unidades</div>
                                </div>
                                <div>
                                    <label>Posición:</label>
                                    <div style="font-weight: 600; color: var(--gray);">
                                        X: ${Math.round(datos.posicion.x)}, Y: ${Math.round(datos.posicion.y)}
                                    </div>
                                </div>
                                <div>
                                    <label>Tipos de Material:</label>
                                    <div style="font-weight: 600; color: var(--dark);">
                                        ${[...new Set(datos.materiales.map(m => m.tipo))].length} diferentes
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="inventorySystem.actualizarNombrePallet(${palletId})">
                                Guardar Nombre
                            </button>
                            <button class="btn btn-danger" onclick="inventorySystem.eliminarPalletCompleto(${palletId})">
                                Eliminar Pallet
                            </button>
                        </div>
                    </div>
                `;
            }

            async procesarAgregarMaterial(palletId) {
                try {
                    const tipo = document.getElementById('tipo-agregar').value;
                    const proveedor = document.getElementById('proveedor-agregar').value;
                    const circunf = document.getElementById('circunferencia-agregar').value;
                    const espesor = document.getElementById('espesor-agregar').value;
                    const longitud = document.getElementById('longitud-agregar').value;
                    const cantidad = parseInt(document.getElementById('cantidad-agregar').value);
                    const unidad = document.getElementById('unidad-agregar').value;
                    
                    if (!tipo || !proveedor || !circunf || !espesor || !cantidad || !unidad) {
                        alert('❌ Por favor completa todos los campos obligatorios');
                        return;
                    }

                    const { data: palletData } = await this.supabase
                        .from('pallets')
                        .select('id')
                        .eq('numero', palletId)
                        .single();

                    let descripcion = tipo;
                    if (circunf && espesor) {
                        descripcion += ` - ${circunf}" × ${espesor}"`;
                        if (longitud) descripcion += ` × ${longitud}`;
                    }

                    const { data: materialData, error } = await this.supabase
                        .from('materiales')
                        .insert({
                            pallet_id: palletData.id,
                            tipo: tipo,
                            circunferencia: circunf,
                            espesor: espesor,
                            cantidad: cantidad,
                            unidad: unidad,
                            proveedor: proveedor,
                            descripcion_completa: descripcion,
                            usuario_registro: this.usuarioActual
                        })
                        .select()
                        .single();

                    if (error) throw error;

                    // Actualizar inventario local
                    this.inventario[palletId].materiales.push({
                        id: materialData.id,
                        tipo, circunferencia: circunf, espesor, cantidad, unidad, proveedor,
                        descripcion, fecha: materialData.fecha_recepcion
                    });

                    this.inventario[palletId].total = this.inventario[palletId].materiales.reduce((sum, m) => sum + m.cantidad, 0);
                    
                    this.mostrarTab('inventario', palletId);
                    this.actualizarContadores();
                    this.logInfo(`Material agregado a P${palletId}: ${descripcion}`);
                    
                } catch (error) {
                    this.logError('Error agregando material', error);
                    alert('❌ Error al agregar material: ' + error.message);
                }
            }

            async procesarDespacho(palletId) {
                try {
                    const datos = this.inventario[palletId];
                    let despachoRealizado = false;
                    
                    for (const material of datos.materiales) {
                        const input = document.getElementById(`despachar-${material.id}`);
                        if (!input) continue;
                        
                        const cantidadDespacho = parseInt(input.value) || 0;
                        if (cantidadDespacho <= 0) continue;
                        
                        if (cantidadDespacho > material.cantidad) {
                            alert(`No puedes despachar ${cantidadDespacho} de ${material.descripcion}. Solo hay ${material.cantidad} disponibles.`);
                            return;
                        }
                        
                        const nuevaCantidad = material.cantidad - cantidadDespacho;
                        
                        if (nuevaCantidad === 0) {
                            await this.supabase
                                .from('materiales')
                                .update({ activo: false })
                                .eq('id', material.id);
                        } else {
                            await this.supabase
                                .from('materiales')
                                .update({ cantidad: nuevaCantidad })
                                .eq('id', material.id);
                        }
                        
                        material.cantidad = nuevaCantidad;
                        despachoRealizado = true;
                        
                        this.logInfo(`Despachado: ${cantidadDespacho} ${material.unidad} de ${material.descripcion}`);
                    }
                    
                    if (despachoRealizado) {
                        datos.materiales = datos.materiales.filter(m => m.cantidad > 0);
                        datos.total = datos.materiales.reduce((sum, m) => sum + m.cantidad, 0);
                        
                        if (datos.total === 0) {
                            const pallet = document.querySelector(`[data-pallet="${palletId}"]`);
                            if (pallet) pallet.remove();
                            delete this.inventario[palletId];
                            this.cerrarModal();
                            this.logInfo(`P${palletId} completamente despachado`);
                        } else {
                            this.mostrarTab('inventario', palletId);
                        }
                        
                        this.actualizarContadores();
                    }
                    
                } catch (error) {
                    this.logError('Error procesando despacho', error);
                    alert('❌ Error al procesar despacho: ' + error.message);
                }
            }

            async despacharTodo(palletId) {
                if (!confirm(`¿Estás seguro de despachar TODO el pallet P${palletId}?`)) return;
                
                try {
                    const datos = this.inventario[palletId];
                    
                    for (const material of datos.materiales) {
                        await this.supabase
                            .from('materiales')
                            .update({ activo: false })
                            .eq('id', material.id);
                    }
                    
                    const pallet = document.querySelector(`[data-pallet="${palletId}"]`);
                    if (pallet) pallet.remove();
                    
                    delete this.inventario[palletId];
                    this.cerrarModal();
                    this.actualizarContadores();
                    this.logInfo(`P${palletId} despachado completamente`);
                    
                } catch (error) {
                    this.logError('Error despachando pallet completo', error);
                    alert('❌ Error al despachar pallet: ' + error.message);
                }
            }

            async obtenerProximoNumero() {
                try {
                    const { data } = await this.supabase
                        .from('pallets')
                        .select('numero')
                        .order('numero', { ascending: false })
                        .limit(1)
                        .single();
                    
                    return data ? data.numero + 1 : 1;
                } catch {
                    return Math.max(...Object.keys(this.inventario).map(Number), 0) + 1;
                }
            }

            async actualizarPosicionPallet(palletId, x, y) {
                try {
                    if (!this.isOnline) return;
                    
                    await this.supabase
                        .from('pallets')
                        .update({
                            posicion_x: Math.round(x),
                            posicion_y: Math.round(y)
                        })
                        .eq('numero', parseInt(palletId));
                    
                } catch (error) {
                    this.logError('Error actualizando posición', error);
                }
            }

            async buscarMateriales() {
                try {
                    const tipo = document.getElementById('search-tipo').value;
                    const circunf = document.getElementById('search-circunf').value;
                    const espesor = document.getElementById('search-espesor').value;
                    const proveedor = document.getElementById('search-proveedor').value;

                    if (!tipo && !circunf && !espesor && !proveedor) {
                        alert('Ingresa al menos un criterio de búsqueda');
                        return;
                    }

                    let query = this.supabase
                        .from('materiales')
                        .select('*, pallets!inner (numero)')
                        .eq('activo', true);

                    if (tipo) query = query.ilike('tipo', `%${tipo}%`);
                    if (circunf) query = query.ilike('circunferencia', `%${circunf}%`);
                    if (espesor) query = query.ilike('espesor', `%${espesor}%`);
                    if (proveedor) query = query.ilike('proveedor', `%${proveedor}%`);

                    const { data: materiales, error } = await query;
                    if (error) throw error;

                    this.mostrarResultados(materiales || []);
                    
                } catch (error) {
                    this.logError('Error en búsqueda', error);
                }
            }

            mostrarResultados(materiales) {
                const container = document.getElementById('resultados-busqueda');
                const contenido = document.getElementById('contenido-resultados');
                
                if (materiales.length === 0) {
                    alert('No se encontraron materiales');
                    container.style.display = 'none';
                    return;
                }
                
                const resultadosHTML = materiales.map(material => {
                    const palletId = material.pallets.numero;
                    const nombrePersonalizado = this.nombresPersonalizados[palletId] || `Pallet ${palletId}`;
                    
                    return `
                        <div class="search-result-item">
                            <div class="result-info">
                                <strong style="color: black;">${material.descripcion_completa || material.tipo}</strong><br>
                                <small style="color: var(--gray);">
                                    ${material.cantidad} ${material.unidad} en ${nombrePersonalizado} (P${palletId})
                                </small>
                            </div>
                            <button class="result-btn" onclick="inventorySystem.irAPallet(${palletId})">
                                Ver ${nombrePersonalizado}
                            </button>
                        </div>
                    `;
                }).join('');
                
                contenido.innerHTML = resultadosHTML;
                container.style.display = 'block';
                this.logInfo(`Búsqueda completada: ${materiales.length} materiales`);
            }

            limpiarBusqueda() {
                document.getElementById('search-tipo').value = '';
                document.getElementById('search-circunf').value = '';
                document.getElementById('search-espesor').value = '';
                document.getElementById('search-proveedor').value = '';
                
                const container = document.getElementById('resultados-busqueda');
                container.style.display = 'none';
                
                this.logInfo('Búsqueda limpiada');
            }

            irAPallet(palletId) {
                this.abrirModal(palletId);
                document.getElementById('resultados-busqueda').style.display = 'none';
            }

            cerrarModal() {
                document.getElementById('modal').classList.remove('active');
                this.palletActual = null;
            }

            iniciarSincronizacion() {
                if (!this.isOnline) return;
                
                this.pollingInterval = setInterval(async () => {
                    try {
                        await this.cargarInventario();
                    } catch (error) {
                        this.logError('Error en sincronización', error);
                    }
                }, CONFIG.POLLING_INTERVAL);
                
                this.logInfo('Sincronización automática iniciada');
            }

            actualizarEstadoConexion(estado) {
                const element = document.getElementById('connection-status');
                element.className = `connection-status ${estado}`;
                
                switch(estado) {
                    case 'connected':
                        element.textContent = 'Conectado';
                        break;
                    case 'connecting':
                        element.textContent = 'Conectando...';
                        break;
                    case 'disconnected':
                        element.textContent = 'Sin conexión';
                        break;
                }
            }

            actualizarContadores() {
                const totalPallets = Object.keys(this.inventario).length;
                const palletsOcupados = Object.keys(this.inventario).filter(id => 
                    this.inventario[id].total > 0
                ).length;

                const contadorTotal = document.getElementById('contador-pallets');
                const contadorOcupados = document.getElementById('contador-ocupados');
                
                if (contadorTotal) contadorTotal.textContent = totalPallets;
                if (contadorOcupados) contadorOcupados.textContent = palletsOcupados;
            }
        }

        // Funciones globales
        function cambiarUsuario() {
            const selector = document.getElementById('usuario-selector');
            if (window.inventorySystem && selector) {
                window.inventorySystem.usuarioActual = selector.value;
                window.inventorySystem.logInfo(`Usuario cambiado a: ${selector.value}`);
            }
        }

        function buscarMateriales() {
            window.inventorySystem?.buscarMateriales();
        }

        function limpiarBusqueda() {
            window.inventorySystem?.limpiarBusqueda();
        }

        function cerrarModal() {
            window.inventorySystem?.cerrarModal();
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('=== APACHE INVENTORY PRO - INICIALIZANDO ===');
            
            try {
                window.inventorySystem = new InventorySystemPro();
                await window.inventorySystem.init();
                console.log('=== SISTEMA COMPLETAMENTE OPERATIVO ===');
            } catch (error) {
                console.error('ERROR CRÍTICO:', error);
                alert('❌ Error crítico inicializando el sistema');
            }
        });
    </script>
</body>
</html>
