<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">WorkYard Manager - Enterprise</title>
    <style>
        :root {
            --crimson: #C8102E;
            --onyx: #000000;
            --white: #FFFFFF;
            --steel: #565552;
            --light-grey: #F3F3F3;
            --medium-grey: #CCCCCB;
            --grey: #969593;
            --dark-grey: #4F4F4F;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
            touch-action: manipulation;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--white);
            color: var(--onyx);
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 200vh;
            margin: 0;
            padding: 0;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
        }

        .header {
            background: var(--onyx);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--medium-grey);
            touch-action: manipulation;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            height: 40px;
            width: auto;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--white);
            margin: 0;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .language-selector, .user-selector {
            position: relative;
        }

        .language-selector select, .user-selector select {
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--dark-grey);
            color: var(--white);
            border: 1px solid var(--medium-grey);
            font-size: 14px;
            cursor: pointer;
            touch-action: manipulation;
        }

        .connection-status {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .connected { 
            background: var(--crimson);
            color: var(--white);
        }

        .disconnected {
            background: var(--steel);
            color: var(--white);
        }

        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: calc(200vh - 64px);
            gap: 0;
        }

        .sidebar {
            background: var(--light-grey);
            padding: 20px;
            position: sticky;
            top: 64px;
            height: calc(100vh - 64px);
            overflow-y: auto;
            border-right: 1px solid var(--medium-grey);
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }

        .sidebar-section {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--medium-grey);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .sidebar-section h3 {
            color: var(--onyx);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--medium-grey);
        }

        .create-pallet-btn {
            width: 100%;
            padding: 16px;
            background: var(--crimson);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(200, 16, 46, 0.3);
            margin-bottom: 24px;
            touch-action: manipulation;
        }

        .create-pallet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(200, 16, 46, 0.4);
            background: #a50d26;
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .form-field label {
            color: var(--steel);
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 6px;
            display: block;
        }

        .form-field input, .form-field select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--medium-grey);
            border-radius: 8px;
            background: var(--white);
            color: var(--onyx);
            font-size: 14px;
            touch-action: manipulation;
        }

        .form-field input::placeholder {
            color: var(--grey);
        }

        .btn-search, .btn-clear {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            width: 100%;
            touch-action: manipulation;
        }

        .btn-search {
            background: var(--crimson);
            color: var(--white);
        }

        .btn-search:hover {
            background: #a50d26;
        }

        .btn-clear {
            background: var(--steel);
            color: var(--white);
        }

        .btn-clear:hover {
            background: var(--dark-grey);
        }

        .warehouse {
            background: var(--white);
            position: relative;
            height: calc(100vh - 120px);
            margin: 20px;
            border-radius: 16px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            border: 2px solid var(--light-grey);
            overflow: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            touch-action: auto;
        }

        .warehouse-canvas {
            position: relative;
            width: 3000px;
            height: 2000px;
            background-image: 
                radial-gradient(circle at 25px 25px, var(--medium-grey) 2px, transparent 0),
                radial-gradient(circle at 75px 75px, var(--medium-grey) 2px, transparent 0);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
            min-height: 100%;
        }

        .warehouse::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .warehouse::-webkit-scrollbar-track {
            background: var(--light-grey);
            border-radius: 8px;
            border: 1px solid var(--medium-grey);
        }

        .warehouse::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--crimson), #a50d26);
            border-radius: 8px;
            border: 2px solid var(--light-grey);
            min-height: 50px;
        }

        .warehouse::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #a50d26, var(--steel));
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }

        .warehouse::-webkit-scrollbar-corner {
            background: var(--light-grey);
        }

        /* MÓVILES: Solo scroll vertical, contenido centrado */
        @media (max-width: 768px) {
            .warehouse {
                height: calc(100vh - 140px);
                margin: 5px;
                overflow-x: hidden;
                overflow-y: auto;
                touch-action: pan-y;
            }
            
            .warehouse-canvas {
                width: 100% !important;
                min-width: calc(100vw - 20px);
                max-width: calc(100vw - 20px);
                height: auto;
                min-height: 1200px;
                background-size: 30px 30px;
                background-position: 0 0, 15px 15px;
            }
            
            .warehouse::-webkit-scrollbar {
                width: 6px;
                height: 0px;
            }
            
            .warehouse::-webkit-scrollbar-track {
                background: var(--light-grey);
                border-radius: 3px;
            }
            
            .warehouse::-webkit-scrollbar-thumb {
                background: var(--crimson);
                border-radius: 3px;
                border: 1px solid var(--light-grey);
            }
        }

        .pallet {
            width: 40px;
            height: 40px;
            position: absolute;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            user-select: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 2px solid var(--medium-grey);
            touch-action: none;
        }

        .pallet:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .pallet.occupied {
            background: var(--crimson);
            border-color: var(--steel);
        }

        .pallet.empty {
            background: var(--grey);
            border-color: var(--medium-grey);
            opacity: 0.7;
            font-size: 12px;
        }

        .pallet.empty:hover {
            background: var(--steel);
            opacity: 1;
        }

        .pallet.temporal {
            background: var(--steel);
            animation: modernPulse 2s ease-in-out infinite;
            cursor: pointer;
        }

        .pallet.dragging {
            cursor: grabbing;
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            z-index: 100;
            background: var(--dark-grey);
        }

        @keyframes modernPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            overscroll-behavior: contain;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--medium-grey);
            touch-action: pan-y;
        }

        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: var(--onyx);
            color: var(--white);
            padding: 24px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            touch-action: manipulation;
        }

        .modal-header h3 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .modal-close {
            background: var(--steel);
            border: none;
            color: var(--white);
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .modal-close:hover {
            background: var(--dark-grey);
            transform: scale(1.05);
        }

        .modal-body {
            padding: 0;
            overflow-y: auto;
            max-height: calc(90vh - 100px);
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }

        .section-navigation {
            display: flex;
            background: var(--light-grey);
            border-bottom: 1px solid var(--medium-grey);
            touch-action: manipulation;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--grey);
            position: relative;
            touch-action: manipulation;
        }

        .nav-tab.active {
            color: var(--crimson);
            background: var(--white);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: var(--crimson);
            border-radius: 2px;
        }

        .section-content {
            padding: 30px;
            background: var(--white);
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }

        .form-section {
            margin-bottom: 32px;
        }

        .form-section h4 {
            font-size: 20px;
            font-weight: 700;
            color: var(--onyx);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-section h4::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--crimson);
            border-radius: 2px;
        }

        .form-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-grid.cols-2 { grid-template-columns: 1fr 1fr; }
        .form-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
        .form-grid.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 600;
            color: var(--steel);
            margin-bottom: 8px;
        }

        .form-group input, .form-group select {
            padding: 14px 16px;
            border: 2px solid var(--medium-grey);
            border-radius: 10px;
            font-size: 16px;
            background: var(--white);
            transition: all 0.2s ease;
            height: 52px;
            color: var(--onyx);
            touch-action: manipulation;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--crimson);
            box-shadow: 0 0 0 3px rgba(200, 16, 46, 0.1);
            transform: translateY(-1px);
        }

        .action-button {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 160px;
            height: 56px;
            touch-action: manipulation;
        }

        .action-button.primary {
            background: var(--crimson);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(200, 16, 46, 0.3);
        }

        .action-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(200, 16, 46, 0.4);
            background: #a50d26;
        }

        .action-button.success {
            background: var(--crimson);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(200, 16, 46, 0.3);
        }

        .action-button.success:hover {
            background: #a50d26;
        }

        .action-button.danger {
            background: var(--steel);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(86, 85, 82, 0.3);
        }

        .action-button.danger:hover {
            background: var(--dark-grey);
        }

        .action-button.secondary {
            background: var(--white);
            color: var(--steel);
            border: 2px solid var(--medium-grey);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .action-button.secondary:hover {
            background: var(--light-grey);
        }

        .button-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 32px;
            justify-content: center;
        }

        .material-card {
            background: var(--light-grey);
            border: 1px solid var(--medium-grey);
            border-radius: 16px;
            padding: 24px;
            margin: 16px 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
        }

        .material-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--crimson);
        }

        .material-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.1);
        }

        .material-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .material-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--onyx);
            margin-bottom: 8px;
        }

        .material-specs {
            color: var(--grey);
            font-size: 14px;
            line-height: 1.5;
        }

        .quantity-badge {
            background: var(--crimson);
            color: var(--white);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            min-width: 80px;
        }

        .dispatch-controls {
            background: var(--white);
            border: 1px solid var(--medium-grey);
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
            touch-action: manipulation;
        }

        .dispatch-row {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .dispatch-input {
            width: 100px;
            padding: 12px;
            border: 2px solid var(--medium-grey);
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            font-weight: 600;
            background: var(--white);
            color: var(--onyx);
            touch-action: manipulation;
        }

        .dispatch-input:focus {
            border-color: var(--crimson);
            box-shadow: 0 0 0 3px rgba(200, 16, 46, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            color: var(--steel);
            font-size: 12px;
        }

        .search-results {
            background: var(--light-grey);
            margin: 20px;
            padding: 20px;
            border-radius: 16px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--medium-grey);
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }

        .scrollable-area {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }

        .scrollable-area::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable-area::-webkit-scrollbar-track {
            background: var(--light-grey);
            border-radius: 3px;
        }

        .scrollable-area::-webkit-scrollbar-thumb {
            background: var(--medium-grey);
            border-radius: 3px;
        }

        .scrollable-area::-webkit-scrollbar-thumb:hover {
            background: var(--grey);
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .sidebar {
                position: relative;
                top: 0;
                height: auto;
                padding: 16px;
                touch-action: pan-y;
            }
            
            .warehouse {
                height: calc(100vh - 200px);
                touch-action: auto;
                margin: 10px;
            }
            
            .warehouse-canvas {
                width: 2500px;
                height: 1800px;
            }
            
            .form-grid.cols-3 { grid-template-columns: 1fr 1fr; }
            .form-grid.cols-4 { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            .modal-content {
                max-width: calc(100vw - 20px);
                margin: 10px;
            }
            
            .section-content {
                padding: 20px;
            }
            
            .form-grid.cols-2,
            .form-grid.cols-3,
            .form-grid.cols-4 {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .action-button {
                width: 100%;
                min-width: auto;
            }
            
            .pallet {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }

            .user-controls {
                flex-wrap: wrap;
                gap: 8px;
            }

            .header {
                height: auto;
                padding: 12px 15px;
                touch-action: manipulation;
            }

            .header-brand {
                gap: 12px;
            }

            .header h1 {
                font-size: 16px;
            }

            .header-logo {
                height: 32px;
            }

            .warehouse {
                height: calc(100vh - 140px);
                margin: 5px;
                touch-action: auto;
            }
            
            .warehouse-canvas {
                width: 2000px;
                height: 1500px;
            }
            
            .warehouse::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-brand">
            <img src="https://www.apacheip.com/themes/custom/apache/images/apache-logo.png" alt="Apache Logo" class="header-logo">
            <h1 data-i18n="system_title">WorkYard Manager</h1>
        </div>
        <div class="user-controls">
            <div class="language-selector">
                <select id="language-selector">
                    <option value="es">Español</option>
                    <option value="en">English</option>
                </select>
            </div>
            <div class="user-selector">
                <select id="usuario-selector">
                    <option value="Usuario1" data-i18n="user_1">Usuario 1</option>
                    <option value="Usuario2" data-i18n="user_2">Usuario 2</option>
                    <option value="Usuario3" data-i18n="user_3">Usuario 3</option>
                </select>
            </div>
            <div id="connection-status" class="connection-status disconnected" data-i18n="demo_mode">
                Modo Demo
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar scrollable-area">
            <button class="create-pallet-btn" id="btn-crear-pallet" data-i18n="create_new_pallet">
                + Crear Nuevo Pallet
            </button>

            <div class="sidebar-section">
                <h3 data-i18n="material_search">Búsqueda de Materiales</h3>
                <div class="search-grid">
                    <div class="form-field">
                        <label data-i18n="material_type">Tipo de Material</label>
                        <input type="text" id="search-tipo" list="search-material-types" placeholder="Selecciona o escribe tipo de material">
                        <datalist id="search-material-types">
                            <option value=""></option>
                        </datalist>
                    </div>
                    
                    <div class="form-field">
                        <label data-i18n="circumference">Circunferencia</label>
                        <select id="search-circunf">
                            <option value="">Todas las circunferencias</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <label data-i18n="thickness">Espesor</label>
                        <input type="text" id="search-espesor" placeholder="1.5">
                    </div>
                </div>
                
                <button class="btn-search" id="btn-buscar" data-i18n="search_materials">Buscar Materiales</button>
                <button class="btn-clear" id="btn-limpiar" data-i18n="clear_filters">Limpiar Filtros</button>
            </div>

            <div class="sidebar-section">
                <h3 data-i18n="statistics">Estadísticas</h3>
                <div class="stats-grid">
                    <div><span data-i18n="total_pallets">Total pallets:</span> <strong id="contador-pallets">0</strong></div>
                    <div><span data-i18n="occupied">Ocupados:</span> <strong id="contador-ocupados">0</strong></div>
                </div>
                <button class="btn-search" style="margin-top: 8px; font-size: 12px; padding: 8px;" id="btn-respaldos">
                    Gestión de Respaldos
                </button>
                <button class="btn-clear" style="margin-top: 8px; font-size: 12px; padding: 8px;" id="btn-resetear">
                    Resetear Sistema
                </button>
                <button class="btn-search" style="margin-top: 8px; font-size: 12px; padding: 8px;" id="btn-probar">
                    Probar Conexión
                </button>
            </div>
        </div>

        <div class="main-content">
            <div id="resultados-busqueda" class="search-results scrollable-area">
                <h3 data-i18n="search_results" style="color: var(--onyx); margin-bottom: 16px;">Resultados de Búsqueda</h3>
                <div id="contenido-resultados"></div>
            </div>

            <div class="warehouse scrollable-area" id="warehouse">
                <div class="warehouse-canvas" id="warehouse-canvas"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" data-i18n="pallet_management">Gestión de Pallet</h3>
                <button class="modal-close" id="btn-cerrar-modal" data-i18n="close">Cerrar</button>
            </div>
            <div class="modal-body scrollable-area">
                <div class="section-navigation" id="section-nav" style="display: none;">
                    <button class="nav-tab active" id="tab-inventario">Ver Inventario</button>
                    <button class="nav-tab" id="tab-agregar">Agregar Material</button>
                    <button class="nav-tab" id="tab-editar">Editar Materiales</button>
                    <button class="nav-tab" id="tab-despachar">Despachar Material</button>
                </div>
                <div class="section-content" id="modal-content"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Sistema de internacionalización
        const i18n = {
            es: {
                system_title: 'WorkYard Manager',
                page_title: 'WorkYard Manager - Enterprise',
                connected: 'Conectado',
                disconnected: 'Sin conexión',
                demo_mode: 'Modo Demo',
                user_1: 'Usuario 1',
                user_2: 'Usuario 2', 
                user_3: 'Usuario 3',
                close: 'Cerrar',
                create_new_pallet: '+ Crear Nuevo Pallet',
                material_search: 'Búsqueda de Materiales',
                material_type: 'Tipo de Material',
                circumference: 'Circunferencia',
                thickness: 'Espesor',
                search_materials: 'Buscar Materiales',
                clear_filters: 'Limpiar Filtros',
                statistics: 'Estadísticas',
                total_pallets: 'Total pallets:',
                occupied: 'Ocupados:',
                search_results: 'Resultados de Búsqueda',
                pallet_management: 'Gestión de Pallet',
                view_inventory: 'Ver Inventario',
                add_material: 'Agregar Material',
                edit_materials: 'Editar Materiales',
                dispatch_material: 'Despachar Material',
                create_new_pallet_title: 'Crear Nuevo Pallet',
                pallet_info: 'Información del Pallet',
                package_number: 'Paquete #',
                custom_pallet_name: 'Nombre del Pallet',
                custom_name_placeholder: 'Nombre personalizado (opcional)',
                material_info: 'Información del Material',
                technical_specs: 'Especificaciones Técnicas',
                quantity_measures: 'Cantidad y Medidas',
                select_or_type_material: 'Selecciona o escribe tipo de material',
                steel_sheet: 'Lámina de Acero',
                strap_band: 'Strap/Fleje',
                elbow_90_deg: 'Codo 90°',
                elbow_45_deg: 'Codo 45°',
                pipe: 'Tubería',
                accessory: 'Accesorio',
                other: 'Otro',
                supplier: 'Proveedor',
                supplier_name: 'Nombre del proveedor',
                length: 'Longitud',
                weight: 'Peso',
                weight_optional: 'Peso (opcional)',
                quantity_received: 'Cantidad Recibida',
                unit_measure: 'Unidad de Medida',
                linear_feet: 'Pies Lineales',
                inches: 'Pulgadas',
                pieces: 'Piezas',
                meters: 'Metros',
                kilograms: 'Kilogramos',
                tons: 'Toneladas',
                create_pallet: 'Crear Pallet',
                cancel: 'Cancelar',
                current_inventory: 'Inventario Actual',
                total_units_pallet: 'UNIDADES TOTALES EN PALLET',
                specifications: 'Especificaciones:',
                supplier_label: 'Proveedor:',
                received: 'Recibido:',
                not_specified: 'No especificado',
                units: 'unidades',
                add_material_to_pallet: 'Agregar Material al Pallet P',
                quantity_to_add: 'Cantidad a Agregar',
                add_material_btn: 'Agregar Material',
                dispatch_material_from: 'Despachar Material del Pallet P',
                available_stock: 'Stock disponible:',
                quantity_to_dispatch: 'Cantidad a despachar:',
                available_units: 'disponibles',
                confirm_selective_dispatch: 'Confirmar Despacho Selectivo',
                dispatch_entire_pallet: 'Despachar Todo el Pallet',
                stock: 'Stock:',
                edit_pallet_name: 'Editar Nombre',
                rename_pallet: 'Renombrar Pallet',
                update_name: 'Actualizar Nombre',
                pallet_created_success: 'creado exitosamente',
                error_creating_pallet: 'Error al crear el pallet:',
                connection_error: 'Error de conexión:',
                material_added_success: 'Material agregado exitosamente',
                error_adding_material: 'Error al agregar material:',
                dispatch_success: 'Material despachado exitosamente',
                error_dispatching: 'Error al despachar material:',
                pallet_dispatched_complete: 'Pallet despachado completamente',
                pallet_renamed_success: 'Pallet renombrado exitosamente',
                error_renaming_pallet: 'Error al renombrar pallet:',
                new_pallet_click: 'Nuevo pallet - Click para cargar material',
                pallet_drag_manage: 'Arrastra para mover o click para gestionar',
                at: 'a las',
                edit_material: 'Editar Material',
                delete_material: 'Eliminar',
                save_changes: 'Guardar Cambios',
                cancel_edit: 'Cancelar',
                material_updated: 'Material actualizado exitosamente',
                material_deleted: 'Material eliminado exitosamente',
                error_updating_material: 'Error al actualizar material:',
                error_deleting_material: 'Error al eliminar material:',
                confirm_delete_material: '¿Estás seguro de eliminar este material?',
                edit_material_details: 'Editar Detalles del Material'
            },
            en: {
                system_title: 'WorkYard Manager',
                page_title: 'WorkYard Manager - Enterprise',
                connected: 'Connected',
                disconnected: 'Disconnected',
                demo_mode: 'Demo Mode',
                user_1: 'User 1',
                user_2: 'User 2',
                user_3: 'User 3',
                close: 'Close',
                create_new_pallet: '+ Create New Pallet',
                material_search: 'Material Search',
                material_type: 'Material Type',
                circumference: 'Circumference',
                thickness: 'Thickness',
                search_materials: 'Search Materials',
                clear_filters: 'Clear Filters',
                statistics: 'Statistics',
                total_pallets: 'Total pallets:',
                occupied: 'Occupied:',
                search_results: 'Search Results',
                pallet_management: 'Pallet Management',
                view_inventory: 'View Inventory',
                add_material: 'Add Material',
                edit_materials: 'Edit Materials',
                dispatch_material: 'Dispatch Material',
                create_new_pallet_title: 'Create New Pallet',
                pallet_info: 'Pallet Information',
                package_number: 'Package #',
                custom_pallet_name: 'Pallet Name',
                custom_name_placeholder: 'Custom name (optional)',
                material_info: 'Material Information',
                technical_specs: 'Technical Specifications',
                quantity_measures: 'Quantity and Measurements',
                select_or_type_material: 'Select or type material type',
                steel_sheet: 'Steel Sheet',
                strap_band: 'Strap/Band',
                elbow_90_deg: '90° Elbow',
                elbow_45_deg: '45° Elbow',
                pipe: 'Pipe',
                accessory: 'Accessory',
                other: 'Other',
                supplier: 'Supplier',
                supplier_name: 'Supplier name',
                length: 'Length',
                weight: 'Weight',
                weight_optional: 'Weight (optional)',
                quantity_received: 'Quantity Received',
                unit_measure: 'Unit of Measure',
                linear_feet: 'Linear Feet',
                inches: 'Inches',
                pieces: 'Pieces',
                meters: 'Meters',
                kilograms: 'Kilograms',
                tons: 'Tons',
                create_pallet: 'Create Pallet',
                cancel: 'Cancel',
                current_inventory: 'Current Inventory',
                total_units_pallet: 'TOTAL UNITS IN PALLET',
                specifications: 'Specifications:',
                supplier_label: 'Supplier:',
                received: 'Received:',
                not_specified: 'Not specified',
                units: 'units',
                add_material_to_pallet: 'Add Material to Pallet P',
                quantity_to_add: 'Quantity to Add',
                add_material_btn: 'Add Material',
                dispatch_material_from: 'Dispatch Material from Pallet P',
                available_stock: 'Available stock:',
                quantity_to_dispatch: 'Quantity to dispatch:',
                available_units: 'available',
                confirm_selective_dispatch: 'Confirm Selective Dispatch',
                dispatch_entire_pallet: 'Dispatch Entire Pallet',
                stock: 'Stock:',
                edit_pallet_name: 'Edit Name',
                rename_pallet: 'Rename Pallet',
                update_name: 'Update Name',
                pallet_created_success: 'created successfully',
                error_creating_pallet: 'Error creating pallet:',
                connection_error: 'Connection error:',
                material_added_success: 'Material added successfully',
                error_adding_material: 'Error adding material:',
                dispatch_success: 'Material dispatched successfully',
                error_dispatching: 'Error dispatching material:',
                pallet_dispatched_complete: 'Pallet completely dispatched',
                pallet_renamed_success: 'Pallet renamed successfully',
                error_renaming_pallet: 'Error renaming pallet:',
                new_pallet_click: 'New pallet - Click to load material',
                pallet_drag_manage: 'Drag to move or click to manage',
                at: 'at',
                edit_material: 'Edit Material',
                delete_material: 'Delete',
                save_changes: 'Save Changes',
                cancel_edit: 'Cancel',
                material_updated: 'Material updated successfully',
                material_deleted: 'Material deleted successfully',
                error_updating_material: 'Error updating material:',
                error_deleting_material: 'Error deleting material:',
                confirm_delete_material: 'Are you sure you want to delete this material?',
                edit_material_details: 'Edit Material Details'
            }
        };

        let currentLanguage = 'es';

        function t(key) {
            return i18n[currentLanguage][key] || key;
        }

        function changeLanguage() {
            const selector = document.getElementById('language-selector');
            currentLanguage = selector.value;
            
            document.documentElement.lang = currentLanguage;
            document.title = i18n[currentLanguage].page_title;
            
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (i18n[currentLanguage][key]) {
                    if (element.tagName === 'INPUT' && element.type === 'text') {
                        element.placeholder = i18n[currentLanguage][key];
                    } else {
                        element.textContent = i18n[currentLanguage][key];
                    }
                }
            });

            if (window.sistemaInventario && window.sistemaInventario.palletActual) {
                window.sistemaInventario.actualizarNavegacionModal(window.sistemaInventario.palletActual);
                window.sistemaInventario.mostrarSeccion(window.sistemaInventario.seccionActiva);
            }

            if (window.sistemaInventario) {
                window.sistemaInventario.actualizarOpcionesBusqueda();
            }

            console.log('Idioma cambiado a:', currentLanguage);
        }

        const CONFIG = {
            SUPABASE_URL: 'https://iuewoscogzfikwtzjjud.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1ZXdvc2NvZ3pmaWt3dHpqanVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNDQ4NTUsImV4cCI6MjA3MTkyMDg1NX0.WwNqp_zYz2EUqOcvpbsoT42bihKSMM6pmxWe3nJiy1Y',
            POLLING_INTERVAL: 10000,
            PALLET_SIZE: 40
        };

        class SistemaInventario {
            constructor() {
                this.inventario = {};
                this.palletActual = null;
                this.usuarioActual = 'Usuario1';
                this.isOnline = false;
                this.pollingInterval = null;
                this.supabase = null;
                this.seccionActiva = 'inventario';
                
                this.arrastre = {
                    activo: false,
                    palletId: null,
                    elemento: null,
                    offsetX: 0,
                    offsetY: 0,
                    posicionInicial: { x: 0, y: 0 },
                    dragStarted: false,
                    touchStartTime: 0,
                    startX: 0,
                    startY: 0,
                    hasMoved: false
                };
                
                console.log('Sistema enterprise inicializado');
            }

            // Funciones de conversión decimal ↔ fracción
            decimalAFraccion(decimal) {
                if (!decimal || decimal === '') return '';
                
                const num = parseFloat(decimal);
                if (isNaN(num)) return decimal;
                
                const entero = Math.floor(num);
                const fraccionDecimal = num - entero;
                
                // Mapeo de decimales comunes a fracciones Unicode
                const fraccionesComunes = {
                    0.125: '⅛',
                    0.25: '¼',
                    0.375: '⅜',
                    0.5: '½',
                    0.625: '⅝',
                    0.75: '¾',
                    0.875: '⅞'
                };
                
                // Buscar coincidencia exacta con tolerancia pequeña
                for (const [dec, frac] of Object.entries(fraccionesComunes)) {
                    if (Math.abs(fraccionDecimal - parseFloat(dec)) < 0.001) {
                        return entero === 0 ? frac : entero + frac;
                    }
                }
                
                // Si no es una fracción común, devolver el decimal original
                return decimal;
            }

            fraccionADecimal(fraccionTexto) {
                if (!fraccionTexto || fraccionTexto === '') return '';
                
                // Remover comillas si las tiene
                let texto = fraccionTexto.replace(/"/g, '');
                
                // Mapeo de fracciones Unicode a decimales
                const fraccionesUnicode = {
                    '⅛': 0.125,
                    '¼': 0.25,
                    '⅜': 0.375,
                    '½': 0.5,
                    '⅝': 0.625,
                    '¾': 0.75,
                    '⅞': 0.875
                };
                
                // Si es solo una fracción (ej: "½")
                if (fraccionesUnicode[texto]) {
                    return fraccionesUnicode[texto].toString();
                }
                
                // Si tiene parte entera + fracción (ej: "2½")
                let entero = 0;
                let fraccionChar = '';
                
                for (const [frac, val] of Object.entries(fraccionesUnicode)) {
                    if (texto.includes(frac)) {
                        fraccionChar = frac;
                        const parteEntera = texto.replace(frac, '');
                        entero = parteEntera === '' ? 0 : parseInt(parteEntera);
                        break;
                    }
                }
                
                if (fraccionChar !== '') {
                    const resultado = entero + fraccionesUnicode[fraccionChar];
                    return resultado.toString();
                }
                
                // Si no contiene fracciones Unicode, devolver como está
                return texto;
            }

            configurarCampoCircunferencia(inputElement) {
                if (!inputElement) return;
                
                // Configurar evento blur para convertir entrada a fracción
                inputElement.addEventListener('blur', (e) => {
                    const valor = e.target.value.trim();
                    if (valor) {
                        const valorFraccion = this.decimalAFraccion(valor);
                        if (valorFraccion !== valor) {
                            e.target.value = valorFraccion + '"';
                        }
                    }
                });
                
                // Configurar evento focus para facilitar edición
                inputElement.addEventListener('focus', (e) => {
                    const valor = e.target.value.replace(/"/g, '');
                    const valorDecimal = this.fraccionADecimal(valor);
                    e.target.value = valorDecimal;
                });
            }

            async init() {
                try {
                    console.log('Inicializando sistema enterprise...');
                    await this.conectarSupabase();
                    await this.cargarInventarioDesdeDB();
                    this.configurarEventListeners();
                    this.configurarSistemaArrastre();
                    this.configurarSincronizacion();
                    this.configurarRespaldoAutomatico();
                    this.configurarWarehouseResponsivo();
                    this.actualizarEstadisticas();
                    console.log('Sistema enterprise completamente inicializado');
                } catch (error) {
                    console.error('Error crítico en inicialización:', error);
                    this.mostrarNotificacion(t('connection_error') + ' ' + error.message, 'error');
                }
            }

            // === SISTEMA RESPONSIVO ENTERPRISE ===
            
            esMobile() {
                return window.innerWidth <= 768;
            }

            configurarWarehouseResponsivo() {
                const self = this;
                
                // Ajustar al cargar
                this.ajustarWarehouseMobile();
                
                // Ajustar al cambiar orientación/tamaño
                window.addEventListener('resize', function() {
                    setTimeout(() => {
                        self.ajustarWarehouseMobile();
                        self.repositionarPalletsMoviles();
                    }, 100);
                }, { passive: true });
                
                window.addEventListener('orientationchange', function() {
                    setTimeout(() => {
                        self.ajustarWarehouseMobile();
                        self.repositionarPalletsMoviles();
                    }, 300);
                }, { passive: true });
                
                console.log('Sistema responsivo enterprise configurado');
            }

            ajustarWarehouseMobile() {
                const canvas = document.getElementById('warehouse-canvas');
                const warehouse = document.getElementById('warehouse');
                
                if (!canvas || !warehouse) return;
                
                if (this.esMobile()) {
                    // MÓVIL: Ajustar al ancho de pantalla exacto
                    const anchoDisponible = warehouse.clientWidth - 20; // 10px padding cada lado
                    canvas.style.width = anchoDisponible + 'px';
                    canvas.style.minHeight = '1200px';
                    
                    console.log(`Warehouse móvil ajustado: ${anchoDisponible}px de ancho`);
                } else {
                    // DESKTOP: Restaurar tamaño completo
                    canvas.style.width = '3000px';
                    canvas.style.height = '2000px';
                }
            }

            repositionarPalletsMoviles() {
                if (!this.esMobile()) return;
                
                const canvas = document.getElementById('warehouse-canvas');
                const anchoCanvas = canvas.clientWidth;
                
                // Repositionar pallets que están fuera del ancho en móviles
                Object.keys(this.inventario).forEach(palletId => {
                    const datos = this.inventario[palletId];
                    const elemento = document.querySelector(`[data-pallet="${palletId}"]`);
                    
                    if (elemento && datos.posicion.x > anchoCanvas - 50) {
                        // Reposicionar dentro del área visible
                        const nuevaX = Math.max(10, anchoCanvas - 60);
                        elemento.style.left = nuevaX + 'px';
                        
                        // Actualizar posición guardada
                        datos.posicion.x = nuevaX;
                        this.guardarPosicionPallet(palletId, nuevaX, datos.posicion.y);
                        
                        console.log(`Pallet P${palletId} reposicionado para móvil: x=${nuevaX}`);
                    }
                });
            }

            // === SISTEMA DE BÚSQUEDA INTELIGENTE ===
            
            clasificarFamilia(texto) {
                if (!texto) return null;
                
                const textoLimpio = texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                
                if (textoLimpio.includes('lamina') || textoLimpio.includes('plancha') || 
                    textoLimpio.includes('chapa') || textoLimpio.includes('sheet')) {
                    return 'LAMINA';
                }
                
                if (textoLimpio.includes('strap') || textoLimpio.includes('fleje') || 
                    textoLimpio.includes('strapas') || textoLimpio.includes('banda') || 
                    textoLimpio.includes('zuncho')) {
                    return 'FLEJE';
                }
                
                if (textoLimpio.includes('codo') && (textoLimpio.includes('90') || textoLimpio.includes('noventa'))) {
                    return 'CODO90';
                }
                
                if (textoLimpio.includes('codo') && (textoLimpio.includes('45') || textoLimpio.includes('cuarenta'))) {
                    return 'CODO45';
                }
                
                return null;
            }

            normalizarNumero(valor) {
                if (!valor) return null;
                const decimal = this.fraccionADecimal(valor.toString().replace(/"/g, ''));
                return parseFloat(decimal);
            }

            calcularProximidad(valorBuscado, valorMaterial) {
                if (!valorBuscado || !valorMaterial) return 1000;
                const busqueda = this.normalizarNumero(valorBuscado);
                const material = this.normalizarNumero(valorMaterial);
                
                if (!busqueda || !material) return 1000;
                return Math.abs(busqueda - material);
            }

            // === SISTEMA DE RESPALDO AUTOMÁTICO ===
            
            configurarRespaldoAutomatico() {
                if (!this.supabase || !this.isOnline) {
                    console.log('Respaldo automático deshabilitado - sin conexión');
                    return;
                }
                
                // Verificar si ya se hizo respaldo hoy
                this.verificarRespaldoHoy();
                
                // Programar verificación cada hora
                this.respaldoInterval = setInterval(() => {
                    this.verificarRespaldoHoy();
                }, 60 * 60 * 1000); // Cada hora
                
                // Programar limpieza semanal de respaldos antiguos
                this.limpiezaInterval = setInterval(() => {
                    this.limpiarRespaldosAntiguos();
                }, 7 * 24 * 60 * 60 * 1000); // Cada 7 días
                
                console.log('Sistema de respaldo automático configurado');
            }

            async verificarRespaldoHoy() {
                try {
                    const fechaHoy = new Date().toISOString().split('T')[0];
                    
                    // Verificar si existe respaldo de hoy
                    const { data: respaldoExistente, error } = await this.supabase
                        .from('respaldos')
                        .select('id, fecha_respaldo')
                        .eq('fecha_respaldo', fechaHoy)
                        .single();
                    
                    if (error && error.code === 'PGRST116') {
                        // No existe respaldo de hoy - crear uno
                        console.log('No hay respaldo de hoy - creando respaldo automático...');
                        await this.crearRespaldoAutomatico();
                    } else if (!error) {
                        console.log('Respaldo de hoy ya existe:', respaldoExistente.fecha_respaldo);
                    }
                    
                } catch (error) {
                    console.error('Error verificando respaldo diario:', error);
                }
            }

            async crearRespaldoAutomatico() {
                try {
                    const timestamp = new Date();
                    const fecha = timestamp.toISOString().split('T')[0];
                    
                    // Recopilar estadísticas del inventario
                    const totalPallets = Object.keys(this.inventario).length;
                    let totalMateriales = 0;
                    
                    Object.values(this.inventario).forEach(pallet => {
                        totalMateriales += pallet.materiales.length;
                    });
                    
                    // Preparar datos para respaldo
                    const datosRespaldo = {
                        fecha_creacion: timestamp.toISOString(),
                        version_sistema: "1.0",
                        usuario_respaldo: this.usuarioActual,
                        inventario_completo: this.inventario,
                        estadisticas: {
                            total_pallets: totalPallets,
                            total_materiales: totalMateriales,
                            pallets_ocupados: Object.keys(this.inventario).filter(id => this.inventario[id].total > 0).length,
                            pallets_vacios: Object.keys(this.inventario).filter(id => this.inventario[id].total === 0).length
                        }
                    };
                    
                    // Calcular tamaño aproximado en KB
                    const tamañoKB = Math.round(JSON.stringify(datosRespaldo).length / 1024);
                    
                    // Insertar respaldo en Supabase
                    const { data, error } = await this.supabase
                        .from('respaldos')
                        .insert({
                            fecha_respaldo: fecha,
                            hora_respaldo: timestamp.toISOString(),
                            datos_json: datosRespaldo,
                            usuario: this.usuarioActual,
                            total_pallets: totalPallets,
                            total_materiales: totalMateriales,
                            tamaño_kb: tamañoKB,
                            estado: 'completado'
                        })
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    console.log(`Respaldo automático creado: ${fecha} (${tamañoKB} KB, ${totalPallets} pallets, ${totalMateriales} materiales)`);
                    this.mostrarNotificacion(`Respaldo automático completado: ${totalPallets} pallets guardados`, 'success');
                    
                    return data;
                    
                } catch (error) {
                    console.error('Error creando respaldo automático:', error);
                    this.mostrarNotificacion('Error en respaldo automático: ' + error.message, 'error');
                    throw error;
                }
            }

            async limpiarRespaldosAntiguos() {
                try {
                    // Mantener solo respaldos de los últimos 30 días
                    const fechaLimite = new Date();
                    fechaLimite.setDate(fechaLimite.getDate() - 30);
                    const fechaLimiteStr = fechaLimite.toISOString().split('T')[0];
                    
                    const { data, error } = await this.supabase
                        .from('respaldos')
                        .delete()
                        .lt('fecha_respaldo', fechaLimiteStr);
                    
                    if (error) throw error;
                    
                    console.log('Limpieza de respaldos antiguos completada');
                    
                } catch (error) {
                    console.error('Error limpiando respaldos antiguos:', error);
                }
            }

            // === FUNCIONES DE RESTAURACIÓN ===

            async listarRespaldosDisponibles() {
                try {
                    const { data: respaldos, error } = await this.supabase
                        .from('respaldos')
                        .select('id, fecha_respaldo, hora_respaldo, usuario, total_pallets, total_materiales, tamaño_kb')
                        .order('fecha_respaldo', { ascending: false })
                        .limit(30);
                    
                    if (error) throw error;
                    
                    return respaldos || [];
                    
                } catch (error) {
                    console.error('Error listando respaldos:', error);
                    return [];
                }
            }

            async restaurarDesdeRespaldo(respaldoId) {
                try {
                    if (!confirm('¿ADVERTENCIA: Esto reemplazará todos los datos actuales con el respaldo seleccionado. ¿Continuar?')) {
                        return false;
                    }
                    
                    // Obtener datos del respaldo
                    const { data: respaldo, error } = await this.supabase
                        .from('respaldos')
                        .select('datos_json, fecha_respaldo, usuario')
                        .eq('id', respaldoId)
                        .single();
                    
                    if (error) throw error;
                    
                    // Restaurar inventario local
                    this.inventario = respaldo.datos_json.inventario_completo || {};
                    
                    // Renderizar pallets
                    this.renderizarTodosLosPallets();
                    this.actualizarEstadisticas();
                    
                    this.mostrarNotificacion(`Inventario restaurado desde: ${respaldo.fecha_respaldo}`, 'success');
                    console.log(`Restauración completada desde respaldo: ${respaldo.fecha_respaldo} por ${respaldo.usuario}`);
                    
                    return true;
                    
                } catch (error) {
                    console.error('Error restaurando respaldo:', error);
                    this.mostrarNotificacion('Error en restauración: ' + error.message, 'error');
                    return false;
                }
            }

            // === FUNCIONES MANUALES DE RESPALDO ===

            async crearRespaldoManual() {
                try {
                    const resultado = await this.crearRespaldoAutomatico();
                    if (resultado) {
                        this.mostrarNotificacion('Respaldo manual creado exitosamente', 'success');
                    }
                    return resultado;
                } catch (error) {
                    this.mostrarNotificacion('Error creando respaldo manual: ' + error.message, 'error');
                    throw error;
                }
            }

            async mostrarGestionRespaldos() {
                try {
                    const respaldos = await this.listarRespaldosDisponibles();
                    
                    let html = `
                        <div class="form-section">
                            <h4>Gestión de Respaldos</h4>
                            
                            <div class="button-group" style="justify-content: flex-start; margin-bottom: 20px;">
                                <button class="action-button primary" onclick="window.sistemaInventario.crearRespaldoManual()">
                                    Crear Respaldo Manual
                                </button>
                            </div>
                            
                            <h5>Respaldos Disponibles (últimos 30 días):</h5>
                            <div style="max-height: 400px; overflow-y: auto;" class="scrollable-area">
                    `;
                    
                    if (respaldos.length === 0) {
                        html += '<p style="color: var(--grey); text-align: center; padding: 20px;">No hay respaldos disponibles</p>';
                    } else {
                        respaldos.forEach(respaldo => {
                            html += `
                                <div class="material-card">
                                    <div class="material-header">
                                        <div>
                                            <div class="material-title">Respaldo ${respaldo.fecha_respaldo}</div>
                                            <div class="material-specs">
                                                Hora: ${new Date(respaldo.hora_respaldo).toLocaleString()}<br>
                                                Usuario: ${respaldo.usuario}<br>
                                                Pallets: ${respaldo.total_pallets}, Materiales: ${respaldo.total_materiales}<br>
                                                Tamaño: ${respaldo.tamaño_kb} KB
                                            </div>
                                        </div>
                                        <div>
                                            <button class="action-button secondary" style="min-width: auto; padding: 8px 16px; font-size: 14px;" onclick="window.sistemaInventario.restaurarDesdeRespaldo(${respaldo.id})">
                                                Restaurar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    const modal = document.getElementById('modal');
                    const title = document.getElementById('modal-title');
                    const content = document.getElementById('modal-content');
                    const nav = document.getElementById('section-nav');
                    
                    title.textContent = 'Gestión de Respaldos';
                    nav.style.display = 'none';
                    content.innerHTML = html;
                    
                    modal.classList.add('active');
                    
                } catch (error) {
                    console.error('Error mostrando gestión de respaldos:', error);
                    this.mostrarNotificacion('Error cargando respaldos: ' + error.message, 'error');
                }
            }

            async conectarSupabase() {
                try {
                    console.log('Conectando a Supabase...');
                    
                    if (!window.supabase) {
                        throw new Error('Supabase SDK no disponible');
                    }
                    
                    this.supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                    
                    const { data, error, count } = await this.supabase
                        .from('pallets')
                        .select('*', { count: 'exact', head: true });

                    if (error) throw error;
                    
                    this.isOnline = true;
                    this.actualizarEstadoConexion('connected');
                    console.log('Conectado exitosamente - ' + (count || 0) + ' pallets en base de datos');
                    
                } catch (error) {
                    console.error('Error de conexión - activando modo offline:', error);
                    this.isOnline = false;
                    this.actualizarEstadoConexion('demo_mode');
                    this.mostrarNotificacion('Modo offline activado - funcionalidad limitada', 'warning');
                    this.activarModoDemo();
                }
            }

            activarModoDemo() {
                console.log('Activando modo demo...');
                
                this.inventario = {
                    '1': {
                        materiales: [{
                            id: 'demo1',
                            tipo: 'Lamina',
                            circunferencia: '12',
                            espesor: '1.5',
                            cantidad: 150,
                            unidad: 'pies lineales',
                            proveedor: 'Proveedor Demo',
                            descripcion: 'Lámina - 12″ ⌀ × 1.5″',
                            fecha: new Date().toISOString()
                        }],
                        total: 150,
                        created: new Date().toISOString(),
                        posicion: { x: 100, y: 100 },
                        paqueteNumero: 'PAQ-001',
                        nombrePersonalizado: 'Láminas Norte'
                    },
                    '2': {
                        materiales: [{
                            id: 'demo2',
                            tipo: 'Strap',
                            circunferencia: '8',
                            espesor: '2',
                            cantidad: 75,
                            unidad: 'piezas',
                            proveedor: 'Proveedor Demo 2',
                            descripcion: 'Strap - 8″ ⌀ × 2″',
                            fecha: new Date().toISOString()
                        }],
                        total: 75,
                        created: new Date().toISOString(),
                        posicion: { x: 200, y: 150 },
                        paqueteNumero: 'PAQ-002',
                        nombrePersonalizado: null
                    }
                };
                
                this.renderizarPalletsVisuales();
                this.actualizarEstadisticas();
                console.log('Modo demo activado con pallets de ejemplo');
            }

            configurarEventListeners() {
                const btnCrear = document.getElementById('btn-crear-pallet');
                const languageSelector = document.getElementById('language-selector');
                const userSelector = document.getElementById('usuario-selector');
                const btnBuscar = document.getElementById('btn-buscar');
                const btnLimpiar = document.getElementById('btn-limpiar');
                const btnCerrarModal = document.getElementById('btn-cerrar-modal');
                const btnResetear = document.getElementById('btn-resetear');
                const btnProbar = document.getElementById('btn-probar');
                const btnRespaldos = document.getElementById('btn-respaldos');
                
                if (btnCrear) {
                    btnCrear.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.crearNuevoPallet();
                    });
                }
                
                if (languageSelector) {
                    languageSelector.addEventListener('change', changeLanguage);
                }
                
                if (userSelector) {
                    userSelector.addEventListener('change', () => {
                        this.usuarioActual = userSelector.value;
                        console.log('Usuario cambiado a:', userSelector.value);
                    });
                }

                if (btnBuscar) {
                    btnBuscar.addEventListener('click', () => this.buscarMateriales());
                }

                if (btnLimpiar) {
                    btnLimpiar.addEventListener('click', () => this.limpiarBusqueda());
                }

                if (btnCerrarModal) {
                    btnCerrarModal.addEventListener('click', () => this.cerrarModal());
                }

                if (btnResetear) {
                    btnResetear.addEventListener('click', () => this.resetearSistema());
                }

                if (btnProbar) {
                    btnProbar.addEventListener('click', () => this.probarConexion());
                }

                if (btnRespaldos) {
                    btnRespaldos.addEventListener('click', () => this.mostrarGestionRespaldos());
                }

                // Configurar tabs del modal
                const tabInventario = document.getElementById('tab-inventario');
                const tabAgregar = document.getElementById('tab-agregar');
                const tabEditar = document.getElementById('tab-editar');
                const tabDespachar = document.getElementById('tab-despachar');

                if (tabInventario) {
                    tabInventario.addEventListener('click', () => this.mostrarSeccion('inventario'));
                }
                if (tabAgregar) {
                    tabAgregar.addEventListener('click', () => this.mostrarSeccion('agregar'));
                }
                if (tabEditar) {
                    tabEditar.addEventListener('click', () => this.mostrarSeccion('editar'));
                }
                if (tabDespachar) {
                    tabDespachar.addEventListener('click', () => this.mostrarSeccion('despachar'));
                }
                
                console.log('Event listeners configurados correctamente');
            }

            configurarSistemaArrastre() {
                const self = this;
                
                // Arrastre con mouse - solo pallets
                document.addEventListener('mousemove', function(e) {
                    if (self.arrastre.activo && self.arrastre.dragStarted) {
                        self.procesarMovimiento(e.clientX, e.clientY);
                    }
                }, { passive: true });
                
                document.addEventListener('mouseup', function(e) {
                    if (self.arrastre.activo) {
                        self.finalizarArrastre();
                    }
                }, { passive: true });

                // Touch optimizado solo para pallets
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        const element = document.elementFromPoint(touch.clientX, touch.clientY);
                        
                        if (element && element.classList.contains('pallet') && !element.classList.contains('temporal')) {
                            // Solo arrastre de pallets
                            self.arrastre.startX = touch.clientX;
                            self.arrastre.startY = touch.clientY;
                            self.arrastre.touchStartTime = Date.now();
                            self.arrastre.potentialElement = element;
                            self.arrastre.potentialPalletId = element.dataset.pallet;
                            self.arrastre.dragStarted = false;
                            self.arrastre.hasMoved = false;
                        }
                    }
                }, { passive: true });
                
                document.addEventListener('touchmove', function(e) {
                    if (e.touches.length === 1 && self.arrastre.potentialElement) {
                        const touch = e.touches[0];
                        const deltaX = Math.abs(touch.clientX - self.arrastre.startX);
                        const deltaY = Math.abs(touch.clientY - self.arrastre.startY);
                        const totalMovement = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                        
                        if (totalMovement > 8 && !self.arrastre.dragStarted) {
                            e.preventDefault();
                            self.arrastre.dragStarted = true;
                            self.arrastre.hasMoved = true;
                            self.iniciarArrastre(
                                self.arrastre.potentialElement, 
                                self.arrastre.potentialPalletId, 
                                touch.clientX, 
                                touch.clientY
                            );
                        } else if (self.arrastre.dragStarted) {
                            e.preventDefault();
                            self.arrastre.hasMoved = true;
                            self.procesarMovimiento(touch.clientX, touch.clientY);
                        }
                    }
                }, { passive: false });
                
                document.addEventListener('touchend', function(e) {
                    if (self.arrastre.dragStarted) {
                        self.finalizarArrastre();
                    } else if (self.arrastre.potentialElement && !self.arrastre.hasMoved) {
                        const timeDelta = Date.now() - self.arrastre.touchStartTime;
                        if (timeDelta < 250) {
                            self.abrirModalGestion(self.arrastre.potentialPalletId);
                        }
                    }
                    
                    if (e.touches.length === 0) {
                        self.cancelarEstados();
                    }
                }, { passive: true });
                
                console.log('Sistema enterprise: arrastre optimizado configurado');
            }

            cancelarEstados() {
                this.arrastre.potentialElement = null;
                this.arrastre.potentialPalletId = null;
                this.arrastre.dragStarted = false;
                this.arrastre.hasMoved = false;
            }

            iniciarArrastre(elemento, palletId, clientX, clientY) {
                if (palletId === 'temporal') return false;
                
                const canvas = document.getElementById('warehouse-canvas');
                const warehouse = document.getElementById('warehouse');
                const canvasRect = canvas.getBoundingClientRect();
                const elementRect = elemento.getBoundingClientRect();
                
                this.arrastre = {
                    ...this.arrastre,
                    activo: true,
                    palletId: palletId,
                    elemento: elemento,
                    offsetX: clientX - elementRect.left,
                    offsetY: clientY - elementRect.top,
                    posicionInicial: {
                        x: parseInt(elemento.style.left) || 0,
                        y: parseInt(elemento.style.top) || 0
                    },
                    dragStarted: true
                };
                
                elemento.classList.add('dragging');
                document.body.style.cursor = 'grabbing';
                elemento.style.zIndex = '1000';
                
                console.log('Arrastre iniciado para pallet P' + palletId);
                return true;
            }

            procesarMovimiento(clientX, clientY) {
                if (!this.arrastre.activo || !this.arrastre.dragStarted) return;
                
                const canvas = document.getElementById('warehouse-canvas');
                const warehouse = document.getElementById('warehouse');
                const warehouseRect = warehouse.getBoundingClientRect();
                
                // Calcular posición relativa al canvas, considerando el scroll del warehouse
                const scrollX = warehouse.scrollLeft;
                const scrollY = warehouse.scrollTop;
                
                const newX = clientX - warehouseRect.left + scrollX - this.arrastre.offsetX;
                const newY = clientY - warehouseRect.top + scrollY - this.arrastre.offsetY;
                
                // Límites dinámicos según dispositivo
                let limitedX, limitedY;
                
                if (this.esMobile()) {
                    // En móviles: limitar al ancho de pantalla disponible
                    const anchoDisponible = canvas.clientWidth;
                    limitedX = Math.max(10, Math.min(newX, anchoDisponible - 50));
                    limitedY = Math.max(10, newY); // Sin límite superior en móviles
                } else {
                    // En desktop: límites del canvas completo
                    limitedX = Math.max(10, Math.min(newX, canvas.offsetWidth - 50));
                    limitedY = Math.max(10, Math.min(newY, canvas.offsetHeight - 50));
                }
                
                this.arrastre.elemento.style.left = limitedX + 'px';
                this.arrastre.elemento.style.top = limitedY + 'px';
            }

            async finalizarArrastre() {
                if (!this.arrastre.activo || !this.arrastre.dragStarted) return;
                
                try {
                    this.arrastre.elemento.classList.remove('dragging');
                    document.body.style.cursor = '';
                    
                    const posicionFinal = {
                        x: parseInt(this.arrastre.elemento.style.left),
                        y: parseInt(this.arrastre.elemento.style.top)
                    };
                    
                    const distancia = Math.sqrt(
                        Math.pow(posicionFinal.x - this.arrastre.posicionInicial.x, 2) +
                        Math.pow(posicionFinal.y - this.arrastre.posicionInicial.y, 2)
                    );
                    
                    if (distancia > 15) {
                        await this.guardarPosicionPallet(this.arrastre.palletId, posicionFinal.x, posicionFinal.y);
                        console.log('Pallet P' + this.arrastre.palletId + ' reubicado a (' + posicionFinal.x + ', ' + posicionFinal.y + ')');
                    } else {
                        this.abrirModalGestion(this.arrastre.palletId);
                    }
                    
                } catch (error) {
                    console.error('Error finalizando arrastre:', error);
                } finally {
                    this.arrastre = {
                        activo: false,
                        palletId: null,
                        elemento: null,
                        offsetX: 0,
                        offsetY: 0,
                        posicionInicial: { x: 0, y: 0 },
                        dragStarted: false,
                        touchStartTime: 0,
                        startX: 0,
                        startY: 0,
                        potentialElement: null,
                        potentialPalletId: null,
                        hasMoved: false
                    };
                }
            }
async guardarPosicionPallet(palletId, x, y) {
                try {
                    if (!this.supabase || !this.isOnline) {
                        if (this.inventario[palletId]) {
                            this.inventario[palletId].posicion = { x: Math.round(x), y: Math.round(y) };
                        }
                        return;
                    }
                    
                    const { error } = await this.supabase
                        .from('pallets')
                        .update({
                            posicion_x: Math.round(x),
                            posicion_y: Math.round(y)
                        })
                        .eq('numero', parseInt(palletId));
                    
                    if (error) throw error;
                    
                    if (this.inventario[palletId]) {
                        this.inventario[palletId].posicion = { x: Math.round(x), y: Math.round(y) };
                    }
                    
                } catch (error) {
                    console.error('Error guardando posición:', error);
                }
            }

            async cargarInventarioDesdeDB() {
                try {
                    if (!this.supabase || !this.isOnline) return;

                    // PASO 1: Cargar TODOS los pallets existentes (incluso vacíos)
                    const { data: todosLosPallets, error: errorPallets } = await this.supabase
                        .from('pallets')
                        .select('numero, posicion_x, posicion_y, created_at, paquete_numero, nombre_personalizado')
                        .order('numero', { ascending: true });

                    if (errorPallets) throw errorPallets;

                    // PASO 2: Cargar materiales activos
                    const { data: materiales, error: errorMateriales } = await this.supabase
                        .from('materiales')
                        .select('*, pallets!inner (numero)')
                        .eq('activo', true)
                        .order('fecha_recepcion', { ascending: false });

                    if (errorMateriales) throw errorMateriales;

                    this.inventario = {};

                    // PASO 3: Crear entrada para TODOS los pallets
                    if (todosLosPallets && todosLosPallets.length > 0) {
                        todosLosPallets.forEach(pallet => {
                            this.inventario[pallet.numero] = {
                                materiales: [],
                                total: 0,
                                created: pallet.created_at,
                                posicion: {
                                    x: pallet.posicion_x || 50,
                                    y: pallet.posicion_y || 50
                                },
                                paqueteNumero: pallet.paquete_numero,
                                nombrePersonalizado: pallet.nombre_personalizado
                            };
                        });
                    }

                    // PASO 4: Agregar materiales a sus respectivos pallets
                    if (materiales && materiales.length > 0) {
                        materiales.forEach(material => {
                            const palletNum = material.pallets.numero;
                            
                            if (this.inventario[palletNum]) {
                                this.inventario[palletNum].materiales.push({
                                    id: material.id,
                                    tipo: material.tipo,
                                    circunferencia: material.circunferencia,
                                    espesor: material.espesor,
                                    descripcion: material.descripcion_completa,
                                    cantidad: material.cantidad,
                                    unidad: material.unidad,
                                    proveedor: material.proveedor,
                                    fecha: material.fecha_recepcion
                                });
                            }
                        });
                    }

                    // PASO 5: Calcular totales y renderizar TODOS los pallets
                    Object.keys(this.inventario).forEach(palletNum => {
                        const datos = this.inventario[palletNum];
                        datos.total = datos.materiales.reduce((sum, m) => sum + m.cantidad, 0);
                    });

                    this.renderizarTodosLosPallets();
                    this.actualizarOpcionesBusqueda();
                    
                    console.log('TODOS los pallets cargados:', todosLosPallets?.length || 0, 'pallets totales');
                    console.log('Con materiales activos:', (materiales?.length || 0), 'materiales');
                    console.log('Números ocupados:', Object.keys(this.inventario).sort((a,b) => parseInt(a) - parseInt(b)));

                } catch (error) {
                    console.error('Error cargando inventario completo:', error);
                }
            }

            renderizarTodosLosPallets() {
                const canvas = document.getElementById('warehouse-canvas');
                if (!canvas) return;

                canvas.innerHTML = '';
                const self = this;

                // Ajustar canvas para móviles antes de renderizar
                this.ajustarWarehouseMobile();

                Object.keys(this.inventario).forEach(function(palletId) {
                    const datos = self.inventario[palletId];
                    
                    // Renderizar TODOS los pallets - con inventario Y vacíos
                    if (datos.total > 0) {
                        // Pallets con inventario - color normal
                        self.crearPalletVisual(palletId, datos.posicion.x, datos.posicion.y, 'occupied');
                    } else {
                        // Pallets vacíos - color diferente para identificarlos
                        self.crearPalletVisual(palletId, datos.posicion.x, datos.posicion.y, 'empty');
                    }
                });

                // Reposicionar pallets para móviles después de renderizar
                setTimeout(() => {
                    this.repositionarPalletsMoviles();
                }, 100);

                console.log('TODOS los pallets renderizados:', Object.keys(this.inventario).length);
                console.log('Números ocupados:', Object.keys(this.inventario).sort((a,b) => parseInt(a) - parseInt(b)));
            }

            crearPalletVisual(palletId, x, y, tipo) {
                const canvas = document.getElementById('warehouse-canvas');
                if (!canvas) return;
                
                const safeX = Math.max(10, Math.min(x, canvas.offsetWidth - 50));
                const safeY = Math.max(10, Math.min(y, canvas.offsetHeight - 50));

                const pallet = document.createElement('div');
                pallet.className = 'pallet ' + tipo;
                pallet.dataset.pallet = palletId;
                pallet.style.left = safeX + 'px';
                pallet.style.top = safeY + 'px';
                
                // Configurar contenido del pallet
                if (tipo === 'temporal') {
                    pallet.textContent = '?';
                    pallet.title = t('new_pallet_click');
                } else {
                    // Obtener datos del pallet para mostrar número de paquete si existe
                    const datospallet = this.inventario[palletId];
                    const paqueteNumero = datospallet?.paqueteNumero;
                    
                    if (paqueteNumero) {
                        // Mostrar número de pallet + número de paquete
                        pallet.innerHTML = `
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1;">
                                <div style="font-size: 14px; font-weight: 700;">${palletId}</div>
                                <div style="font-size: 7px; font-weight: 500; opacity: 0.9; margin-top: -2px;">${paqueteNumero}</div>
                            </div>
                        `;
                    } else {
                        // Solo mostrar número de pallet
                        pallet.textContent = palletId;
                    }
                    
                    if (tipo === 'empty') {
                        pallet.title = 'Pallet P' + palletId + (paqueteNumero ? ` (${paqueteNumero})` : '') + ' - VACÍO (Click para gestionar o eliminar)';
                    } else {
                        pallet.title = 'Pallet P' + palletId + (paqueteNumero ? ` (${paqueteNumero})` : '') + ' - ' + t('pallet_drag_manage');
                    }
                }

                const self = this;
                
                pallet.addEventListener('click', function(e) {
                    if (!self.arrastre.dragStarted) {
                        e.stopPropagation();
                        if (tipo === 'temporal') {
                            self.abrirModalCreacion(safeX, safeY);
                        } else if (tipo === 'empty') {
                            self.abrirModalPalletVacio(palletId);
                        } else {
                            self.abrirModalGestion(palletId);
                        }
                    }
                }, { passive: false });

                if (tipo !== 'temporal') {
                    pallet.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        self.iniciarArrastre(pallet, palletId, e.clientX, e.clientY);
                    }, { passive: false });
                }

                canvas.appendChild(pallet);
                return pallet;
            }

            async crearNuevoPallet() {
                try {
                    console.log('Ejecutando crearNuevoPallet...');
                    const warehouse = document.getElementById('warehouse');
                    const warehouseRect = warehouse.getBoundingClientRect();
                    
                    const centroX = (warehouseRect.width / 2) - 20;
                    const centroY = (warehouseRect.height / 3) - 20;

                    this.crearPalletVisual('temporal', centroX, centroY, 'temporal');
                    
                    setTimeout(() => {
                        this.abrirModalCreacion(centroX, centroY);
                    }, 200);
                    
                } catch (error) {
                    console.error('Error creando pallet:', error);
                    this.mostrarNotificacion('Error al crear pallet temporal', 'error');
                }
            }

            abrirModalCreacion(posX, posY) {
                const modal = document.getElementById('modal');
                const title = document.getElementById('modal-title');
                const content = document.getElementById('modal-content');
                const nav = document.getElementById('section-nav');
                
                title.textContent = t('create_new_pallet_title');
                nav.style.display = 'none';
                
                content.innerHTML = `
                    <div class="form-section">
                        <h4>${t('pallet_info')}</h4>
                        <div class="form-grid cols-3">
                            <div class="form-group">
                                <label>Número de Pallet</label>
                                <input type="number" id="numero-pallet-nuevo" placeholder="Auto" min="1">
                                <small style="color: var(--grey); font-size: 12px;">Déjalo vacío para auto-asignar</small>
                            </div>
                            <div class="form-group">
                                <label>${t('package_number')}</label>
                                <input type="text" id="paquete-numero-nuevo" placeholder="PAQ-001" required>
                            </div>
                            <div class="form-group">
                                <label>${t('custom_pallet_name')}</label>
                                <input type="text" id="nombre-pallet-nuevo" placeholder="${t('custom_name_placeholder')}">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>${t('material_info')}</h4>
                        <div class="form-grid cols-2">
                            <div class="form-group">
                                <label>${t('material_type')}</label>
                                <input type="text" id="tipo-material-nuevo" placeholder="${t('select_or_type_material')}" required>
                            </div>
                            <div class="form-group">
                                <label>${t('supplier')}</label>
                                <input type="text" id="proveedor-nuevo" placeholder="${t('supplier_name')}" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>${t('technical_specs')}</h4>
                        <div class="form-grid cols-4">
                            <div class="form-group">
                                <label>${t('circumference')}</label>
                                <input type="text" id="circunferencia-nuevo" placeholder="12.0&quot;" required>
                            </div>
                            <div class="form-group">
                                <label>${t('thickness')}</label>
                                <input type="text" id="espesor-nuevo" placeholder="1.5&quot;" required>
                            </div>
                            <div class="form-group">
                                <label>${t('length')}</label>
                                <input type="text" id="longitud-nuevo" placeholder="20 pies">
                            </div>
                            <div class="form-group">
                                <label>${t('weight_optional')}</label>
                                <input type="text" id="peso-nuevo" placeholder="500 kg">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>${t('quantity_measures')}</h4>
                        <div class="form-grid cols-2">
                            <div class="form-group">
                                <label>${t('quantity_received')}</label>
                                <input type="number" id="cantidad-nuevo" placeholder="100" required min="1" step="1">
                            </div>
                            <div class="form-group">
                                <label>${t('unit_measure')}</label>
                                <select id="unidad-nuevo" required>
                                    <option value="pies lineales">${t('linear_feet')}</option>
                                    <option value="piezas">${t('pieces')}</option>
                                    <option value="metros">${t('meters')}</option>
                                    <option value="kilogramos">${t('kilograms')}</option>
                                    <option value="toneladas">${t('tons')}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="action-button success" id="btn-crear-final">
                            ${t('create_pallet')}
                        </button>
                        <button class="action-button secondary" id="btn-cancelar">
                            ${t('cancel')}
                        </button>
                    </div>
                `;

                document.getElementById('btn-crear-final').addEventListener('click', () => {
                    this.procesarCreacionPallet(posX, posY);
                });

                document.getElementById('btn-cancelar').addEventListener('click', () => {
                    this.cancelarCreacion();
                });

                // Configurar campo de circunferencia para conversión fraccionaria
                this.configurarCampoCircunferencia(document.getElementById('circunferencia-nuevo'));
                
                modal.classList.add('active');
            }

            abrirModalGestion(palletId) {
                const modal = document.getElementById('modal');
                const title = document.getElementById('modal-title');
                const nav = document.getElementById('section-nav');
                
                this.palletActual = palletId;
                title.textContent = t('pallet_management') + ' P' + palletId;
                nav.style.display = 'flex';
                
                this.actualizarNavegacionModal(palletId);
                this.mostrarSeccion('inventario');
                
                modal.classList.add('active');
            }

            actualizarNavegacionModal(palletId) {
                const datos = this.inventario[palletId];
                const tabs = document.querySelectorAll('.nav-tab');
                
                if (tabs[0]) tabs[0].textContent = t('view_inventory') + ' (' + datos.total + ')';
                if (tabs[1]) tabs[1].textContent = t('add_material');
                if (tabs[2]) tabs[2].textContent = t('edit_materials') + ' (' + datos.materiales.length + ')';
                if (tabs[3]) tabs[3].textContent = t('dispatch_material');
            }

            mostrarSeccion(seccion) {
                this.seccionActiva = seccion;
                
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                
                const content = document.getElementById('modal-content');
                const datos = this.inventario[this.palletActual];
                
                switch(seccion) {
                    case 'inventario':
                        if (document.querySelectorAll('.nav-tab')[0]) {
                            document.querySelectorAll('.nav-tab')[0].classList.add('active');
                        }
                        content.innerHTML = this.generarVistaInventario(datos);
                        break;
                    case 'agregar':
                        if (document.querySelectorAll('.nav-tab')[1]) {
                            document.querySelectorAll('.nav-tab')[1].classList.add('active');
                        }
                        content.innerHTML = this.generarVistaAgregar();
                        this.configurarEventListenersAgregar();
                        break;
                    case 'editar':
                        if (document.querySelectorAll('.nav-tab')[2]) {
                            document.querySelectorAll('.nav-tab')[2].classList.add('active');
                        }
                        content.innerHTML = this.generarVistaEditar(datos);
                        break;
                    case 'despachar':
                        if (document.querySelectorAll('.nav-tab')[3]) {
                            document.querySelectorAll('.nav-tab')[3].classList.add('active');
                        }
                        content.innerHTML = this.generarVistaDespachar(datos);
                        this.configurarEventListenersDespachar();
                        break;
                    case 'renombrar':
                        content.innerHTML = this.generarVistaRenombrar(datos);
                        this.configurarEventListenersRenombrar();
                        break;
                }
            }

            generarVistaInventario(datos) {
                const palletInfo = datos.paqueteNumero || datos.nombrePersonalizado ? `
                    <div style="background: var(--white); border: 1px solid var(--medium-grey); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <h4 style="color: var(--onyx); margin-bottom: 16px; font-size: 18px;">${t('pallet_info')}</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            ${datos.paqueteNumero ? `
                                <div>
                                    <label style="font-size: 12px; color: var(--grey); font-weight: 600;">${t('package_number')}</label>
                                    <div style="font-size: 16px; font-weight: 700; color: var(--onyx);">${datos.paqueteNumero}</div>
                                </div>
                            ` : ''}
                            ${datos.nombrePersonalizado ? `
                                <div>
                                    <label style="font-size: 12px; color: var(--grey); font-weight: 600;">${t('custom_pallet_name')}</label>
                                    <div style="font-size: 16px; font-weight: 700; color: var(--onyx);">${datos.nombrePersonalizado}</div>
                                </div>
                            ` : ''}
                            <div>
                                <button class="action-button secondary" style="min-width: auto; height: 40px; padding: 8px 16px; font-size: 14px;" id="btn-editar-nombre">
                                    ${t('edit_pallet_name')}
                                </button>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div style="background: var(--light-grey); border: 1px solid var(--medium-grey); border-radius: 12px; padding: 20px; margin-bottom: 24px; text-align: center;">
                        <button class="action-button secondary" style="min-width: auto; height: 40px; padding: 8px 16px; font-size: 14px;" id="btn-editar-nombre">
                            ${t('edit_pallet_name')}
                        </button>
                    </div>
                `;

                const materialesHTML = datos.materiales.map(item => {
                    const fecha = new Date(item.fecha);
                    return `
                        <div class="material-card">
                            <div class="material-header">
                                <div>
                                    <div class="material-title">${item.descripcion || item.tipo}</div>
                                    <div class="material-specs">
                                        ${t('specifications')} ${item.circunferencia ? item.circunferencia + '″ ⌀' : ''} 
                                        ${item.espesor ? ' × ' + item.espesor + '″ ' + t('thickness').toLowerCase() : ''}<br>
                                        ${t('supplier_label')} ${item.proveedor || t('not_specified')}<br>
                                        ${t('received')} ${fecha.toLocaleDateString()} ${t('at')} ${fecha.toLocaleTimeString()}
                                    </div>
                                </div>
                                <div class="quantity-badge">${item.cantidad} ${item.unidad || t('units')}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                const result = `
                    <div class="form-section">
                        <h4>${t('current_inventory')}</h4>
                        
                        ${palletInfo}
                        
                        <div style="background: var(--light-grey); padding: 20px; border-radius: 12px; margin-bottom: 24px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 800; color: var(--crimson); margin-bottom: 8px;">${datos.total}</div>
                            <div style="font-size: 14px; color: var(--grey); font-weight: 600;">${t('total_units_pallet')}</div>
                        </div>
                        <div class="scrollable-area" style="max-height: 400px;">
                            ${materialesHTML}
                        </div>
                    </div>
                `;

                setTimeout(() => {
                    const btnEditarNombre = document.getElementById('btn-editar-nombre');
                    if (btnEditarNombre) {
                        btnEditarNombre.addEventListener('click', () => this.mostrarSeccion('renombrar'));
                    }
                }, 100);

                return result;
            }

            generarVistaAgregar() {
                return `
                    <div class="form-section">
                        <h4>${t('add_material_to_pallet')}${this.palletActual}</h4>
                        
                        <div class="form-section">
                            <h4>${t('material_info')}</h4>
                            <div class="form-grid cols-2">
                                <div class="form-group">
                                    <label>${t('material_type')}</label>
                                    <input type="text" id="tipo-agregar" placeholder="${t('select_or_type_material')}" required>
                                </div>
                                <div class="form-group">
                                    <label>${t('supplier')}</label>
                                    <input type="text" id="proveedor-agregar" placeholder="${t('supplier_name')}" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>${t('technical_specs')}</h4>
                            <div class="form-grid cols-4">
                                <div class="form-group">
                                    <label>${t('circumference')}</label>
                                    <input type="text" id="circunferencia-agregar" placeholder="12″ o 12×8″">
                                    <small style="color: var(--grey); font-size: 12px;">Ej: 12″, 12×8″, 12 x 8″</small>
                                </div>
                                <div class="form-group">
                                    <label>${t('thickness')}</label>
                                    <input type="text" id="espesor-agregar" placeholder="1.5&quot;">
                                </div>
                                <div class="form-group">
                                    <label>${t('length')}</label>
                                    <input type="text" id="longitud-agregar" placeholder="20 pies">
                                </div>
                                <div class="form-group">
                                    <label>${t('weight_optional')}</label>
                                    <input type="text" id="peso-agregar" placeholder="500 kg">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>${t('quantity_measures')}</h4>
                            <div class="form-grid cols-2">
                                <div class="form-group">
                                    <label>${t('quantity_to_add')}</label>
                                    <input type="number" id="cantidad-agregar" placeholder="100" required min="1" step="1">
                                </div>
                                <div class="form-group">
                                    <label>${t('unit_measure')}</label>
                                    <select id="unidad-agregar" required>
                                        <option value="pies lineales">${t('linear_feet')}</option>
                                        <option value="pulgadas">${t('inches')}</option>
                                        <option value="piezas">${t('pieces')}</option>
                                        <option value="metros">${t('meters')}</option>
                                        <option value="kilogramos">${t('kilograms')}</option>
                                        <option value="toneladas">${t('tons')}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="action-button success" id="btn-agregar-material">
                                ${t('add_material_btn')}
                            </button>
                            <button class="action-button danger" id="btn-eliminar-pallet">
                                Eliminar Pallet
                            </button>
                        </div>
                    </div>
                `;
            }

            generarVistaEditar(datos) {
                const materialesHTML = datos.materiales.map((item, index) => {
                    const fecha = new Date(item.fecha);
                    const materialId = item.id || `temp_${index}`;
                    return `
                        <div class="material-card" id="material-${materialId}">
                            <div class="material-header">
                                <div>
                                    <div class="material-title">${item.descripcion || item.tipo}</div>
                                    <div class="material-specs">
                                        ${t('specifications')} ${item.circunferencia ? item.circunferencia + '″ ⌀' : ''} 
                                        ${item.espesor ? ' × ' + item.espesor + '″ ' + t('thickness').toLowerCase() : ''}<br>
                                        ${t('supplier_label')} ${item.proveedor || t('not_specified')}<br>
                                        ${t('received')} ${fecha.toLocaleDateString()}
                                    </div>
                                </div>
                                <div class="quantity-badge">${item.cantidad} ${item.unidad || t('units')}</div>
                            </div>
                            <div class="dispatch-controls">
                                <div class="button-group" style="margin: 0; gap: 8px; justify-content: flex-start;">
                                    <button class="action-button secondary" style="min-width: auto; height: 36px; padding: 8px 12px; font-size: 14px;" data-material-index="${index}" onclick="window.sistemaInventario.editarMaterialPorIndice(${index})">
                                        ${t('edit_material')}
                                    </button>
                                    <button class="action-button danger" style="min-width: auto; height: 36px; padding: 8px 12px; font-size: 14px;" data-material-index="${index}" onclick="window.sistemaInventario.eliminarMaterialPorIndice(${index})">
                                        ${t('delete_material')}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="form-section">
                        <h4>${t('edit_materials')} - Pallet P${this.palletActual}</h4>
                        <div class="scrollable-area" style="max-height: 500px;">
                            ${materialesHTML}
                        </div>
                    </div>
                `;
            }

            generarVistaDespachar(datos) {
                const materialesHTML = datos.materiales.map(item => {
                    const fecha = new Date(item.fecha);
                    return `
                        <div class="material-card">
                            <div class="material-header">
                                <div>
                                    <div class="material-title">${item.descripcion || item.tipo}</div>
                                    <div class="material-specs">
                                        ${t('available_stock')} <strong>${item.cantidad} ${item.unidad || t('units')}</strong><br>
                                        ${t('supplier_label')} ${item.proveedor || t('not_specified')}<br>
                                        ${t('received')} ${fecha.toLocaleDateString()}
                                    </div>
                                </div>
                                <div class="quantity-badge">${t('stock')}: ${item.cantidad}</div>
                            </div>
                            <div class="dispatch-controls">
                                <div class="dispatch-row">
                                    <label style="font-weight: 600; color: var(--onyx); min-width: 150px;">${t('quantity_to_dispatch')}:</label>
                                    <input type="number" id="despachar-${item.id}" class="dispatch-input" 
                                           min="0" max="${item.cantidad}" placeholder="0">
                                    <span style="color: var(--grey); font-weight: 500;">de ${item.cantidad} ${t('available_units')}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="form-section">
                        <h4>${t('dispatch_material_from')}${this.palletActual}</h4>
                        <div class="scrollable-area" style="max-height: 500px;">
                            ${materialesHTML}
                        </div>
                        <div class="button-group">
                            <button class="action-button primary" id="btn-despacho-selectivo">
                                ${t('confirm_selective_dispatch')}
                            </button>
                            <button class="action-button danger" id="btn-despacho-completo">
                                ${t('dispatch_entire_pallet')}
                            </button>
                        </div>
                    </div>
                `;
            }

            generarVistaRenombrar(datos) {
                return `
                    <div class="form-section">
                        <h4>${t('rename_pallet')} P${this.palletActual}</h4>
                        
                        <div class="form-grid cols-3">
                            <div class="form-group">
                                <label>Número de Pallet</label>
                                <input type="number" id="numero-pallet-edit" value="${this.palletActual}" placeholder="1" min="1" required>
                                <small style="color: var(--grey); font-size: 12px;">Puedes cambiar a cualquier número disponible</small>
                            </div>
                            <div class="form-group">
                                <label>${t('package_number')}</label>
                                <input type="text" id="paquete-numero-edit" value="${datos.paqueteNumero || ''}" placeholder="PAQ-001">
                            </div>
                            <div class="form-group">
                                <label>${t('custom_pallet_name')}</label>
                                <input type="text" id="nombre-pallet-edit" value="${datos.nombrePersonalizado || ''}" placeholder="${t('custom_name_placeholder')}">
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="action-button success" id="btn-actualizar-nombre">
                                ${t('update_name')}
                            </button>
                            <button class="action-button secondary" id="btn-cancelar-renombre">
                                ${t('cancel')}
                            </button>
                        </div>
                    </div>
                `;
            }

            configurarEventListenersAgregar() {
                const btnAgregar = document.getElementById('btn-agregar-material');
                const btnEliminar = document.getElementById('btn-eliminar-pallet');

                if (btnAgregar) {
                    btnAgregar.addEventListener('click', () => this.procesarAgregarMaterial());
                }
                if (btnEliminar) {
                    btnEliminar.addEventListener('click', () => this.eliminarPallet());
                }

                // Configurar campo de circunferencia para conversión fraccionaria
                this.configurarCampoCircunferencia(document.getElementById('circunferencia-agregar'));
            }

            configurarEventListenersDespachar() {
                const btnSelectivo = document.getElementById('btn-despacho-selectivo');
                const btnCompleto = document.getElementById('btn-despacho-completo');

                if (btnSelectivo) {
                    btnSelectivo.addEventListener('click', () => this.procesarDespachoSelectivo());
                }
                if (btnCompleto) {
                    btnCompleto.addEventListener('click', () => this.despacharPalletCompleto());
                }
            }

            configurarEventListenersRenombrar() {
                const btnActualizar = document.getElementById('btn-actualizar-nombre');
                const btnCancelar = document.getElementById('btn-cancelar-renombre');

                if (btnActualizar) {
                    btnActualizar.addEventListener('click', () => this.procesarRenombrePallet());
                }
                if (btnCancelar) {
                    btnCancelar.addEventListener('click', () => this.mostrarSeccion('inventario'));
                }
            }

            editarMaterial(materialId) {
                const datos = this.inventario[this.palletActual];
                const material = datos.materiales.find(m => m.id === materialId);
                
                if (!material) {
                    this.mostrarNotificacion('Material no encontrado', 'error');
                    return;
                }

                const content = document.getElementById('modal-content');
                content.innerHTML = `
                    <div class="form-section">
                        <h4>${t('edit_material_details')}</h4>
                        
                        <div class="form-section">
                            <h4>${t('material_info')}</h4>
                            <div class="form-grid cols-2">
                                <div class="form-group">
                                    <label>${t('material_type')}</label>
                                    <input type="text" id="tipo-editar" value="${material.tipo || ''}" placeholder="${t('select_or_type_material')}" required>
                                </div>
                                <div class="form-group">
                                    <label>${t('supplier')}</label>
                                    <input type="text" id="proveedor-editar" value="${material.proveedor || ''}" placeholder="${t('supplier_name')}" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>${t('technical_specs')}</h4>
                            <div class="form-grid cols-4">
                                <div class="form-group">
                                    <label>${t('circumference')}</label>
                                    <input type="text" id="circunferencia-a-editar" value="${material.circunferencia ? this.decimalAFraccion(material.circunferencia) + '"' : ''}" placeholder="12″">
                                </div>
                                <div class="form-group">
                                    <label>${t('circumference')} B</label>
                                    <input type="text" id="circunferencia-b-editar" value="${material.circunferencia_b ? this.decimalAFraccion(material.circunferencia_b) + '"' : ''}" placeholder="8″">
                                </div>
                                <div class="form-group">
                                    <label>${t('thickness')}</label>
                                    <input type="text" id="espesor-editar" value="${material.espesor || ''}" placeholder="1.5&quot;">
                                </div>
                                <div class="form-group">
                                    <label>${t('length')}</label>
                                    <input type="text" id="longitud-editar" value="" placeholder="20 pies">
                                </div>
                            </div>
                            <div class="form-grid cols-2">
                                <div class="form-group">
                                    <label>${t('weight_optional')}</label>
                                    <input type="text" id="peso-editar" value="" placeholder="500 kg">
                                </div>
                                <div class="form-group">
                                    <!-- Campo vacío para balance visual -->
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>${t('quantity_measures')}</h4>
                            <div class="form-grid cols-2">
                                <div class="form-group">
                                    <label>${t('quantity_received')}</label>
                                    <input type="number" id="cantidad-editar" value="${material.cantidad || 0}" placeholder="100" required min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label>${t('unit_measure')}</label>
                                    <select id="unidad-editar" required>
                                        <option value="pies lineales" ${material.unidad === 'pies lineales' ? 'selected' : ''}>${t('linear_feet')}</option>
                                        <option value="piezas" ${material.unidad === 'piezas' ? 'selected' : ''}>${t('pieces')}</option>
                                        <option value="metros" ${material.unidad === 'metros' ? 'selected' : ''}>${t('meters')}</option>
                                        <option value="kilogramos" ${material.unidad === 'kilogramos' ? 'selected' : ''}>${t('kilograms')}</option>
                                        <option value="toneladas" ${material.unidad === 'toneladas' ? 'selected' : ''}>${t('tons')}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="action-button success" onclick="window.sistemaInventario.procesarEdicionMaterial('${materialId}')">
                                ${t('save_changes')}
                            </button>
                            <button class="action-button secondary" onclick="window.sistemaInventario.mostrarSeccion('editar')">
                                ${t('cancel_edit')}
                            </button>
                        </div>
                    </div>
                `;

                // Configurar campo de circunferencia para conversión fraccionaria
                setTimeout(() => {
                    this.configurarCampoCircunferencia(document.getElementById('circunferencia-editar'));
                }, 100);
            }

            // FUNCIONES DE EDICIÓN POR ÍNDICE (REPARADAS Y MOVIDAS AL LUGAR CORRECTO)
            editarMaterialPorIndice(indice) {
                console.log('Editando material con índice:', indice);
                console.log('Pallet actual:', this.palletActual);
                
                const datos = this.inventario[this.palletActual];
                if (!datos) {
                    console.log('No se encontró el pallet:', this.palletActual);
                    this.mostrarNotificacion('Pallet no encontrado', 'error');
                    return;
                }
                
                console.log('Total materiales en el pallet:', datos.materiales.length);
                if (indice < 0 || indice >= datos.materiales.length) {
                    console.log('Índice fuera de rango:', indice);
                    this.mostrarNotificacion('Material no encontrado', 'error');
                    return;
                }

                const material = datos.materiales[indice];
                console.log('Material encontrado:', material);

                const content = document.getElementById('modal-content');
                content.innerHTML = `
                    <div class="form-section">
                        <h4>${t('edit_material_details')}</h4>
                        
                        <div class="form-section">
                            <h4>${t('material_info')}</h4>
                            <div class="form-grid cols-2">
                                <div class="form-group">
                                    <label>${t('material_type')}</label>
                                    <input type="text" id="tipo-editar" value="${material.tipo || ''}" placeholder="${t('select_or_type_material')}" required>
                                </div>
                                <div class="form-group">
                                    <label>${t('supplier')}</label>
                                    <input type="text" id="proveedor-editar" value="${material.proveedor || ''}" placeholder="${t('supplier_name')}" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>${t('technical_specs')}</h4>
                            <div class="form-grid cols-4">
                                <div class="form-group">
                                    <label>${t('circumference')} A</label>
                                    <input type="text" id="circunferencia-a-editar" value="${material.circunferencia ? this.decimalAFraccion(material.circunferencia) + '"' : ''}" placeholder="12″">
                                </div>
                                <div class="form-group">
                                    <label>${t('circumference')} B</label>
                                    <input type="text" id="circunferencia-b-editar" value="${material.circunferencia_b ? this.decimalAFraccion(material.circunferencia_b) + '"' : ''}" placeholder="8″">
                                </div>
                                <div class="form-group">
                                    <label>${t('thickness')}</label>
                                    <input type="text" id="espesor-editar" value="${material.espesor || ''}" placeholder="1.5&quot;">
                                </div>
                                <div class="form-group">
                                    <label>${t('length')}</label>
                                    <input type="text" id="longitud-editar" value="" placeholder="20 pies">
                                </div>
                            </div>
                            <div class="form-grid cols-2">
                                <div class="form-group">
                                    <label>${t('weight_optional')}</label>
                                    <input type="text" id="peso-editar" value="" placeholder="500 kg">
                                </div>
                                <div class="form-group">
                                    <!-- Campo vacío para balance visual -->
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>${t('quantity_measures')}</h4>
                            <div class="form-grid cols-2">
                                <div class="form-group">
                                    <label>${t('quantity_received')}</label>
                                    <input type="number" id="cantidad-editar" value="${material.cantidad || 0}" placeholder="100" required min="0" step="1">
                                </div>
                                <div class="form-group">
                                    <label>${t('unit_measure')}</label>
                                    <select id="unidad-editar" required>
                                        <option value="pies lineales" ${material.unidad === 'pies lineales' ? 'selected' : ''}>${t('linear_feet')}</option>
                                        <option value="piezas" ${material.unidad === 'piezas' ? 'selected' : ''}>${t('pieces')}</option>
                                        <option value="metros" ${material.unidad === 'metros' ? 'selected' : ''}>${t('meters')}</option>
                                        <option value="kilogramos" ${material.unidad === 'kilogramos' ? 'selected' : ''}>${t('kilograms')}</option>
                                        <option value="toneladas" ${material.unidad === 'toneladas' ? 'selected' : ''}>${t('tons')}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="action-button success" onclick="window.sistemaInventario.procesarEdicionMaterialPorIndice(${indice})">
                                ${t('save_changes')}
                            </button>
                            <button class="action-button secondary" onclick="window.sistemaInventario.mostrarSeccion('editar')">
                                ${t('cancel_edit')}
                            </button>
                        </div>
                    </div>
                `;

                // Configurar campo de circunferencia para conversión fraccionaria
                setTimeout(() => {
                    this.configurarCampoCircunferencia(document.getElementById('circunferencia-editar'));
                }, 100);
            }

            async eliminarMaterialPorIndice(indice) {
                try {
                    if (!confirm(t('confirm_delete_material'))) {
                        return;
                    }

                    console.log('Eliminando material con índice:', indice);
                    const datos = this.inventario[this.palletActual];
                    
                    if (!datos || indice < 0 || indice >= datos.materiales.length) {
                        this.mostrarNotificacion('Material no encontrado', 'error');
                        return;
                    }

                    const material = datos.materiales[indice];
                    console.log('Material a eliminar:', material);

                    // Eliminar de la base de datos si está en línea y tiene ID real
                    if (this.isOnline && this.supabase && material.id && !material.id.toString().startsWith('local_')) {
                        const { error } = await this.supabase
                            .from('materiales')
                            .delete()
                            .eq('id', material.id);
                        
                        if (error) throw error;
                    }

                    // Eliminar del inventario local por índice
                    datos.total -= material.cantidad;
                    datos.materiales.splice(indice, 1);

                    // Si no quedan materiales, eliminar todo el pallet
                    if (datos.materiales.length === 0) {
                        delete this.inventario[this.palletActual];
                        const palletElement = document.querySelector(`[data-pallet="${this.palletActual}"]`);
                        if (palletElement) palletElement.remove();
                        this.cerrarModal();
                    } else {
                        // Actualizar la vista
                        this.actualizarNavegacionModal(this.palletActual);
                        this.mostrarSeccion('editar');
                    }

                    this.actualizarEstadisticas();
                    this.mostrarNotificacion(t('material_deleted'), 'success');
                    
                } catch (error) {
                    console.error('Error eliminando material:', error);
                    this.mostrarNotificacion(t('error_deleting_material') + ' ' + error.message, 'error');
                }
            }

            async procesarEdicionMaterialPorIndice(indice) {
                try {
                    console.log('Procesando edición del material con índice:', indice);
                    const datos = this.inventario[this.palletActual];
                    
                    if (!datos || indice < 0 || indice >= datos.materiales.length) {
                        this.mostrarNotificacion('Material no encontrado', 'error');
                        return;
                    }

                    const material = datos.materiales[indice];
                    const cantidadAnterior = material.cantidad;

                    const tipo = document.getElementById('tipo-editar').value.trim() || 'Material';
                    const proveedor = document.getElementById('proveedor-editar').value.trim() || 'Sin especificar';
                    const circunferencia = document.getElementById('circunferencia-editar').value.trim();
                    const espesor = document.getElementById('espesor-editar').value.trim();
                    const longitud = document.getElementById('longitud-editar').value.trim();
                    const peso = document.getElementById('peso-editar').value.trim();
                    const cantidad = parseInt(document.getElementById('cantidad-editar').value) || 0;
                    const unidad = document.getElementById('unidad-editar').value || 'unidades';

                    let descripcion = tipo;
                    if (circunferencia && espesor) {
                        descripcion += ` - ${circunferencia}″ ⌀ × ${espesor}″`;
                        if (longitud) descripcion += ` × ${longitud}`;
                        if (peso) descripcion += ` (${peso})`;
                    }

                    // Actualizar base de datos si está en línea y tiene ID real
                    if (this.isOnline && this.supabase && material.id && !material.id.toString().startsWith('local_')) {
                        const { error } = await this.supabase
                            .from('materiales')
                            .update({
                                tipo: tipo,
                                circunferencia: circunferencia || null,
                                espesor: espesor || null,
                                cantidad: cantidad,
                                unidad: unidad,
                                proveedor: proveedor,
                                descripcion_completa: descripcion
                            })
                            .eq('id', material.id);
                        
                        if (error) throw error;
                    }

                    // Actualizar inventario local
                    material.tipo = tipo;
                    material.circunferencia = circunferencia || null;
                    material.espesor = espesor || null;
                    material.cantidad = cantidad;
                    material.unidad = unidad;
                    material.proveedor = proveedor;
                    material.descripcion = descripcion;

                    // Recalcular total del pallet
                    datos.total = datos.total - cantidadAnterior + cantidad;

                    // Actualizar navegación y mostrar vista de edición
                    this.actualizarNavegacionModal(this.palletActual);
                    this.mostrarSeccion('editar');
                    this.actualizarEstadisticas();
                    
                    this.mostrarNotificacion(t('material_updated'), 'success');
                    
                } catch (error) {
                    console.error('Error actualizando material:', error);
                    this.mostrarNotificacion(t('error_updating_material') + ' ' + error.message, 'error');
                }
            }

            async eliminarMaterial(materialId) {
                try {
                    if (!confirm(t('confirm_delete_material'))) {
                        return;
                    }

                    const datos = this.inventario[this.palletActual];
                    const materialIndex = datos.materiales.findIndex(m => m.id === materialId);
                    
                    if (materialIndex === -1) {
                        this.mostrarNotificacion('Material no encontrado', 'error');
                        return;
                    }

                    const material = datos.materiales[materialIndex];

                    if (this.isOnline && this.supabase) {
                        const { error } = await this.supabase
                            .from('materiales')
                            .delete()
                            .eq('id', materialId);
                        
                        if (error) throw error;
                    }

                    datos.materiales.splice(materialIndex, 1);
                    datos.total -= material.cantidad;

                    if (datos.materiales.length === 0) {
                        delete this.inventario[this.palletActual];
                        const palletElement = document.querySelector(`[data-pallet="${this.palletActual}"]`);
                        if (palletElement) palletElement.remove();
                        this.cerrarModal();
                    } else {
                        this.actualizarNavegacionModal(this.palletActual);
                        this.mostrarSeccion('editar');
                    }

                    this.actualizarEstadisticas();
                    this.mostrarNotificacion(t('material_deleted'), 'success');
                    
                } catch (error) {
                    console.error('Error eliminando material:', error);
                    this.mostrarNotificacion(t('error_deleting_material') + ' ' + error.message, 'error');
                }
            }

            async procesarEdicionMaterial(materialId) {
                try {
                    const datos = this.inventario[this.palletActual];
                    const materialIndex = datos.materiales.findIndex(m => m.id === materialId);
                    
                    if (materialIndex === -1) {
                        this.mostrarNotificacion('Material no encontrado', 'error');
                        return;
                    }

                    const material = datos.materiales[materialIndex];
                    const cantidadAnterior = material.cantidad;

                    const tipo = document.getElementById('tipo-editar').value.trim() || 'Material';
                    const proveedor = document.getElementById('proveedor-editar').value.trim() || 'Sin especificar';
                    const circunf = document.getElementById('circunferencia-editar').value.trim();
                    const espesor = document.getElementById('espesor-editar').value.trim();
                    const longitud = document.getElementById('longitud-editar').value.trim();
                    const peso = document.getElementById('peso-editar').value.trim();
                    const cantidad = parseInt(document.getElementById('cantidad-editar').value) || 0;
                    const unidad = document.getElementById('unidad-editar').value || 'unidades';

                    let descripcion = tipo;
                    if (circunf && espesor) {
                        descripcion += ` - ${circunf}″ ⌀ × ${espesor}″`;
                        if (longitud) descripcion += ` × ${longitud}`;
                        if (peso) descripcion += ` (${peso})`;
                    }

                    if (this.isOnline && this.supabase) {
                        const { error } = await this.supabase
                            .from('materiales')
                            .update({
                                tipo: tipo,
                                circunferencia: circunf || null,
                                espesor: espesor || null,
                                cantidad: cantidad,
                                unidad: unidad,
                                proveedor: proveedor,
                                descripcion_completa: descripcion
                            })
                            .eq('id', materialId);
                        
                        if (error) throw error;
                    }

                    material.tipo = tipo;
                    material.circunferencia = circunf || null;
                    material.espesor = espesor || null;
                    material.cantidad = cantidad;
                    material.unidad = unidad;
                    material.proveedor = proveedor;
                    material.descripcion = descripcion;

                    datos.total = datos.total - cantidadAnterior + cantidad;

                    this.actualizarNavegacionModal(this.palletActual);
                    this.mostrarSeccion('editar');
                    this.actualizarEstadisticas();
                    
                    this.mostrarNotificacion(t('material_updated'), 'success');
                    
                } catch (error) {
                    console.error('Error actualizando material:', error);
                    this.mostrarNotificacion(t('error_updating_material') + ' ' + error.message, 'error');
                }
            }

            async procesarCreacionPallet(posX, posY) {
                try {
                    const numeroPersonalizadoElement = document.getElementById('numero-pallet-nuevo');
                    const numeroPersonalizado = numeroPersonalizadoElement ? parseInt(numeroPersonalizadoElement.value) : null;
                    
                    const paqueteNumeroElement = document.getElementById('paquete-numero-nuevo');
                    const paqueteNumero = paqueteNumeroElement ? paqueteNumeroElement.value.trim() : '';
                    
                    const nombrePalletElement = document.getElementById('nombre-pallet-nuevo');
                    const nombrePallet = nombrePalletElement ? nombrePalletElement.value.trim() : '';
                    
                    const tipoElement = document.getElementById('tipo-material-nuevo');
                    const tipo = tipoElement ? tipoElement.value.trim() || 'Material' : 'Material';
                    
                    const proveedorElement = document.getElementById('proveedor-nuevo');
                    const proveedor = proveedorElement ? proveedorElement.value.trim() || 'Sin especificar' : 'Sin especificar';
                    
                    const circunfAElement = document.getElementById('circunferencia-nuevo');
                    const circunferencia = circunfAElement ? circunfAElement.value.trim() : '';
                    
                    const espesorElement = document.getElementById('espesor-nuevo');
                    const espesor = espesorElement ? espesorElement.value.trim() : '';
                    
                    const longitudElement = document.getElementById('longitud-nuevo');
                    const longitud = longitudElement ? longitudElement.value.trim() : '';
                    
                    const pesoElement = document.getElementById('peso-nuevo');
                    const peso = pesoElement ? pesoElement.value.trim() : '';
                    
                    const cantidadElement = document.getElementById('cantidad-nuevo');
                    const cantidad = cantidadElement ? parseInt(cantidadElement.value) || 1 : 1;
                    
                    const unidadElement = document.getElementById('unidad-nuevo');
                    const unidad = unidadElement ? unidadElement.value || 'unidades' : 'unidades';

                    // Determinar número a usar
                    let numeroAsignado;
                    if (numeroPersonalizado && numeroPersonalizado > 0) {
                        // Validar que no esté repetido en base de datos
                        const disponible = await this.validarNumeroDisponibleDB(numeroPersonalizado);
                        if (!disponible) {
                            this.mostrarNotificacion(`El número de pallet ${numeroPersonalizado} ya está en uso`, 'error');
                            return;
                        }
                        numeroAsignado = numeroPersonalizado;
                        console.log('Usando número personalizado validado:', numeroAsignado);
                    } else {
                        // Auto-asignar el próximo disponible
                        numeroAsignado = await this.obtenerProximoNumero();
                        console.log('Número auto-asignado:', numeroAsignado);
                    }
                    
                    let descripcion = tipo;
                    if (circunferencia && espesor) {
                        descripcion += ` - ${circunferencia}″ ⌀ × ${espesor}″`;
                        if (longitud) descripcion += ` × ${longitud}`;
                        if (peso) descripcion += ` (${peso})`;
                    }

                    if (this.isOnline && this.supabase) {
                        const { data: palletData, error: palletError } = await this.supabase
                            .from('pallets')
                            .insert({
                                numero: numeroAsignado,
                                posicion_x: posX,
                                posicion_y: posY,
                                paquete_numero: paqueteNumero || null,
                                nombre_personalizado: nombrePallet || null
                            })
                            .select()
                            .single();

                        if (palletError) throw palletError;

                        const { data: materialData, error: materialError } = await this.supabase
                            .from('materiales')
                            .insert({
                                pallet_id: palletData.id,
                                tipo: tipo,
                                circunferencia: circunferencia || null,
                                espesor: espesor || null,
                                cantidad: cantidad,
                                unidad: unidad,
                                proveedor: proveedor,
                                descripcion_completa: descripcion,
                                usuario_registro: this.usuarioActual
                            })
                            .select()
                            .single();

                        if (materialError) throw materialError;
                    }

                    const palletTemporal = document.querySelector('[data-pallet="temporal"]');
                    if (palletTemporal) palletTemporal.remove();

                    this.inventario[numeroAsignado] = {
                        materiales: [{
                            id: this.isOnline ? 'db_id' : 'local_' + Date.now(),
                            tipo: tipo,
                            circunferencia: circunferencia || null,
                            espesor: espesor || null,
                            cantidad: cantidad,
                            unidad: unidad,
                            proveedor: proveedor,
                            descripcion: descripcion,
                            fecha: new Date().toISOString()
                        }],
                        total: cantidad,
                        created: new Date().toISOString(),
                        posicion: { x: posX, y: posY },
                        paqueteNumero: paqueteNumero,
                        nombrePersonalizado: nombrePallet || null
                    };

                    this.crearPalletVisual(numeroAsignado, posX, posY, 'occupied');
                    this.cerrarModal();
                    this.actualizarEstadisticas();
                    
                    this.mostrarNotificacion('Pallet P' + numeroAsignado + ' ' + t('pallet_created_success'), 'success');
                    
                } catch (error) {
                    console.error('Error procesando creación:', error);
                    this.mostrarNotificacion(t('error_creating_pallet') + ' ' + error.message, 'error');
                }
            }

            async procesarAgregarMaterial() {
                try {
                    const tipo = document.getElementById('tipo-agregar').value.trim() || 'Material';
                    const proveedor = document.getElementById('proveedor-agregar').value.trim() || 'Sin especificar';
                    const circunferencia = document.getElementById('circunferencia-agregar').value.trim();
                    const espesor = document.getElementById('espesor-agregar').value.trim();
                    const longitud = document.getElementById('longitud-agregar').value.trim();
                    const peso = document.getElementById('peso-agregar').value.trim();
                    const cantidad = parseInt(document.getElementById('cantidad-agregar').value) || 1;
                    const unidad = document.getElementById('unidad-agregar').value || 'unidades';

                    if (this.isOnline && this.supabase) {
                        const { data: palletData, error: palletError } = await this.supabase
                            .from('pallets')
                            .select('id')
                            .eq('numero', parseInt(this.palletActual))
                            .single();

                        if (palletError) throw palletError;

                        let descripcion = tipo;
                        if (circunferencia && espesor) {
                            descripcion += ` - ${circunferencia}″ ⌀ × ${espesor}″`;
                            if (longitud) descripcion += ` × ${longitud}`;
                            if (peso) descripcion += ` (${peso})`;
                        }

                        const { data: materialData, error: materialError } = await this.supabase
                            .from('materiales')
                            .insert({
                                pallet_id: palletData.id,
                                tipo: tipo,
                                circunferencia: circunferencia || null,
                                espesor: espesor || null,
                                cantidad: cantidad,
                                unidad: unidad,
                                proveedor: proveedor,
                                descripcion_completa: descripcion,
                                usuario_registro: this.usuarioActual
                            })
                            .select()
                            .single();

                        if (materialError) throw materialError;
                    }

                    let descripcion = tipo;
                    if (circunferencia && espesor) {
                        descripcion += ` - ${circunferencia}″ ⌀ × ${espesor}″`;
                        if (longitud) descripcion += ` × ${longitud}`;
                        if (peso) descripcion += ` (${peso})`;
                    }

                    this.inventario[this.palletActual].materiales.push({
                        id: 'local_' + Date.now(),
                        tipo: tipo,
                        circunferencia: circunferencia || null,
                        espesor: espesor || null,
                        cantidad: cantidad,
                        unidad: unidad,
                        proveedor: proveedor,
                        descripcion: descripcion,
                        fecha: new Date().toISOString()
                    });

                    this.inventario[this.palletActual].total += cantidad;
                    
                    this.actualizarNavegacionModal(this.palletActual);
                    this.mostrarSeccion('inventario');
                    this.actualizarEstadisticas();
                    
                    this.mostrarNotificacion(t('material_added_success'), 'success');
                    
                } catch (error) {
                    console.error('Error agregando material:', error);
                    this.mostrarNotificacion(t('error_adding_material') + ' ' + error.message, 'error');
                }
            }

            async procesarRenombrePallet() {
                try {
                    const numeroElement = document.getElementById('numero-pallet-edit');
                    const nuevoNumero = numeroElement ? parseInt(numeroElement.value) || this.palletActual : this.palletActual;
                    
                    const paqueteElement = document.getElementById('paquete-numero-edit');
                    const paqueteNumero = paqueteElement ? paqueteElement.value.trim() : '';
                    
                    const nombreElement = document.getElementById('nombre-pallet-edit');
                    const nombrePallet = nombreElement ? nombreElement.value.trim() : '';
                    
                    // Validar que el número no esté repetido (excepto si es el mismo pallet)
                    if (nuevoNumero != this.palletActual) {
                        const disponible = await this.validarNumeroDisponibleDB(nuevoNumero);
                        if (!disponible) {
                            this.mostrarNotificacion(`El número de pallet ${nuevoNumero} ya está en uso`, 'error');
                            return;
                        }
                    }
                    
                    const numeroAnterior = this.palletActual;
                    const datosActuales = this.inventario[this.palletActual];
                    
                    if (this.isOnline && this.supabase) {
                        // Actualizar número en base de datos
                        const { error } = await this.supabase
                            .from('pallets')
                            .update({
                                numero: nuevoNumero,
                                paquete_numero: paqueteNumero || null,
                                nombre_personalizado: nombrePallet || null
                            })
                            .eq('numero', parseInt(this.palletActual));
                        
                        if (error) throw error;
                    }
                    
                    // Si cambió el número, reorganizar inventario local
                    if (nuevoNumero != numeroAnterior) {
                        // Mover datos al nuevo número
                        this.inventario[nuevoNumero] = {
                            ...datosActuales,
                            paqueteNumero: paqueteNumero || null,
                            nombrePersonalizado: nombrePallet || null
                        };
                        
                        // Eliminar entrada anterior
                        delete this.inventario[numeroAnterior];
                        
                        // Actualizar elemento visual
                        const palletElement = document.querySelector(`[data-pallet="${numeroAnterior}"]`);
                        if (palletElement) {
                            palletElement.dataset.pallet = nuevoNumero;
                            palletElement.textContent = nuevoNumero;
                            palletElement.title = 'Pallet P' + nuevoNumero + ' - ' + t('pallet_drag_manage');
                        }
                        
                        // Actualizar pallet actual para el modal
                        this.palletActual = nuevoNumero.toString();
                        
                        // Actualizar título del modal
                        const title = document.getElementById('modal-title');
                        title.textContent = t('pallet_management') + ' P' + nuevoNumero;
                        
                        console.log(`Pallet renumerado de P${numeroAnterior} a P${nuevoNumero}`);
                    } else {
                        // Solo actualizar nombres sin cambiar número
                        this.inventario[this.palletActual].paqueteNumero = paqueteNumero || null;
                        this.inventario[this.palletActual].nombrePersonalizado = nombrePallet || null;
                    }
                    
                    this.actualizarNavegacionModal(this.palletActual);
                    this.mostrarSeccion('inventario');
                    this.actualizarEstadisticas();
                    this.mostrarNotificacion(t('pallet_renamed_success'), 'success');
                    
                } catch (error) {
                    console.error('Error renombrando pallet:', error);
                    this.mostrarNotificacion(t('error_renaming_pallet') + ' ' + error.message, 'error');
                }
            }

            async procesarDespachoSelectivo() {
                try {
                    const datos = this.inventario[this.palletActual];
                    const despachos = [];
                    
                    for (const material of datos.materiales) {
                        const input = document.getElementById(`despachar-${material.id}`);
                        if (input && input.value && parseInt(input.value) > 0) {
                            const cantidadDespacho = parseInt(input.value);
                            if (cantidadDespacho <= material.cantidad) {
                                despachos.push({
                                    id: material.id,
                                    cantidad: cantidadDespacho,
                                    cantidadRestante: material.cantidad - cantidadDespacho
                                });
                            }
                        }
                    }
                    
                    if (despachos.length === 0) {
                        this.mostrarNotificacion('No hay cantidades válidas para despachar', 'warning');
                        return;
                    }
                    
                    for (const despacho of despachos) {
                        if (this.isOnline && this.supabase) {
                            if (despacho.cantidadRestante === 0) {
                                const { error } = await this.supabase
                                    .from('materiales')
                                    .update({ activo: false })
                                    .eq('id', despacho.id);
                                
                                if (error) throw error;
                            } else {
                                const { error } = await this.supabase
                                    .from('materiales')
                                    .update({ cantidad: despacho.cantidadRestante })
                                    .eq('id', despacho.id);
                                
                                if (error) throw error;
                            }
                        }
                        
                        const materialIndex = datos.materiales.findIndex(m => m.id === despacho.id);
                        if (materialIndex !== -1) {
                            if (despacho.cantidadRestante === 0) {
                                datos.materiales.splice(materialIndex, 1);
                            } else {
                                datos.materiales[materialIndex].cantidad = despacho.cantidadRestante;
                            }
                        }
                    }
                    
                    datos.total = datos.materiales.reduce((sum, m) => sum + m.cantidad, 0);
                    
                    if (datos.total === 0) {
                        delete this.inventario[this.palletActual];
                        const palletElement = document.querySelector(`[data-pallet="${this.palletActual}"]`);
                        if (palletElement) palletElement.remove();
                    }
                    
                    this.actualizarEstadisticas();
                    this.cerrarModal();
                    this.mostrarNotificacion(t('dispatch_success'), 'success');
                    
                } catch (error) {
                    console.error('Error en despacho selectivo:', error);
                    this.mostrarNotificacion(t('error_dispatching') + ' ' + error.message, 'error');
                }
            }

            async despacharPalletCompleto() {
                try {
                    const confirmText = '¿Estás seguro de despachar todo el pallet P' + this.palletActual + '?';
                        
                    if (!confirm(confirmText)) {
                        return;
                    }
                    
                    const datos = this.inventario[this.palletActual];
                    
                    if (this.isOnline && this.supabase) {
                        for (const material of datos.materiales) {
                            const { error } = await this.supabase
                                .from('materiales')
                                .update({ activo: false })
                                .eq('id', material.id);
                            
                            if (error) throw error;
                        }
                    }
                    
                    delete this.inventario[this.palletActual];
                    const palletElement = document.querySelector(`[data-pallet="${this.palletActual}"]`);
                    if (palletElement) palletElement.remove();
                    
                    this.actualizarEstadisticas();
                    this.cerrarModal();
                    this.mostrarNotificacion(t('pallet_dispatched_complete'), 'success');
                    
                } catch (error) {
                    console.error('Error despachando pallet completo:', error);
                    this.mostrarNotificacion(t('error_dispatching') + ' ' + error.message, 'error');
                }
            }

            async eliminarPallet() {
                try {
                    const confirmText = '¿ESTÁS SEGURO? Esto eliminará permanentemente el pallet P' + this.palletActual + ' y todos sus materiales.';
                        
                    if (!confirm(confirmText)) {
                        return;
                    }
                    
                    const datos = this.inventario[this.palletActual];
                    
                    if (this.isOnline && this.supabase) {
                        const { error: materialesError } = await this.supabase
                            .from('materiales')
                            .delete()
                            .in('id', datos.materiales.map(m => m.id));
                        
                        if (materialesError) throw materialesError;
                        
                        const { error: palletError } = await this.supabase
                            .from('pallets')
                            .delete()
                            .eq('numero', parseInt(this.palletActual));
                        
                        if (palletError) throw palletError;
                    }
                    
                    delete this.inventario[this.palletActual];
                    const palletElement = document.querySelector(`[data-pallet="${this.palletActual}"]`);
                    if (palletElement) palletElement.remove();
                    
                    this.actualizarEstadisticas();
                    this.cerrarModal();
                    this.mostrarNotificacion('Pallet P' + this.palletActual + ' eliminado permanentemente', 'success');
                    
                } catch (error) {
                    console.error('Error eliminando pallet:', error);
                    this.mostrarNotificacion('Error al eliminar pallet: ' + error.message, 'error');
                }
            }

            cancelarCreacion() {
                const palletTemporal = document.querySelector('[data-pallet="temporal"]');
                if (palletTemporal) palletTemporal.remove();
                this.cerrarModal();
            }

            async obtenerProximoNumero() {
                // Función que siempre consulta base de datos cuando está online para evitar conflictos
                try {
                    let numerosExistentes = [];
                    
                    if (this.isOnline && this.supabase) {
                        console.log('Consultando todos los números en base de datos...');
                        const { data: pallets, error } = await this.supabase
                            .from('pallets')
                            .select('numero')
                            .order('numero', { ascending: true });
                        
                        if (error) throw error;
                        numerosExistentes = pallets ? pallets.map(p => p.numero) : [];
                        console.log('Números existentes en DB:', numerosExistentes);
                    } else {
                        numerosExistentes = Object.keys(this.inventario).map(id => parseInt(id));
                        console.log('Números existentes localmente:', numerosExistentes);
                    }
                    
                    // Buscar el primer número disponible empezando desde 1
                    for (let i = 1; i <= 999999; i++) {
                        if (!numerosExistentes.includes(i)) {
                            console.log('Próximo número disponible:', i);
                            return i;
                        }
                    }
                    
                    // Fallback: último número + 1
                    const siguiente = Math.max(0, ...numerosExistentes) + 1;
                    console.log('Fallback - siguiente número:', siguiente);
                    return siguiente;
                    
                } catch (error) {
                    console.error('Error obteniendo próximo número de DB:', error);
                    // Fallback local en caso de error de red
                    const numerosLocales = Object.keys(this.inventario).map(id => parseInt(id));
                    for (let i = 1; i <= 999999; i++) {
                        if (!numerosLocales.includes(i)) {
                            console.log('Fallback local - número disponible:', i);
                            return i;
                        }
                    }
                    return Math.max(0, ...numerosLocales) + 1;
                }
            }

            // Función para validar si un número está disponible en base de datos
            async validarNumeroDisponibleDB(numero) {
                try {
                    if (!this.isOnline || !this.supabase) {
                        return !this.inventario[numero];
                    }
                    
                    const { data, error } = await this.supabase
                        .from('pallets')
                        .select('numero')
                        .eq('numero', numero)
                        .single();
                    
                    if (error && error.code === 'PGRST116') {
                        // No encontrado = disponible
                        return true;
                    }
                    
                    if (error) throw error;
                    
                    // Si encontró datos = ocupado
                    return false;
                    
                } catch (error) {
                    console.error('Error validando número en DB:', error);
                    // Fallback a validación local
                    return !this.inventario[numero];
                }
            }

            abrirModalPalletVacio(palletId) {
                const modal = document.getElementById('modal');
                const title = document.getElementById('modal-title');
                const content = document.getElementById('modal-content');
                const nav = document.getElementById('section-nav');
                
                title.textContent = `Gestión Pallet P${palletId} - VACÍO`;
                nav.style.display = 'none';
                
                content.innerHTML = `
                    <div class="form-section">
                        <h4>Pallet Vacío - Sin Inventario</h4>
                        
                        <div style="background: var(--light-grey); border: 1px solid var(--medium-grey); border-radius: 12px; padding: 20px; margin-bottom: 24px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: var(--steel); margin-bottom: 16px;">
                                El pallet P${palletId} no tiene materiales pero ocupa este número
                            </div>
                            <div style="color: var(--grey); font-size: 14px; margin-bottom: 20px;">
                                Puedes eliminar este pallet para liberar el número P${palletId} y poder reutilizarlo
                            </div>
                        </div>

                        <div class="form-grid cols-2">
                            <div class="form-group">
                                <label>Paquete #</label>
                                <input type="text" id="paquete-vacio" value="${this.inventario[palletId]?.paqueteNumero || ''}" placeholder="Información adicional">
                            </div>
                            <div class="form-group">
                                <label>Nombre</label>
                                <input type="text" id="nombre-vacio" value="${this.inventario[palletId]?.nombrePersonalizado || ''}" placeholder="Nombre personalizado">
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="action-button primary" onclick="window.sistemaInventario.abrirModalCreacion(${this.inventario[palletId]?.posicion?.x || 100}, ${this.inventario[palletId]?.posicion?.y || 100}); window.sistemaInventario.cerrarModal();">
                                Agregar Materiales
                            </button>
                            <button class="action-button secondary" onclick="window.sistemaInventario.mostrarSeccion('renombrar'); window.sistemaInventario.palletActual = '${palletId}';">
                                Renombrar/Renumerar
                            </button>
                            <button class="action-button danger" onclick="window.sistemaInventario.eliminarPalletVacio('${palletId}')">
                                Eliminar y Liberar Número
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
            }

            // Función para obtener todos los números ocupados
            obtenerNumerosOcupados() {
                return Object.keys(this.inventario).map(id => parseInt(id)).sort((a, b) => a - b);
            }

            // Función para mostrar todos los números ocupados (debugging)
            mostrarNumerosOcupados() {
                const numeros = this.obtenerNumerosOcupados();
                console.log('=== NÚMEROS DE PALLETS OCUPADOS ===');
                console.log('Total pallets en sistema:', numeros.length);
                console.log('Números ocupados:', numeros.join(', '));
                
                const vacios = numeros.filter(num => this.inventario[num].total === 0);
                if (vacios.length > 0) {
                    console.log('Pallets vacíos (puedes eliminar):', vacios.join(', '));
                }
                
                this.mostrarNotificacion(`${numeros.length} números ocupados. Ver consola para detalles.`, 'info');
            }

            async eliminarPalletVacio(palletId) {
                try {
                    const confirmText = `¿ESTÁS SEGURO? Esto eliminará el pallet P${palletId} y liberará su número para reutilizar.`;
                        
                    if (!confirm(confirmText)) {
                        return;
                    }
                    
                    console.log(`Eliminando pallet vacío P${palletId}...`);
                    
                    // Eliminar de la base de datos si está online
                    if (this.isOnline && this.supabase) {
                        const { error } = await this.supabase
                            .from('pallets')
                            .delete()
                            .eq('numero', parseInt(palletId));
                        
                        if (error) throw error;
                        console.log(`Pallet P${palletId} eliminado de la base de datos`);
                    }
                    
                    // Eliminar del inventario local
                    delete this.inventario[palletId];
                    
                    // Eliminar elemento visual
                    const palletElement = document.querySelector(`[data-pallet="${palletId}"]`);
                    if (palletElement) {
                        palletElement.remove();
                        console.log(`Elemento visual del pallet P${palletId} eliminado`);
                    }
                    
                    // Actualizar estadísticas y cerrar modal
                    this.actualizarEstadisticas();
                    this.cerrarModal();
                    
                    this.mostrarNotificacion(`Pallet P${palletId} eliminado. Número liberado para reutilizar.`, 'success');
                    console.log(`Pallet P${palletId} eliminado exitosamente`);
                    
                } catch (error) {
                    console.error('Error eliminando pallet vacío:', error);
                    this.mostrarNotificacion('Error al eliminar pallet: ' + error.message, 'error');
                }
            }

            // === SISTEMA DE BÚSQUEDA INTELIGENTE ===
            
            clasificarFamilia(texto) {
                if (!texto) return null;
                
                const textoLimpio = texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                
                if (textoLimpio.includes('lamina') || textoLimpio.includes('plancha') || 
                    textoLimpio.includes('chapa') || textoLimpio.includes('sheet')) {
                    return 'LAMINA';
                }
                
                if (textoLimpio.includes('strap') || textoLimpio.includes('fleje') || 
                    textoLimpio.includes('strapas') || textoLimpio.includes('banda') || 
                    textoLimpio.includes('zuncho')) {
                    return 'FLEJE';
                }
                
                if (textoLimpio.includes('codo') && (textoLimpio.includes('90') || textoLimpio.includes('noventa'))) {
                    return 'CODO90';
                }
                
                if (textoLimpio.includes('codo') && (textoLimpio.includes('45') || textoLimpio.includes('cuarenta'))) {
                    return 'CODO45';
                }
                
                return null;
            }

            normalizarNumero(valor) {
                if (!valor) return null;
                const decimal = this.fraccionADecimal(valor.toString().replace(/"/g, ''));
                return parseFloat(decimal);
            }

            calcularProximidad(valorBuscado, valorMaterial) {
                if (!valorBuscado || !valorMaterial) return 1000;
                const busqueda = this.normalizarNumero(valorBuscado);
                const material = this.normalizarNumero(valorMaterial);
                
                if (!busqueda || !material) return 1000;
                return Math.abs(busqueda - material);
            }

            configurarSincronizacion() {
                if (!this.supabase || !this.isOnline) return;
                
                const self = this;
                this.pollingInterval = setInterval(async function() {
                    try {
                        await self.cargarInventarioDesdeDB();
                        self.actualizarEstadisticas();
                    } catch (error) {
                        console.error('Error en sincronización:', error);
                    }
                }, CONFIG.POLLING_INTERVAL);
                
                console.log('Sincronización automática configurada');
            }

            actualizarEstadisticas() {
                const totalPallets = Object.keys(this.inventario).length;
                const palletsOcupados = Object.keys(this.inventario).filter(id => this.inventario[id].total > 0).length;

                const contadorTotal = document.getElementById('contador-pallets');
                const contadorOcupados = document.getElementById('contador-ocupados');
                
                if (contadorTotal) contadorTotal.textContent = totalPallets;
                if (contadorOcupados) contadorOcupados.textContent = palletsOcupados;

                this.actualizarOpcionesBusqueda();
            }

            buscarMateriales() {
                const tipo = document.getElementById('search-tipo').value.trim();
                const circunf = document.getElementById('search-circunf').value.trim();
                const espesor = document.getElementById('search-espesor').value.trim();
                
                const resultados = document.getElementById('resultados-busqueda');
                const contenido = document.getElementById('contenido-resultados');
                
                if (!tipo) {
                    contenido.innerHTML = `<div style="color: var(--grey); text-align: center; padding: 20px;">Ingresa un tipo de material para buscar</div>`;
                    resultados.style.display = 'block';
                    return;
                }
                
                // Clasificar familia del material buscado
                const familiaBuscada = this.clasificarFamilia(tipo);
                
                if (!familiaBuscada) {
                    contenido.innerHTML = `<div style="color: var(--steel); text-align: center; padding: 20px;">Material "${tipo}" no reconocido en las familias: LAMINA, CODO 90, CODO 45, FLEJE/STRAP</div>`;
                    resultados.style.display = 'block';
                    return;
                }
                
                // Recopilar todos los materiales de la familia
                const materialesFamilia = [];
                const coincidenciasExactas = [];
                
                Object.keys(this.inventario).forEach(palletId => {
                    const pallet = this.inventario[palletId];
                    pallet.materiales.forEach(material => {
                        const familiaMaterial = this.clasificarFamilia(material.tipo);
                        
                        if (familiaMaterial === familiaBuscada) {
                            const materialCompleto = { ...material, palletId };
                            
                            // Verificar coincidencia exacta
                            let esExacta = true;
                            
                            if (circunf) {
                                const circunfBuscada = this.normalizarNumero(circunf);
                                const circunfMaterial = this.normalizarNumero(material.circunferencia);
                                if (!circunfMaterial || Math.abs(circunfBuscada - circunfMaterial) > 0.1) {
                                    esExacta = false;
                                }
                            }
                            
                            if (espesor) {
                                const espesorBuscado = this.normalizarNumero(espesor);
                                const espesorMaterial = this.normalizarNumero(material.espesor);
                                if (!espesorMaterial || Math.abs(espesorBuscado - espesorMaterial) > 0.1) {
                                    esExacta = false;
                                }
                            }
                            
                            if (esExacta) {
                                coincidenciasExactas.push(materialCompleto);
                            } else {
                                materialesFamilia.push(materialCompleto);
                            }
                        }
                    });
                });
                
                // Ordenar familia por proximidad al tamaño buscado
                if (circunf) {
                    const circunfBuscada = this.normalizarNumero(circunf);
                    materialesFamilia.sort((a, b) => {
                        const proximidadA = this.calcularProximidad(circunf, a.circunferencia);
                        const proximidadB = this.calcularProximidad(circunf, b.circunferencia);
                        return proximidadA - proximidadB;
                    });
                }
                
                // Generar HTML de resultados
                let html = '';
                
                // COINCIDENCIAS EXACTAS
                if (coincidenciasExactas.length > 0) {
                    html += `<div style="margin-bottom: 24px;">
                        <h4 style="color: var(--crimson); font-weight: 700; margin-bottom: 12px; font-size: 16px;">COINCIDENCIA EXACTA</h4>`;
                    
                    coincidenciasExactas.forEach(material => {
                        html += `
                            <div style="background: var(--crimson); color: var(--white); padding: 16px; margin: 8px 0; border-radius: 8px; border: 2px solid var(--onyx);">
                                <strong>Pallet P${material.palletId}</strong> - ${material.descripcion || material.tipo}<br>
                                <strong>Cantidad: ${material.cantidad} ${material.unidad || 'unidades'}</strong>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    // NO HAY DISPONIBLE
                    const busquedaTexto = `${familiaBuscada} ${circunf ? circunf + '"' : ''} ${espesor ? '× ' + espesor + '"' : ''}`.trim();
                    html += `
                        <div style="margin-bottom: 24px;">
                            <div style="background: var(--steel); color: var(--white); padding: 16px; border-radius: 8px; text-align: center; font-weight: 600;">
                                No hay disponible: ${busquedaTexto}
                            </div>
                        </div>
                    `;
                }
                
                // RESTO DE LA FAMILIA
                if (materialesFamilia.length > 0) {
                    html += `<div>
                        <h4 style="color: var(--onyx); font-weight: 700; margin-bottom: 12px; font-size: 16px;">${familiaBuscada} DISPONIBLE</h4>`;
                    
                    materialesFamilia.forEach(material => {
                        html += `
                            <div style="background: var(--white); padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--medium-grey);">
                                <strong>Pallet P${material.palletId}</strong> - ${material.descripcion || material.tipo}<br>
                                <small style="color: var(--grey);">Cantidad: ${material.cantidad} ${material.unidad || 'unidades'}</small>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else if (coincidenciasExactas.length === 0) {
                    html += `<div style="color: var(--grey); text-align: center; padding: 20px;">No hay materiales de la familia ${familiaBuscada} en inventario</div>`;
                }
                
                contenido.innerHTML = html;
                resultados.style.display = 'block';
                
                console.log(`Búsqueda: ${tipo} - Familia: ${familiaBuscada} - Exactas: ${coincidenciasExactas.length} - Familia: ${materialesFamilia.length}`);
            }

            limpiarBusqueda() {
                document.getElementById('search-tipo').value = '';
                document.getElementById('search-circunf').value = '';
                document.getElementById('search-espesor').value = '';
                document.getElementById('resultados-busqueda').style.display = 'none';
            }

            cerrarModal() {
                document.getElementById('modal').classList.remove('active');
                this.palletActual = null;
                this.seccionActiva = 'inventario';
            }

            actualizarEstadoConexion(estado) {
                const statusElement = document.getElementById('connection-status');
                if (statusElement) {
                    statusElement.className = 'connection-status ' + (estado === 'connected' ? 'connected' : 'disconnected');
                    statusElement.textContent = t(estado);
                }
            }

            actualizarOpcionesBusqueda() {
                // Actualizar tipos de materiales
                const datalist = document.getElementById('search-material-types');
                if (datalist) {
                    const tiposUnicos = new Set();
                    
                    Object.keys(this.inventario).forEach(palletId => {
                        const pallet = this.inventario[palletId];
                        pallet.materiales.forEach(material => {
                            if (material.tipo && material.tipo.trim()) {
                                tiposUnicos.add(material.tipo.trim());
                            }
                        });
                    });

                    const opcionesBase = [
                        'Lámina de Acero', 'Strap', 'Codo 90°', 'Codo 45°', 'Tubería', 'Accesorio',
                        'Lamina', 'Fleje', 'Plancha', 'Varilla', 'Perfil', 'Soldadura'
                    ];

                    opcionesBase.forEach(tipo => tiposUnicos.add(tipo));

                    datalist.innerHTML = '<option value=""></option>';
                    
                    const tiposOrdenados = Array.from(tiposUnicos).sort((a, b) => 
                        a.toLowerCase().localeCompare(b.toLowerCase())
                    );

                    tiposOrdenados.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo;
                        datalist.appendChild(option);
                    });
                }

                // Actualizar circunferencias con representación fraccionaria
                const selectCircunf = document.getElementById('search-circunf');
                if (selectCircunf) {
                    const circunferenciasUnicas = new Set();
                    
                    Object.keys(this.inventario).forEach(palletId => {
                        const pallet = this.inventario[palletId];
                        pallet.materiales.forEach(material => {
                            if (material.circunferencia && material.circunferencia.toString().trim()) {
                                circunferenciasUnicas.add(material.circunferencia.toString().trim());
                            }
                        });
                    });

                    // Limpiar opciones existentes excepto la primera
                    selectCircunf.innerHTML = `<option value="">${currentLanguage === 'es' ? 'Todas las circunferencias' : 'All circumferences'}</option>`;
                    
                    // Convertir a array y ordenar numéricamente
                    const circunferenciasOrdenadas = Array.from(circunferenciasUnicas).sort((a, b) => {
                        const numA = parseFloat(this.fraccionADecimal(a));
                        const numB = parseFloat(this.fraccionADecimal(b));
                        // Si ambos son números, ordenar numéricamente
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                        // Si no, ordenar alfabéticamente
                        return a.localeCompare(b);
                    });

                    circunferenciasOrdenadas.forEach(circunf => {
                        const option = document.createElement('option');
                        option.value = circunf;
                        const fraccionVisual = this.decimalAFraccion(circunf);
                        option.textContent = fraccionVisual + '"';
                        selectCircunf.appendChild(option);
                    });

                    console.log('Circunferencias actualizadas:', circunferenciasUnicas.size, 'valores únicos');
                }

                console.log('Opciones de búsqueda actualizadas');
            }

            async resetearSistema() {
                try {
                    const confirmText = '¿ESTÁS SEGURO? Esto eliminará TODOS los pallets y materiales permanentemente. Esta acción NO se puede deshacer.';
                    
                    if (!confirm(confirmText)) {
                        return;
                    }

                    if (this.isOnline && this.supabase) {
                        const { error: materialesError } = await this.supabase
                            .from('materiales')
                            .delete()
                            .neq('id', 0);

                        if (materialesError) throw materialesError;

                        const { error: palletsError } = await this.supabase
                            .from('pallets')
                            .delete()
                            .neq('numero', 0);

                        if (palletsError) throw palletsError;

                        console.log('Base de datos limpiada completamente');
                    }

                    this.inventario = {};
                    
                    const warehouse = document.getElementById('warehouse');
                    if (warehouse) {
                        warehouse.innerHTML = '';
                    }

                    this.actualizarEstadisticas();
                    this.cerrarModal();

                    this.mostrarNotificacion('Sistema reseteado completamente. El próximo pallet será P1.', 'success');
                    
                } catch (error) {
                    console.error('Error reseteando sistema:', error);
                    this.mostrarNotificacion('Error al resetear el sistema: ' + error.message, 'error');
                }
            }

            async probarConexion() {
                try {
                    console.log('Probando conexión...');
                    
                    if (!this.supabase) {
                        await this.conectarSupabase();
                    }
                    
                    if (this.isOnline && this.supabase) {
                        const { data, error, count } = await this.supabase
                            .from('pallets')
                            .select('*', { count: 'exact', head: true });

                        if (error) throw error;
                        
                        this.actualizarEstadoConexion('connected');
                        this.mostrarNotificacion('Conexión exitosa - ' + (count || 0) + ' pallets en base de datos', 'success');
                        
                        await this.cargarInventarioDesdeDB();
                        this.actualizarEstadisticas();
                    } else {
                        throw new Error('No se pudo establecer conexión');
                    }
                    
                } catch (error) {
                    console.error('Error probando conexión:', error);
                    this.isOnline = false;
                    this.actualizarEstadoConexion('demo_mode');
                    this.mostrarNotificacion('Error de conexión: ' + error.message, 'error');
                }
            }

            mostrarNotificacion(mensaje, tipo) {
                console.log(`NOTIFICACIÓN ${tipo.toUpperCase()}: ${mensaje}`);
                
                const notif = document.createElement('div');
                notif.style.cssText = `
                    position: fixed; top: 80px; right: 20px; z-index: 3000;
                    padding: 16px 24px; border-radius: 12px; color: white;
                    font-weight: 600; max-width: 300px; word-wrap: break-word;
                    animation: slideInRight 0.3s ease-out;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                    touch-action: manipulation;
                `;
                
                if (tipo === 'success') {
                    notif.style.background = 'var(--crimson)';
                } else if (tipo === 'error') {
                    notif.style.background = 'var(--steel)';
                } else {
                    notif.style.background = 'var(--dark-grey)';
                }
                
                notif.textContent = mensaje;
                document.body.appendChild(notif);
                
                setTimeout(() => {
                    notif.style.animation = 'slideOutRight 0.3s ease-in forwards';
                    setTimeout(() => notif.remove(), 300);
                }, 3000);
            }
        }

        // Inicialización del sistema
        console.log('=== INICIALIZANDO WORKYARD MANAGER ENTERPRISE ===');
        
        function inicializarSistema() {
            try {
                window.sistemaInventario = new SistemaInventario();
                window.sistemaInventario.init().then(() => {
                    console.log('=== WORKYARD MANAGER ENTERPRISE LISTO ===');
                }).catch(error => {
                    console.error('ERROR EN INICIALIZACIÓN ASYNC:', error);
                });
            } catch (error) {
                console.error('ERROR CRÍTICO EN INICIALIZACIÓN:', error);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarSistema);
        } else {
            setTimeout(inicializarSistema, 100);
        }
    </script>
</body>
</html>
