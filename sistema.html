<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventario - Pallets Mínimos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: Arial, sans-serif; 
            background: #2d3748; 
            color: white;
        }

        .header {
            background: #1a202c;
            padding: 10px 15px;
            border-bottom: 2px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }

        .header h1 { font-size: 18px; margin: 0; }

        .user-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .user-selector select {
            padding: 4px 8px;
            border-radius: 4px;
            background: #4a5568;
            color: white;
            border: 1px solid #718096;
            font-size: 12px;
        }

        .connection-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .connected { background: #38a169; color: white; }
        .connecting { background: #ed8936; color: white; }
        .disconnected { background: #e53e3e; color: white; }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 60px);
            gap: 10px;
            padding: 10px;
            overflow: hidden;
        }

        .sidebar {
            background: #4a5568;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .search-panel { background: transparent; padding: 0; margin: 0; }
        .search-panel h3 { font-size: 16px; margin-bottom: 10px; color: white; }

        .search-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .form-field { display: flex; flex-direction: column; }

        .form-field label {
            color: white;
            font-size: 11px;
            margin-bottom: 2px;
            font-weight: bold;
        }

        .form-field input, .form-field select {
            padding: 6px;
            border: 1px solid #718096;
            border-radius: 4px;
            font-size: 11px;
        }

        .btn {
            padding: 6px 10px;
            background: #2d3748;
            border: 1px solid #718096;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 11px;
            text-align: center;
        }

        .btn:hover { background: #1a202c; }
        .btn-search { background: #38a169; }
        .btn-clear { background: #e53e3e; }
        .btn-full-width { width: 100%; margin-top: 5px; }

        .recent-activity {
            background: transparent;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            min-height: 0;
        }

        .recent-activity h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: white;
        }

        .activity-container { max-height: 200px; overflow-y: auto; }

        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .warehouse {
            flex-grow: 1;
            background-color: #1a202c;
            background-image: url('data:image/svg+xml;charset=utf-8,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 400"%3E%3Crect x="10" y="10" width="200" height="180" fill="%23a2c2d6" stroke="%23333" stroke-width="2"/%3E%3Crect x="220" y="10" width="70" height="180" fill="%23a2c2d6" stroke="%23333" stroke-width="2"/%3E%3Crect x="10" y="200" width="200" height="180" fill="%23a2c2d6" stroke="%23333" stroke-width="2"/%3E%3Crect x="220" y="200" width="70" height="180" fill="%23a2c2d6" stroke="%23333" stroke-width="2"/%3E%3Crect x="150" y="250" width="40" height="20" fill="%23666" stroke="%23333" stroke-width="1"/%3E%3Cpath d="M150 255h40M150 260h40M150 265h40" stroke="%23333" stroke-width="0.5"/%3E%3C/svg%3E');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            border: 3px solid #4a5568;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            padding: 10px;
        }

        .pallet {
            width: 20px;
            height: 20px;
            background: #e53e3e;
            position: absolute;
            cursor: crosshair;
            border: 1px solid #fff;
            margin: 0;
            padding: 0;
            font-size: 8px;
            line-height: 18px;
            text-align: center;
            color: white;
            font-weight: bold;
            transition: all 0.1s ease;
            user-select: none;
            border-radius: 2px;
        }

        .pallet:hover {
            border: 2px solid #ffd700;
            box-shadow: 0 0 6px rgba(255, 215, 0, 0.6);
            z-index: 10;
        }

        .pallet.occupied { background: #38a169; }
        .pallet.temporal {
            background: #ffc107;
            animation: pulse 1s infinite;
            cursor: pointer;
        }
        .pallet.syncing {
            background: #ed8936;
            animation: pulse 1s infinite;
        }
        .pallet.dragging {
            border: 3px solid #ffffff;
            background: #ffd700;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
            z-index: 100;
        }
        .pallet.error {
            background: #dc2626;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .search-results {
            background: #4a5568;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            display: none;
            max-height: 150px;
            overflow-y: auto;
        }

        .search-results h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: white;
        }

        .activity-item {
            background: rgba(255,255,255,0.1);
            padding: 6px;
            margin: 4px 0;
            border-radius: 4px;
            border-left: 3px solid #38a169;
            font-size: 11px;
            color: white;
        }

        .status { display: none !important; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .modal.active { 
            display: flex; 
            align-items: flex-end;
        }

        .modal-content {
            width: 100%;
            background: white;
            color: black;
            border-radius: 15px 15px 0 0;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: #4a5568;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: #e53e3e;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .form-group { margin-bottom: 15px; }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2d3748;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: #38a169;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        body { 
            font-family: Arial, sans-serif; 
            background: #2d3748; 
            color: white;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        .header {
            background: #1a202c;
            padding: 8px 15px;
            border-bottom: 2px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            flex-shrink: 0;
        }

        .header h1 { 
            font-size: 16px; 
            margin: 0;
            white-space: nowrap;
        }

        .user-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            flex-shrink: 0;
        }

        .user-selector select {
            padding: 3px 6px;
            border-radius: 3px;
            background: #4a5568;
            color: white;
            border: 1px solid #718096;
            font-size: 10px;
        }

        .connection-status {
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .connected { background: #38a169; color: white; }
        .connecting { background: #ed8936; color: white; }
        .disconnected { background: #e53e3e; color: white; }

        .main-container {
            display: flex;
            height: calc(100vh - 50px);
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: #4a5568;
            padding: 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0;
            max-height: calc(100vh - 50px);
        }

        .search-panel { 
            background: transparent; 
            padding: 0; 
            margin: 0; 
        }
        
        .search-panel h3 { 
            font-size: 14px; 
            margin-bottom: 8px; 
            color: white; 
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 8px;
        }

        .form-field { 
            display: flex; 
            flex-direction: column; 
        }

        .form-field label {
            color: white;
            font-size: 10px;
            margin-bottom: 2px;
            font-weight: bold;
        }

        .form-field input, .form-field select {
            padding: 4px;
            border: 1px solid #718096;
            border-radius: 3px;
            font-size: 10px;
            height: 28px;
        }

        .btn {
            padding: 5px 8px;
            background: #2d3748;
            border: 1px solid #718096;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            font-size: 10px;
            text-align: center;
            height: 32px;
        }

        .btn:hover { background: #1a202c; }
        .btn-search { background: #38a169; }
        .btn-clear { background: #e53e3e; }
        .btn-full-width { width: 100%; margin-top: 4px; }

        .recent-activity {
            background: transparent;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            min-height: 100px;
            display: flex;
            flex-direction: column;
        }

        .recent-activity h3 {
            font-size: 12px;
            margin-bottom: 8px;
            color: white;
            flex-shrink: 0;
        }

        .activity-container { 
            flex-grow: 1;
            overflow-y: auto;
            max-height: 150px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .warehouse {
            flex: 1;
            background-color: #1a202c;
            background-image: url('data:image/svg+xml;charset=utf-8,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 400"%3E%3Crect x="10" y="10" width="200" height="180" fill="%23a2c2d6" stroke="%23333" stroke-width="2"/%3E%3Crect x="220" y="10" width="70" height="180" fill="%23a2c2d6" stroke="%23333" stroke-width="2"/%3E%3Crect x="10" y="200" width="200" height="180" fill="%23a2c2d6" stroke="%23333" stroke-width="2"/%3E%3Crect x="220" y="200" width="70" height="180" fill="%23a2c2d6" stroke="%23333" stroke-width="2"/%3E%3Crect x="150" y="250" width="40" height="20" fill="%23666" stroke="%23333" stroke-width="1"/%3E%3Cpath d="M150 255h40M150 260h40M150 265h40" stroke="%23333" stroke-width="0.5"/%3E%3C/svg%3E');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border: 2px solid #4a5568;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
            margin: 8px;
            min-height: 400px;
        }

        .search-results {
            background: #4a5568;
            margin: 8px;
            padding: 8px;
            border-radius: 6px;
            display: none;
            max-height: 120px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .search-results h3 {
            font-size: 12px;
            margin-bottom: 6px;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow: hidden;
        }

        .modal.active { 
            display: flex; 
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            color: black;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            background: #4a5568;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .modal-close {
            background: #e53e3e;
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .modal-body {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }

        @media (max-width: 1200px) {
            .sidebar { width: 250px; }
            .search-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 200px;
                order: 2;
            }
            
            .main-content {
                order: 1;
                min-height: calc(100vh - 250px);
            }
            
            .warehouse {
                min-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 6px 10px;
                height: 45px;
            }
            
            .header h1 { 
                font-size: 14px; 
            }
            
            .user-selector {
                font-size: 10px;
                gap: 4px;
            }
            
            .sidebar {
                padding: 8px;
                max-height: 180px;
            }
            
            .search-panel h3 {
                font-size: 12px;
            }
            
            .btn {
                font-size: 9px;
                padding: 4px 6px;
                height: 28px;
            }
            
            .main-content {
                min-height: calc(100vh - 225px);
            }
            
            .warehouse {
                margin: 4px;
                min-height: 250px;
            }
            
            .pallet {
                width: 16px;
                height: 16px;
                font-size: 7px;
                line-height: 14px;
            }
            
            .modal.active {
                padding: 10px;
            }
            
            .modal-content {
                max-height: calc(100vh - 20px);
            }
        }

        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                height: 70px;
                padding: 4px;
                gap: 2px;
            }
            
            .header h1 { 
                font-size: 12px; 
            }
            
            .main-container {
                height: calc(100vh - 70px);
            }
            
            .sidebar {
                padding: 6px;
                max-height: 160px;
            }
            
            .search-grid {
                grid-template-columns: 1fr;
                gap: 4px;
            }
            
            .form-field input, .form-field select {
                height: 24px;
                font-size: 9px;
            }
            
            .btn {
                height: 24px;
                font-size: 8px;
            }
            
            .main-content {
                min-height: calc(100vh - 230px);
            }
            
            .warehouse {
                margin: 2px;
                min-height: 200px;
            }
            
            .pallet {
                width: 14px;
                height: 14px;
                font-size: 6px;
                line-height: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-selector">
            <label>Usuario:</label>
            <select id="usuario-selector" onchange="cambiarUsuario()">
                <option value="Usuario1">Usuario 1</option>
                <option value="Usuario2">Usuario 2</option>
                <option value="Usuario3">Usuario 3</option>
            </select>
        </div>
        
        <h1>Control de Inventario</h1>
        
        <div id="connection-status" class="connection-status connected">
            Conectado
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="search-panel">
                <h3>Buscador</h3>
                
                <div class="search-grid">
                    <div class="form-field">
                        <label>Tipo:</label>
                        <select id="search-tipo">
                            <option value="">Todos</option>
                            <option value="Lamina">Lámina</option>
                            <option value="Strap">Strap</option>
                            <option value="90">Codo 90°</option>
                            <option value="45">Codo 45°</option>
                        </select>
                    </div>
                    
                    <div class="form-field">
                        <label>Circunferencia ("):</label>
                        <input type="text" id="search-circunf" placeholder="12">
                    </div>
                    
                    <div class="form-field">
                        <label>Espesor ("):</label>
                        <input type="text" id="search-espesor" placeholder="1.5">
                    </div>
                    
                    <div class="form-field">
                        <label>Ángulo:</label>
                        <select id="search-angulo">
                            <option value="">-</option>
                            <option value="45">45°</option>
                            <option value="90">90°</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-search btn-full-width" onclick="buscarMateriales()">Buscar</button>
                <button class="btn btn-clear btn-full-width" onclick="limpiarBusqueda()">Limpiar</button>
            </div>

            <div class="recent-activity">
                <h3>Actividad Reciente</h3>
                <div class="activity-container" id="actividad-reciente"></div>
            </div>

            <div style="margin-top: 15px; padding: 10px; border-top: 1px solid #718096;">
                <h3 style="color: white; font-size: 12px; margin-bottom: 8px;">Gestión de Pallets</h3>
                <button class="btn btn-search btn-full-width" id="btn-crear-pallet">
                    Crear Nuevo Pallet
                </button>
                <div style="margin-top: 8px; font-size: 10px; color: #a0aec0;">
                    <span>Total pallets: </span><span id="contador-pallets">0</span><br>
                    <span>Ocupados: </span><span id="contador-ocupados">0</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="resultados-busqueda" class="search-results">
                <h3 style="color: white; margin-bottom: 10px;">Resultados de Búsqueda</h3>
                <div id="contenido-resultados"></div>
            </div>

            <div class="warehouse" id="warehouse"></div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Pallet</h3>
                <button class="modal-close" onclick="cerrarModal()">Cerrar</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        console.log('=== SISTEMA APACHE INVENTARIO INICIANDO ===');
        
        const CONFIG = {
            SUPABASE_URL: 'https://iuewoscogzfikwtzjjud.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1ZXdvc2NvZ3pmaWt3dHpqanVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNDQ4NTUsImV4cCI6MjA3MTkyMDg1NX0.WwNqp_zYz2EUqOcvpbsoT42bihKSMM6pmxWe3nJiy1Y',
            POLLING_INTERVAL: 10000,
            PALLET_SIZE: 20
        };

        class InventorySystem {
            constructor() {
                this.inventario = {};
                this.palletActual = null;
                this.usuarioActual = 'Usuario1';
                this.isOnline = false;
                this.pollingInterval = null;
                this.ultimaVerificacion = new Date().toISOString();
                this.ultimoPalletId = 0;
                this.supabase = null;
                
                this.arrastre = {
                    activo: false,
                    palletId: null,
                    posicion: { x: 0, y: 0 },
                    inicial: { x: 0, y: 0 }
                };
                
                this.logInfo('InventorySystem constructor completado');
            }

            logInfo(mensaje) {
                const timestamp = new Date().toISOString();
                console.log(`[${timestamp}] INFO: ${mensaje}`);
            }

            logError(mensaje, error) {
                const timestamp = new Date().toISOString();
                console.error(`[${timestamp}] ERROR: ${mensaje}`, error);
            }

            logWarning(mensaje) {
                const timestamp = new Date().toISOString();
                console.warn(`[${timestamp}] WARNING: ${mensaje}`);
            }

            async init() {
                try {
                    this.logInfo('Sistema inicializando...');
                    await this.conectarSupabase();
                    await this.cargarInventarioDesdeDB();
                    this.setupEventListeners();
                    this.inicializarArrastre();
                    this.configurarSincronizacionTiempoReal();
                    this.actualizarContadores();
                    this.logInfo('Sistema inicializado con sincronización real');
                } catch (error) {
                    this.logError('Error en inicialización', error);
                    this.mostrarErrorUsuario('Error al inicializar el sistema');
                }
            }

            async conectarSupabase() {
                try {
                    this.logInfo('Intentando conectar a Supabase...');
                    
                    if (!window.supabase) {
                        throw new Error('Supabase SDK no está disponible');
                    }
                    
                    this.supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                    
                    const { data, error, count } = await this.supabase
                        .from('pallets')
                        .select('*', { count: 'exact', head: true });

                    if (error) {
                        this.logError('Error en consulta de prueba', error);
                        throw new Error('Error Supabase: ' + error.message);
                    }
                    
                    this.isOnline = true;
                    this.actualizarEstadoConexion('connected');
                    this.logInfo('Conectado a Supabase - ' + (count || 0) + ' pallets en DB');
                    return true;
                } catch (error) {
                    this.logError('Error detallado de conexión', error);
                    this.isOnline = false;
                    this.actualizarEstadoConexion('disconnected');
                    this.mostrarErrorUsuario('Conexión fallida: ' + error.message);
                    return false;
                }
            }

            setupEventListeners() {
                try {
                    const btnCrearPallet = document.getElementById('btn-crear-pallet');
                    
                    if (btnCrearPallet) {
                        btnCrearPallet.onclick = null;
                        const self = this;
                        btnCrearPallet.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            self.logInfo('CLICK DETECTADO - Iniciando creación de pallet temporal');
                            self.crearNuevoPallet();
                        });
                        
                        this.logInfo('Event listener para "Crear Nuevo Pallet" configurado correctamente');
                    } else {
                        this.logError('CRÍTICO: Botón "Crear Nuevo Pallet" NO ENCONTRADO');
                    }
                    
                    this.logInfo('Event listeners configurados');
                } catch (error) {
                    this.logError('Error configurando event listeners', error);
                }
            }

            async cargarInventarioDesdeDB() {
                try {
                    if (!this.supabase || !this.isOnline) return;

                    const { data: materiales, error } = await this.supabase
                        .from('materiales')
                        .select('*, pallets!inner (numero, posicion_x, posicion_y, created_at)')
                        .eq('activo', true)
                        .order('fecha_recepcion', { ascending: false });

                    if (error) throw error;

                    this.inventario = {};
                    this.ultimoPalletId = 0;

                    if (materiales && materiales.length > 0) {
                        const palletsMap = new Map();
                        
                        materiales.forEach(material => {
                            const palletNum = material.pallets.numero;
                            
                            if (!palletsMap.has(palletNum)) {
                                palletsMap.set(palletNum, {
                                    materiales: [],
                                    total: 0,
                                    created: material.pallets.created_at || new Date().toISOString(),
                                    lastUpdated: new Date().toISOString(),
                                    visible: true,
                                    posicion: {
                                        x: material.pallets.posicion_x || 50,
                                        y: material.pallets.posicion_y || 50
                                    }
                                });
                            }

                            palletsMap.get(palletNum).materiales.push({
                                id: material.id,
                                tipo: material.tipo,
                                circunferencia: material.circunferencia,
                                espesor: material.espesor,
                                descripcion: material.descripcion_completa,
                                cantidad: material.cantidad,
                                unidad: material.unidad,
                                proveedor: material.proveedor,
                                fecha: material.fecha_recepcion,
                                usuario: material.usuario_registro
                            });

                            if (palletNum > this.ultimoPalletId) {
                                this.ultimoPalletId = palletNum;
                            }
                        });

                        palletsMap.forEach((data, palletNum) => {
                            data.total = data.materiales.reduce((sum, m) => sum + m.cantidad, 0);
                            this.inventario[palletNum] = data;
                        });
                    }

                    await this.crearPalletsVisuales();
                    this.logInfo('Inventario cargado: ' + (materiales?.length || 0) + ' materiales en ' + Object.keys(this.inventario).length + ' pallets con material');

                } catch (error) {
                    this.logError('Error cargando inventario desde DB', error);
                    throw error;
                }
            }

            async crearPalletsVisuales() {
                try {
                    const warehouse = document.getElementById('warehouse');
                    if (!warehouse) return;

                    warehouse.innerHTML = '';

                    const self = this;
                    Object.keys(this.inventario).forEach(palletId => {
                        const datos = this.inventario[palletId];
                        
                        if (datos.total > 0) {
                            const pallet = document.createElement('div');
                            
                            pallet.className = 'pallet occupied';
                            pallet.dataset.pallet = palletId;
                            pallet.title = 'Pallet P' + palletId + ' - Click para gestionar - ' + datos.total + ' unidades';
                            pallet.textContent = palletId;
                            
                            pallet.style.left = datos.posicion.x + 'px';
                            pallet.style.top = datos.posicion.y + 'px';
                            pallet.style.display = 'block';
                            datos.visible = true;
                            
                            pallet.addEventListener('click', function() {
                                self.logInfo('Click en pallet P' + palletId);
                                self.abrirModal(palletId);
                            });
                            
                            pallet.addEventListener('mousedown', function(e) {
                                self.handleWarehouseMouseDown(e);
                            });
                            
                            pallet.addEventListener('touchstart', function(e) {
                                self.handleWarehouseTouchStart(e);
                            });
                            
                            warehouse.appendChild(pallet);
                        }
                    });

                    this.logInfo(Object.keys(this.inventario).length + ' pallets con material renderizados visualmente');
                } catch (error) {
                    this.logError('Error creando pallets visuales', error);
                }
            }

            inicializarArrastre() {
                try {
                    const warehouse = document.getElementById('warehouse');
                    if (!warehouse) return;
                    
                    const self = this;
                    
                    document.addEventListener('mousemove', function(e) {
                        self.handleMouseMove(e);
                    });
                    
                    document.addEventListener('mouseup', function(e) {
                        self.handleMouseUp(e);
                    });
                    
                    document.addEventListener('touchmove', function(e) {
                        self.handleTouchMove(e);
                    }, { passive: false });
                    
                    document.addEventListener('touchend', function(e) {
                        self.handleTouchEnd(e);
                    });
                    
                    this.logInfo('Sistema de arrastre inicializado');
                } catch (error) {
                    this.logError('Error inicializando arrastre', error);
                }
            }

            handleWarehouseMouseDown(e) {
                try {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const pallet = e.target.closest('.pallet');
                    if (!pallet) return;
                    
                    const palletId = pallet.dataset.pallet;
                    
                    if (palletId === 'temporal') {
                        this.logInfo('Pallet temporal clickeado - no arrastrable');
                        return;
                    }
                    
                    this.handleMouseDown(e, palletId);
                } catch (error) {
                    this.logError('Error en mousedown de warehouse', error);
                }
            }

            handleWarehouseTouchStart(e) {
                try {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const pallet = e.target.closest('.pallet');
                    if (!pallet) return;
                    
                    const palletId = pallet.dataset.pallet;
                    
                    if (palletId === 'temporal') {
                        this.logInfo('Pallet temporal tocado - no arrastrable');
                        return;
                    }
                    
                    const touch = e.touches[0];
                    this.handleMouseDown(touch, palletId);
                } catch (error) {
                    this.logError('Error en touchstart de warehouse', error);
                }
            }

            handleMouseDown(e, palletId) {
                try {
                    if (this.iniciarArrastre(palletId)) {
                        const rect = document.getElementById('warehouse').getBoundingClientRect();
                        this.arrastre.posicion = {
                            x: e.clientX - rect.left,
                            y: e.clientY - rect.top
                        };
                        this.arrastre.inicial = { x: this.arrastre.posicion.x, y: this.arrastre.posicion.y };
                    }
                } catch (error) {
                    this.logError('Error iniciando arrastre', error);
                }
            }

            iniciarArrastre(palletId) {
                try {
                    if (palletId === 'temporal') {
                        this.logInfo('Pallet temporal no es arrastrable');
                        return false;
                    }
                    
                    this.arrastre.activo = true;
                    this.arrastre.palletId = palletId;
                    
                    const pallet = document.querySelector('[data-pallet="' + palletId + '"]');
                    if (pallet) {
                        pallet.classList.add('dragging');
                        pallet.style.zIndex = '1000';
                        document.body.style.cursor = 'grabbing';
                    }
                    
                    this.logInfo('Iniciando arrastre del pallet P' + palletId);
                    return true;
                } catch (error) {
                    this.logError('Error iniciando arrastre', error);
                    return false;
                }
            }

            handleMouseMove(e) {
                if (!this.arrastre.activo) return;
                
                try {
                    const rect = document.getElementById('warehouse').getBoundingClientRect();
                    const newX = e.clientX - rect.left;
                    const newY = e.clientY - rect.top;
                    
                    this.moverPallet(newX, newY);
                } catch (error) {
                    this.logError('Error en mousemove', error);
                }
            }

            handleTouchMove(e) {
                if (!this.arrastre.activo) return;
                
                try {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = document.getElementById('warehouse').getBoundingClientRect();
                    const newX = touch.clientX - rect.left;
                    const newY = touch.clientY - rect.top;
                    
                    this.moverPallet(newX, newY);
                } catch (error) {
                    this.logError('Error en touchmove', error);
                }
            }

            moverPallet(x, y) {
                try {
                    const pallet = document.querySelector('[data-pallet="' + this.arrastre.palletId + '"]');
                    if (!pallet) return;
                    
                    const warehouse = document.getElementById('warehouse');
                    const warehouseRect = warehouse.getBoundingClientRect();
                    
                    const limitedX = Math.max(0, Math.min(x - 10, warehouseRect.width - 20));
                    const limitedY = Math.max(0, Math.min(y - 10, warehouseRect.height - 20));
                    
                    pallet.style.left = limitedX + 'px';
                    pallet.style.top = limitedY + 'px';
                    
                    this.arrastre.posicion = { x: limitedX, y: limitedY };
                } catch (error) {
                    this.logError('Error moviendo pallet', error);
                }
            }

            handleMouseUp(e) {
                this.terminarArrastre();
            }

            handleTouchEnd(e) {
                this.terminarArrastre();
            }

            async terminarArrastre() {
                if (!this.arrastre.activo) return;
                
                try {
                    const pallet = document.querySelector('[data-pallet="' + this.arrastre.palletId + '"]');
                    if (pallet) {
                        pallet.classList.remove('dragging');
                        pallet.style.zIndex = '';
                        document.body.style.cursor = '';
                    }
                    
                    const deltaX = Math.abs(this.arrastre.posicion.x - this.arrastre.inicial.x);
                    const deltaY = Math.abs(this.arrastre.posicion.y - this.arrastre.inicial.y);
                    
                    if (deltaX > 5 || deltaY > 5) {
                        await this.actualizarPosicionPallet(this.arrastre.palletId, this.arrastre.posicion.x, this.arrastre.posicion.y);
                        this.logInfo('Pallet P' + this.arrastre.palletId + ' reposicionado a (' + this.arrastre.posicion.x + ', ' + this.arrastre.posicion.y + ')');
                        
                        if (this.inventario[this.arrastre.palletId]) {
                            this.inventario[this.arrastre.palletId].posicion = {
                                x: this.arrastre.posicion.x,
                                y: this.arrastre.posicion.y
                            };
                        }
                    } else {
                        this.abrirModal(this.arrastre.palletId);
                    }
                    
                } catch (error) {
                    this.logError('Error terminando arrastre', error);
                } finally {
                    this.arrastre.activo = false;
                    this.arrastre.palletId = null;
                }
            }

            async actualizarPosicionPallet(palletId, x, y) {
                try {
                    if (!this.supabase || !this.isOnline) return;
                    
                    const { error } = await this.supabase
                        .from('pallets')
                        .update({
                            posicion_x: Math.round(x),
                            posicion_y: Math.round(y)
                        })
                        .eq('numero', parseInt(palletId));
                    
                    if (error) throw error;
                    
                    this.logInfo('Posición P' + palletId + ' actualizada en DB: (' + Math.round(x) + ', ' + Math.round(y) + ')');
                    
                } catch (error) {
                    this.logError('Error actualizando posición en DB', error);
                }
            }

            configurarSincronizacionTiempoReal() {
                try {
                    if (!this.supabase || !this.isOnline) return;

                    if (this.pollingInterval) {
                        clearInterval(this.pollingInterval);
                    }
                    
                    this.logInfo('Iniciando polling automático cada 10 segundos...');
                    
                    const self = this;
                    this.pollingInterval = setInterval(async function() {
                        try {
                            if (!self.supabase || !self.isOnline) return;
                            
                            const timestampActual = new Date().toISOString();
                            
                            const { data: materialesRecientes, error: errorMateriales } = await self.supabase
                                .from('materiales')
                                .select('*')
                                .gte('fecha_recepcion', self.ultimaVerificacion)
                                .eq('activo', true);
                            
                            if (errorMateriales) throw errorMateriales;
                            
                            if (materialesRecientes && materialesRecientes.length > 0) {
                                self.logInfo('Polling detectó ' + materialesRecientes.length + ' cambios en materiales');
                                await self.cargarInventarioDesdeDB();
                                self.actualizarContadores();
                                self.logInfo('Sincronización completada - inventario actualizado');
                            }
                            
                            self.ultimaVerificacion = timestampActual;
                            
                        } catch (error) {
                            self.logError('Error en polling automático', error);
                            self.isOnline = false;
                            self.actualizarEstadoConexion('disconnected');
                        }
                    }, CONFIG.POLLING_INTERVAL);

                    this.logInfo('Polling automático configurado exitosamente');
                } catch (error) {
                    this.logError('Error configurando polling', error);
                }
            }

            async obtenerProximoNumeroDisponible() {
                try {
                    const { data: todosLosPallets, error } = await this.supabase
                        .from('pallets')
                        .select('numero')
                        .order('numero', { ascending: true });
                    
                    if (error) {
                        this.logError('Error obteniendo pallets existentes', error);
                        return this.obtenerProximoNumeroLocal();
                    }
                    
                    if (!todosLosPallets || todosLosPallets.length === 0) {
                        this.logInfo('No hay pallets existentes, asignando P1');
                        return 1;
                    }
                    
                    const numerosExistentes = todosLosPallets
                        .map(function(p) { return p.numero; })
                        .filter(function(num) { return num && !isNaN(num); })
                        .sort(function(a, b) { return a - b; });
                    
                    this.logInfo('Números existentes en DB: ' + numerosExistentes.join(', '));
                    
                    for (let i = 1; i <= numerosExistentes.length + 1; i++) {
                        if (numerosExistentes.indexOf(i) === -1) {
                            this.logInfo('Próximo número disponible calculado: P' + i);
                            return i;
                        }
                    }
                    
                    const siguienteNumero = Math.max.apply(Math, numerosExistentes) + 1;
                    this.logInfo('Asignando siguiente número secuencial: P' + siguienteNumero);
                    return siguienteNumero;
                    
                } catch (error) {
                    this.logError('Error calculando próximo número', error);
                    return this.obtenerProximoNumeroLocal();
                }
            }
            
            obtenerProximoNumeroLocal() {
                const numerosLocales = Object.keys(this.inventario)
                    .map(function(key) { return Number(key); })
                    .filter(function(num) { return !isNaN(num); })
                    .sort(function(a, b) { return a - b; });
                
                if (numerosLocales.length === 0) return 1;
                
                for (let i = 1; i <= numerosLocales.length + 1; i++) {
                    if (numerosLocales.indexOf(i) === -1) {
                        this.logInfo('Número disponible local: P' + i);
                        return i;
                    }
                }
                
                const siguienteLocal = Math.max.apply(Math, numerosLocales) + 1;
                this.logInfo('Siguiente número local: P' + siguienteLocal);
                return siguienteLocal;
            }

            async crearNuevoPallet() {
                try {
                    if (!this.supabase || !this.isOnline) {
                        this.mostrarErrorUsuario('Sin conexión a la base de datos');
                        return;
                    }

                    const warehouse = document.getElementById('warehouse');
                    if (!warehouse) {
                        throw new Error('Warehouse no encontrado');
                    }
                    
                    const warehouseRect = warehouse.getBoundingClientRect();
                    const centroX = (warehouseRect.width / 2) - (CONFIG.PALLET_SIZE / 2);
                    const centroY = (warehouseRect.height / 2) - (CONFIG.PALLET_SIZE / 2);
                    
                    const posX = Math.max(10, centroX);
                    const posY = Math.max(10, centroY);

                    const palletTemporal = document.createElement('div');
                    palletTemporal.className = 'pallet temporal';
                    palletTemporal.dataset.pallet = 'temporal';
                    palletTemporal.title = 'Pallet temporal - Click para cargar material';
                    palletTemporal.textContent = '?';
                    palletTemporal.style.left = posX + 'px';
                    palletTemporal.style.top = posY + 'px';
                    palletTemporal.style.display = 'block';
                    
                    const self = this;
                    palletTemporal.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        self.abrirModalPalletTemporal(posX, posY);
                    });
                    
                    warehouse.appendChild(palletTemporal);
                    
                    this.logInfo('Pallet temporal creado - se asignará número al cargar material');
                    
                    const self2 = this;
                    setTimeout(function() {
                        self2.abrirModalPalletTemporal(posX, posY);
                    }, 100);
                    
                } catch (error) {
                    this.logError('Error creando pallet temporal', error);
                    this.mostrarErrorUsuario('Error al crear pallet temporal');
                }
            }

            abrirModalPalletTemporal(posX, posY) {
                try {
                    const modalTitle = document.getElementById('modal-title');
                    const modalBody = document.getElementById('modal-body');
                    const modal = document.getElementById('modal');
                    
                    modalTitle.textContent = 'Nuevo Pallet';
                    
                    modalBody.innerHTML = '<h3 style="text-align: center; margin-bottom: 15px; color: #2d3748;">Cargar Material en Nuevo Pallet</h3><div style="background: #f8f9fa; padding: 15px; border-radius: 6px;"><h4 style="margin-bottom: 12px; color: #2d3748; font-size: 14px;">Recibir Material</h4><form id="form-pallet-temporal"><div class="form-group"><label>Tipo de Material:</label><select id="tipo-material-temp" required><option value="">Seleccionar...</option><option value="Lamina">Lámina</option><option value="Strap">Strap</option><option value="Codo 90">Codo 90°</option><option value="Codo 45">Codo 45°</option><option value="Otro">Otro</option></select></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><div class="form-group"><label>Circunferencia:</label><input type="text" id="circunferencia-temp" placeholder="12" required></div><div class="form-group"><label>Espesor:</label><input type="text" id="espesor-temp" placeholder="1.5" required></div></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><div class="form-group"><label>Cantidad:</label><input type="number" id="cantidad-temp" placeholder="100" required></div><div class="form-group"><label>Unidad:</label><select id="unidad-temp" required><option value="pies lineales">Pies lineales</option><option value="piezas">Piezas</option></select></div></div><div class="form-group"><label>Proveedor:</label><input type="text" id="proveedor-temp" placeholder="Nombre del proveedor" required></div><button type="button" class="btn-primary" onclick="inventorySystem.procesarPalletTemporal(' + posX + ', ' + posY + ')">Confirmar y Asignar Número</button></form></div>';
                    
                    modal.classList.add('active');
                    this.logInfo('Modal de pallet temporal abierto');
                    
                } catch (error) {
                    this.logError('Error abriendo modal temporal', error);
                }
            }

            async procesarPalletTemporal(posX, posY) {
                try {
                    if (!this.supabase || !this.isOnline) {
                        this.mostrarErrorUsuario('Sin conexión a la base de datos');
                        return;
                    }

                    const tipo = document.getElementById('tipo-material-temp').value;
                    const circunf = document.getElementById('circunferencia-temp').value;
                    const espesor = document.getElementById('espesor-temp').value;
                    const cantidad = parseInt(document.getElementById('cantidad-temp').value);
                    const unidad = document.getElementById('unidad-temp').value;
                    const proveedor = document.getElementById('proveedor-temp').value || 'Sin especificar';
                    
                    if (!tipo || !cantidad || !unidad || !proveedor) {
                        this.mostrarErrorUsuario('Por favor completa todos los campos');
                        return;
                    }

                    const numeroAsignado = await this.obtenerProximoNumeroDisponible();
                    this.logInfo('Número asignado para nuevo pallet: P' + numeroAsignado);
                    
                    const { data: palletExistente, error: errorVerificacion } = await this.supabase
                        .from('pallets')
                        .select('numero')
                        .eq('numero', numeroAsignado)
                        .maybeSingle();
                    
                    if (errorVerificacion) throw errorVerificacion;
                    
                    if (palletExistente) {
                        this.logError('COLISIÓN DETECTADA: P' + numeroAsignado + ' ya existe', new Error('Colisión de ID'));
                        const nuevoNumero = await this.obtenerProximoNumeroDisponible();
                        this.logInfo('Recalculando número: P' + nuevoNumero);
                        return this.procesarPalletTemporal(posX, posY);
                    }
                    
                    let descripcion = tipo;
                    if (circunf && espesor) {
                        descripcion += ' - ' + circunf + '" x ' + espesor + '"';
                    }

                    const { data: palletData, error: palletError } = await this.supabase
                        .from('pallets')
                        .insert({
                            numero: numeroAsignado,
                            posicion_x: posX,
                            posicion_y: posY
                        })
                        .select()
                        .single();

                    if (palletError) throw palletError;

                    const { data: materialData, error: materialError } = await this.supabase
                        .from('materiales')
                        .insert({
                            pallet_id: palletData.id,
                            tipo: tipo,
                            circunferencia: circunf,
                            espesor: espesor,
                            cantidad: cantidad,
                            unidad: unidad,
                            proveedor: proveedor,
                            descripcion_completa: descripcion,
                            usuario_registro: this.usuarioActual
                        })
                        .select()
                        .single();

                    if (materialError) throw materialError;

                    const palletTemporal = document.querySelector('[data-pallet="temporal"]');
                    if (palletTemporal) {
                        palletTemporal.remove();
                    }

                    this.inventario[numeroAsignado] = {
                        materiales: [{
                            id: materialData.id,
                            tipo: tipo,
                            circunferencia: circunf,
                            espesor: espesor,
                            cantidad: cantidad,
                            unidad: unidad,
                            proveedor: proveedor,
                            descripcion: descripcion,
                            fecha: materialData.fecha_recepcion
                        }],
                        total: cantidad,
                        created: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        visible: true,
                        posicion: { x: posX, y: posY }
                    };

                    this.crearPalletDefinitivo(numeroAsignado, posX, posY);
                    
                    this.cerrarModal();
                    this.actualizarContadores();
                    
                    this.logInfo('Pallet P' + numeroAsignado + ' creado exitosamente con material: ' + descripcion);
                    
                } catch (error) {
                    this.logError('Error procesando pallet temporal', error);
                    this.mostrarErrorUsuario('Error al procesar el nuevo pallet: ' + error.message);
                }
            }

            crearPalletDefinitivo(numero, posX, posY) {
                const warehouse = document.getElementById('warehouse');
                if (!warehouse) return;

                const pallet = document.createElement('div');
                pallet.className = 'pallet occupied';
                pallet.dataset.pallet = numero;
                pallet.title = 'Pallet P' + numero + ' - Click para gestionar';
                pallet.textContent = numero;
                pallet.style.left = posX + 'px';
                pallet.style.top = posY + 'px';
                pallet.style.display = 'block';
                
                const self = this;
                pallet.addEventListener('click', function() {
                    self.logInfo('Click en pallet P' + numero);
                    self.abrirModal(numero);
                });
                
                pallet.addEventListener('mousedown', function(e) {
                    self.handleWarehouseMouseDown(e);
                });
                
                pallet.addEventListener('touchstart', function(e) {
                    self.handleWarehouseTouchStart(e);
                });
                
                warehouse.appendChild(pallet);
                
                this.logInfo('Pallet P' + numero + ' creado visualmente en posición (' + posX + ', ' + posY + ')');
            }

            abrirModal(palletId) {
                try {
                    this.palletActual = palletId;
                    
                    const modalTitle = document.getElementById('modal-title');
                    const modalBody = document.getElementById('modal-body');
                    const modal = document.getElementById('modal');
                    
                    if (!modalTitle || !modalBody || !modal) {
                        throw new Error('Elementos del modal no encontrados');
                    }
                    
                    modalTitle.textContent = 'Pallet P' + palletId;
                    
                    const datos = this.inventario[palletId];
                    if (!datos) {
                        throw new Error('Datos del pallet P' + palletId + ' no encontrados');
                    }
                    
                    modalBody.innerHTML = '<div style="display: flex; gap: 15px; margin-bottom: 20px;"><button onclick="inventorySystem.mostrarSeccion(\'inventario\', ' + palletId + ')" class="btn-primary" style="flex: 1;">Ver Inventario (' + datos.total + ')</button><button onclick="inventorySystem.mostrarSeccion(\'agregar\', ' + palletId + ')" class="btn-primary" style="flex: 1;">Agregar Material</button><button onclick="inventorySystem.mostrarSeccion(\'despachar\', ' + palletId + ')" class="btn-primary" style="flex: 1;">Despachar Material</button></div><div id="seccion-contenido">' + this.generarSeccionInventario(datos) + '</div>';
                    
                    modal.classList.add('active');
                    this.logInfo('Modal P' + palletId + ' abierto con múltiples funciones');
                    
                } catch (error) {
                    this.logError('Error abriendo modal', error);
                    this.mostrarErrorUsuario('No se pudo abrir el modal del pallet: ' + error.message);
                }
            }

            mostrarSeccion(seccion, palletId) {
                const contenido = document.getElementById('seccion-contenido');
                if (!contenido) return;

                const datos = this.inventario[palletId];
                
                if (seccion === 'inventario') {
                    contenido.innerHTML = this.generarSeccionInventario(datos);
                } else if (seccion === 'agregar') {
                    contenido.innerHTML = this.generarSeccionAgregar(palletId);
                } else if (seccion === 'despachar') {
                    contenido.innerHTML = this.generarSeccionDespachar(datos, palletId);
                }
            }

            generarSeccionInventario(datos) {
                const materialesHTML = datos.materiales.map(function(item, index) {
                    return '<div style="background: #f1f5f9; padding: 8px; margin: 6px 0; border-radius: 4px; border-left: 3px solid #38a169;"><div><strong style="color: #2d3748; font-size: 13px; display: block; margin-bottom: 4px;">' + (item.descripcion || item.tipo) + '</strong><div style="color: #666; font-size: 11px; margin: 2px 0;"><span style="background: #38a169; color: white; padding: 2px 4px; border-radius: 2px; font-weight: bold; font-size: 10px;">' + item.cantidad + ' ' + (item.unidad || 'unidades') + '</span><span style="margin-left: 8px; font-size: 10px;">Proveedor: ' + (item.proveedor || 'N/A') + '</span></div><small style="color: #999; font-size: 9px;">Recibido: ' + new Date(item.fecha).toLocaleString() + '</small></div></div>';
                }).join('');
                
                return '<h3 style="color: #2d3748; margin-bottom: 12px; font-size: 16px;">Inventario (' + datos.total + ' unidades)</h3><div style="max-height: 250px; overflow-y: auto;">' + materialesHTML + '</div>';
            }

            generarSeccionAgregar(palletId) {
                return '<h3 style="color: #2d3748; margin-bottom: 12px; font-size: 16px;">Agregar Material a P' + palletId + '</h3><div style="background: #f8f9fa; padding: 12px; border-radius: 6px;"><div class="form-group"><label>Tipo de Material:</label><select id="tipo-agregar" required><option value="">Seleccionar...</option><option value="Lamina">Lámina</option><option value="Strap">Strap</option><option value="Codo 90">Codo 90°</option><option value="Codo 45">Codo 45°</option><option value="Otro">Otro</option></select></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><div class="form-group"><label>Circunferencia:</label><input type="text" id="circunferencia-agregar" placeholder="12"></div><div class="form-group"><label>Espesor:</label><input type="text" id="espesor-agregar" placeholder="1.5"></div></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><div class="form-group"><label>Cantidad:</label><input type="number" id="cantidad-agregar" placeholder="100" required min="1"></div><div class="form-group"><label>Unidad:</label><select id="unidad-agregar" required><option value="pies lineales">Pies lineales</option><option value="piezas">Piezas</option></select></div></div><div class="form-group"><label>Proveedor:</label><input type="text" id="proveedor-agregar" placeholder="Nombre del proveedor" required></div><button type="button" onclick="inventorySystem.procesarAgregarMaterial(' + palletId + ')" class="btn-primary">Agregar Material</button></div>';
            }

            generarSeccionDespachar(datos, palletId) {
                const materialesHTML = datos.materiales.map(function(item, index) {
                    return '<div style="background: white; padding: 10px; margin: 8px 0; border-radius: 4px; border: 1px solid #e2e8f0;"><div style="margin-bottom: 8px;"><strong style="color: #2d3748; font-size: 13px;">' + (item.descripcion || item.tipo) + '</strong><br><small style="color: #666; font-size: 10px;">Stock: ' + item.cantidad + ' ' + (item.unidad || 'unidades') + ' | ' + (item.proveedor || 'N/A') + '</small></div><div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;"><label style="min-width: 80px; font-size: 11px;">Despachar:</label><input type="number" id="despachar-' + item.id + '" min="0" max="' + item.cantidad + '" placeholder="0" style="padding: 4px; border: 1px solid #cbd5e0; border-radius: 3px; width: 80px; font-size: 11px;"><span style="color: #666; font-size: 10px;">de ' + item.cantidad + '</span></div></div>';
                }).join('');
                
                return '<h3 style="color: #2d3748; margin-bottom: 12px; font-size: 16px;">Despachar de P' + palletId + '</h3><div style="background: #f8f9fa; padding: 12px; border-radius: 6px;"><h4 style="margin-bottom: 10px; font-size: 13px;">Materiales para despachar:</h4><div style="max-height: 200px; overflow-y: auto;">' + materialesHTML + '</div><div style="margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap;"><button onclick="inventorySystem.procesarDespachoMaterial(' + palletId + ')" class="btn-primary" style="flex: 1; min-width: 120px;">Despacho Parcial</button><button onclick="inventorySystem.despacharTodoPallet(' + palletId + ')" class="btn-danger" style="flex: 1; min-width: 120px;">Despachar Todo</button></div></div>';
            }

            async procesarAgregarMaterial(palletId) {
                try {
                    if (!this.supabase || !this.isOnline) {
                        this.mostrarErrorUsuario('Sin conexión a la base de datos');
                        return;
                    }

                    const tipo = document.getElementById('tipo-agregar').value;
                    const circunf = document.getElementById('circunferencia-agregar').value;
                    const espesor = document.getElementById('espesor-agregar').value;
                    const cantidad = parseInt(document.getElementById('cantidad-agregar').value);
                    const unidad = document.getElementById('unidad-agregar').value;
                    const proveedor = document.getElementById('proveedor-agregar').value || 'Sin especificar';
                    
                    if (!tipo || !cantidad || !unidad || !proveedor) {
                        this.mostrarErrorUsuario('Por favor completa todos los campos obligatorios');
                        return;
                    }

                    const { data: palletData, error: errorPallet } = await this.supabase
                        .from('pallets')
                        .select('id')
                        .eq('numero', palletId)
                        .single();

                    if (errorPallet) throw errorPallet;

                    let descripcion = tipo;
                    if (circunf && espesor) {
                        descripcion += ' - ' + circunf + '" x ' + espesor + '"';
                    }

                    const { data: materialData, error: materialError } = await this.supabase
                        .from('materiales')
                        .insert({
                            pallet_id: palletData.id,
                            tipo: tipo,
                            circunferencia: circunf,
                            espesor: espesor,
                            cantidad: cantidad,
                            unidad: unidad,
                            proveedor: proveedor,
                            descripcion_completa: descripcion,
                            usuario_registro: this.usuarioActual
                        })
                        .select()
                        .single();

                    if (materialError) throw materialError;

                    if (!this.inventario[palletId]) {
                        this.inventario[palletId] = {
                            materiales: [],
                            total: 0,
                            created: new Date().toISOString(),
                            lastUpdated: new Date().toISOString(),
                            visible: true,
                            posicion: { x: 50, y: 50 }
                        };
                    }

                    this.inventario[palletId].materiales.push({
                        id: materialData.id,
                        tipo: tipo,
                        circunferencia: circunf,
                        espesor: espesor,
                        cantidad: cantidad,
                        unidad: unidad,
                        proveedor: proveedor,
                        descripcion: descripcion,
                        fecha: materialData.fecha_recepcion
                    });

                    this.inventario[palletId].total = this.inventario[palletId].materiales.reduce(function(sum, m) {
                        return sum + m.cantidad;
                    }, 0);
                    
                    this.inventario[palletId].lastUpdated = new Date().toISOString();
                    
                    this.mostrarSeccion('inventario', palletId);
                    this.actualizarContadores();
                    
                    this.logInfo('Material agregado a P' + palletId + ': ' + descripcion + ' (' + cantidad + ' ' + unidad + ')');
                    
                } catch (error) {
                    this.logError('Error agregando material', error);
                    this.mostrarErrorUsuario('Error al agregar material: ' + error.message);
                }
            }

            async procesarDespachoMaterial(palletId) {
                try {
                    if (!this.supabase || !this.isOnline) {
                        this.mostrarErrorUsuario('Sin conexión a la base de datos');
                        return;
                    }

                    const datos = this.inventario[palletId];
                    if (!datos) return;

                    let despachoRealizado = false;
                    
                    for (let i = 0; i < datos.materiales.length; i++) {
                        const material = datos.materiales[i];
                        const input = document.getElementById('despachar-' + material.id);
                        if (!input) continue;
                        
                        const cantidadDespacho = parseInt(input.value) || 0;
                        if (cantidadDespacho <= 0) continue;
                        
                        if (cantidadDespacho > material.cantidad) {
                            this.mostrarErrorUsuario('No puedes despachar ' + cantidadDespacho + ' de ' + material.descripcion + '. Solo hay ' + material.cantidad + ' disponibles.');
                            return;
                        }
                        
                        const nuevaCantidad = material.cantidad - cantidadDespacho;
                        
                        if (nuevaCantidad === 0) {
                            await this.supabase
                                .from('materiales')
                                .update({ activo: false })
                                .eq('id', material.id);
                        } else {
                            await this.supabase
                                .from('materiales')
                                .update({ cantidad: nuevaCantidad })
                                .eq('id', material.id);
                        }
                        
                        await this.supabase
                            .from('movimientos')
                            .insert({
                                material_id: material.id,
                                tipo_movimiento: 'salida',
                                cantidad: cantidadDespacho,
                                usuario: this.usuarioActual,
                                observaciones: 'Despacho parcial de P' + palletId
                            });
                        
                        material.cantidad = nuevaCantidad;
                        despachoRealizado = true;
                        
                        this.logInfo('Despacho parcial: P' + palletId + ' - ' + material.descripcion + ' - ' + cantidadDespacho + ' ' + material.unidad);
                    }
                    
                    if (despachoRealizado) {
                        datos.materiales = datos.materiales.filter(function(m) {
                            return m.cantidad > 0;
                        });
                        
                        datos.total = datos.materiales.reduce(function(sum, m) {
                            return sum + m.cantidad;
                        }, 0);
                        
                        datos.lastUpdated = new Date().toISOString();
                        
                        if (datos.total === 0) {
                            const pallet = document.querySelector('[data-pallet="' + palletId + '"]');
                            if (pallet) pallet.remove();
                            delete this.inventario[palletId];
                            this.cerrarModal();
                        } else {
                            this.mostrarSeccion('inventario', palletId);
                        }
                        
                        this.actualizarContadores();
                        this.logInfo('Despacho completado para P' + palletId);
                    }
                    
                } catch (error) {
                    this.logError('Error procesando despacho', error);
                    this.mostrarErrorUsuario('Error al procesar el despacho: ' + error.message);
                }
            }

            async despacharTodoPallet(palletId) {
                try {
                    if (!confirm('¿Estás seguro de despachar TODO el pallet P' + palletId + '?')) return;
                    
                    if (!this.supabase || !this.isOnline) {
                        this.mostrarErrorUsuario('Sin conexión a la base de datos');
                        return;
                    }

                    const datos = this.inventario[palletId];
                    if (!datos) return;

                    for (let i = 0; i < datos.materiales.length; i++) {
                        const material = datos.materiales[i];
                        
                        await this.supabase
                            .from('materiales')
                            .update({ activo: false })
                            .eq('id', material.id);
                        
                        await this.supabase
                            .from('movimientos')
                            .insert({
                                material_id: material.id,
                                tipo_movimiento: 'salida',
                                cantidad: material.cantidad,
                                usuario: this.usuarioActual,
                                observaciones: 'Despacho completo del pallet P' + palletId
                            });
                    }
                    
                    const pallet = document.querySelector('[data-pallet="' + palletId + '"]');
                    if (pallet) pallet.remove();
                    
                    delete this.inventario[palletId];
                    
                    this.cerrarModal();
                    this.actualizarContadores();
                    
                    this.logInfo('Pallet P' + palletId + ' despachado completamente');
                    
                } catch (error) {
                    this.logError('Error despachando pallet completo', error);
                    this.mostrarErrorUsuario('Error al despachar el pallet: ' + error.message);
                }
            }

            async buscarMateriales() {
                try {
                    const tipo = document.getElementById('search-tipo').value || '';
                    const circunf = document.getElementById('search-circunf').value || '';
                    const espesor = document.getElementById('search-espesor').value || '';
                    const angulo = document.getElementById('search-angulo').value || '';

                    if (!tipo && !circunf && !espesor && !angulo) {
                        this.mostrarErrorUsuario('Ingresa al menos un criterio de búsqueda');
                        return;
                    }

                    if (!this.supabase || !this.isOnline) {
                        this.buscarMaterialesLocal(tipo, circunf, espesor, angulo);
                        return;
                    }

                    let query = this.supabase
                        .from('materiales')
                        .select('*, pallets!inner (numero)')
                        .eq('activo', true);

                    if (tipo) {
                        if (angulo && (tipo === '90' || tipo === '45')) {
                            query = query.ilike('tipo', '%codo%' + tipo + '%');
                        } else {
                            query = query.ilike('tipo', '%' + tipo + '%');
                        }
                    }
                    
                    if (circunf) {
                        query = query.ilike('circunferencia', '%' + circunf + '%');
                    }
                    
                    if (espesor) {
                        query = query.ilike('espesor', '%' + espesor + '%');
                    }

                    const { data: materiales, error } = await query;

                    if (error) throw error;

                    this.mostrarResultadosBusqueda(materiales || []);
                    
                } catch (error) {
                    this.logError('Error en búsqueda', error);
                    this.mostrarErrorUsuario('Error realizando búsqueda: ' + error.message);
                }
            }

            buscarMaterialesLocal(tipo, circunf, espesor, angulo) {
                const resultados = [];
                const self = this;
                
                Object.keys(this.inventario).forEach(function(palletId) {
                    const datos = self.inventario[palletId];
                    
                    datos.materiales.forEach(function(material) {
                        let coincide = true;
                        
                        if (tipo && material.tipo.toLowerCase().indexOf(tipo.toLowerCase()) === -1) {
                            if (angulo && material.tipo.toLowerCase().indexOf(angulo) === -1) {
                                coincide = false;
                            } else if (!angulo) {
                                coincide = false;
                            }
                        }
                        
                        if (circunf && material.circunferencia && material.circunferencia.toString().indexOf(circunf) === -1) {
                            coincide = false;
                        }
                        
                        if (espesor && material.espesor && material.espesor.toString().indexOf(espesor) === -1) {
                            coincide = false;
                        }
                        
                        if (coincide) {
                            resultados.push({
                                id: material.id,
                                tipo: material.tipo,
                                descripcion_completa: material.descripcion,
                                cantidad: material.cantidad,
                                unidad: material.unidad,
                                pallets: { numero: palletId }
                            });
                        }
                    });
                });
                
                this.mostrarResultadosBusqueda(resultados);
            }

            mostrarResultadosBusqueda(materiales) {
                const resultadosContainer = document.getElementById('resultados-busqueda');
                const contenidoResultados = document.getElementById('contenido-resultados');
                
                if (!resultadosContainer || !contenidoResultados) return;
                
                if (materiales.length === 0) {
                    resultadosContainer.style.display = 'none';
                    this.mostrarErrorUsuario('No se encontraron materiales que coincidan con los criterios');
                    return;
                }
                
                const self = this;
                const materialesHTML = materiales.map(function(material) {
                    return '<div style="background: rgba(255,255,255,0.1); padding: 8px; margin: 4px 0; border-radius: 4px; border-left: 3px solid #38a169;"><div style="display: flex; justify-content: space-between; align-items: center;"><div><strong style="color: white; font-size: 12px;">' + (material.descripcion_completa || material.tipo) + '</strong><br><small style="color: #a0aec0;">' + material.cantidad + ' ' + (material.unidad || 'unidades') + ' en <strong>Pallet P' + material.pallets.numero + '</strong></small></div><button onclick="inventorySystem.irAPallet(' + material.pallets.numero + ')" style="padding: 4px 8px; background: #38a169; color: white; border: none; border-radius: 3px; font-size: 10px; cursor: pointer;">Ver</button></div></div>';
                }).join('');
                
                contenidoResultados.innerHTML = materialesHTML;
                resultadosContainer.style.display = 'block';
                this.logInfo('Búsqueda completada: ' + materiales.length + ' materiales encontrados');
            }

            limpiarBusqueda() {
                document.getElementById('search-tipo').value = '';
                document.getElementById('search-circunf').value = '';
                document.getElementById('search-espesor').value = '';
                document.getElementById('search-angulo').value = '';
                
                const resultados = document.getElementById('resultados-busqueda');
                if (resultados) {
                    resultados.style.display = 'none';
                }
                
                this.logInfo('Búsqueda limpiada');
            }

            irAPallet(palletId) {
                this.abrirModal(palletId);
                const resultados = document.getElementById('resultados-busqueda');
                if (resultados) {
                    resultados.style.display = 'none';
                }
            }

            cerrarModal() {
                const modal = document.getElementById('modal');
                if (modal) {
                    modal.classList.remove('active');
                }
                this.palletActual = null;
            }

            actualizarEstadoConexion(estado) {
                const statusElement = document.getElementById('connection-status');
                if (statusElement) {
                    statusElement.className = 'connection-status ' + estado;
                    
                    if (estado === 'connected') {
                        statusElement.textContent = 'Conectado';
                    } else if (estado === 'connecting') {
                        statusElement.textContent = 'Conectando...';
                    } else if (estado === 'disconnected') {
                        statusElement.textContent = 'Sin conexión';
                    }
                }
            }

            actualizarContadores() {
                try {
                    const totalPallets = Object.keys(this.inventario).length;
                    const palletsOcupados = Object.keys(this.inventario).filter(function(id) {
                        return this.inventario[id] && this.inventario[id].total > 0;
                    }, this).length;

                    const contadorPallets = document.getElementById('contador-pallets');
                    const contadorOcupados = document.getElementById('contador-ocupados');
                    
                    if (contadorPallets) contadorPallets.textContent = totalPallets;
                    if (contadorOcupados) contadorOcupados.textContent = palletsOcupados;
                    
                } catch (error) {
                    this.logError('Error actualizando contadores', error);
                }
            }

            mostrarErrorUsuario(mensaje) {
                alert('Error del Sistema: ' + mensaje);
                this.logError('Error mostrado al usuario', new Error(mensaje));
            }
        }

        function cambiarUsuario() {
            const selector = document.getElementById('usuario-selector');
            if (selector && window.inventorySystem) {
                window.inventorySystem.usuarioActual = selector.value;
                window.inventorySystem.logInfo('Usuario cambiado a: ' + selector.value);
            }
        }

        function buscarMateriales() {
            if (window.inventorySystem) {
                window.inventorySystem.buscarMateriales();
            }
        }

        function limpiarBusqueda() {
            if (window.inventorySystem) {
                window.inventorySystem.limpiarBusqueda();
            }
        }

        function cerrarModal() {
            if (window.inventorySystem) {
                window.inventorySystem.cerrarModal();
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', async function() {
                console.log('=== DOM CARGADO - INICIALIZANDO SISTEMA ===');
                try {
                    window.inventorySystem = new InventorySystem();
                    window.inventorySystem.startTime = Date.now();
                    await window.inventorySystem.init();
                    console.log('=== SISTEMA COMPLETAMENTE INICIALIZADO ===');
                } catch (error) {
                    console.error('ERROR CRÍTICO EN INICIALIZACIÓN:', error);
                }
            });
        } else {
            console.log('=== DOM YA LISTO - INICIALIZACIÓN INMEDIATA ===');
            setTimeout(async function() {
                try {
                    window.inventorySystem = new InventorySystem();
                    window.inventorySystem.startTime = Date.now();
                    await window.inventorySystem.init();
                    console.log('=== SISTEMA COMPLETAMENTE INICIALIZADO ===');
                } catch (error) {
                    console.error('ERROR CRÍTICO EN INICIALIZACIÓN:', error);
                }
            }, 500);
        }
    </script>
</body>
</html>
